{% extends "base.html" %}

{% block title %}Historical Data - ReViision{% endblock %}

{% block styles %}
<style>
/* Historical data specific styles using design system */
.date-range-picker {
    background: var(--color-surface-primary);
    border: 1px solid var(--color-border-primary);
    border-radius: var(--radius-xl);
    padding: var(--spacing-6);
}

.chart-container {
    position: relative;
    height: 400px;
    width: 100%;
}

.data-export-section {
    background: var(--color-surface-secondary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-4);
    border: 1px solid var(--color-border-primary);
}

.metric-card {
    background: var(--color-surface-primary);
    border: 1px solid var(--color-border-primary);
    border-radius: var(--radius-xl);
    padding: var(--spacing-6);
    text-align: center;
    transition: var(--transition-all);
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.metric-value {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary-600);
    margin-bottom: var(--spacing-2);
}

.metric-label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.trend-indicator {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-1);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    margin-top: var(--spacing-2);
}

.trend-up { color: var(--color-success-600); }
.trend-down { color: var(--color-danger-600); }
.trend-neutral { color: var(--color-text-muted); }

@media (max-width: 767px) {
    .chart-container {
        height: 300px;
    }

    .metric-value {
        font-size: var(--font-size-2xl);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container py-6">
    <!-- Page Header -->
    <div class="mb-8 d-flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold text-primary mb-2">Historical Data Analysis</h1>
            <p class="text-secondary">Comprehensive historical insights and trend analysis</p>
        </div>
        <div class="d-flex gap-3">
            <button class="btn btn-outline-primary" id="generate-historical-report" title="Generate comprehensive PDF report">
                <i class="fas fa-file-pdf mr-2"></i>
                Generate Report
            </button>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="card mb-6">
        <div class="card-body p-4">
            <nav class="nav nav-pills d-flex flex-wrap gap-2" id="historical-nav">
                <a class="nav-link active" href="#overview" data-section="overview">
                    <i class="fas fa-chart-area mr-2"></i>
                    Overview
                </a>
                <a class="nav-link" href="#traffic" data-section="traffic">
                    <i class="fas fa-walking mr-2"></i>
                    Traffic Patterns
                </a>
                <a class="nav-link" href="#demographics" data-section="demographics">
                    <i class="fas fa-users mr-2"></i>
                    Demographics
                </a>
                <a class="nav-link" href="#dwell-time" data-section="dwell">
                    <i class="fas fa-clock mr-2"></i>
                    Dwell Time
                </a>

            </nav>
        </div>
    </div>

    <!-- Date Range and Filters -->
    <div class="date-range-picker mb-6">
        <h3 class="text-lg font-semibold mb-4">
            <i class="fas fa-calendar-alt text-primary mr-2"></i>
            Date Range & Filters
        </h3>
        <div class="d-grid grid-cols-1 tablet-grid-cols-2 desktop-grid-cols-4 gap-4">
            <div class="form-group">
                <label for="date-range" class="form-label">Time Range</label>
                <select class="form-control" id="date-range">
                    <option value="1h">Last Hour</option>
                    <option value="6h">Last 6 Hours</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d" selected>Last 30 Days</option>
                </select>
            </div>
            <div class="form-group">
                <label for="day-of-week" class="form-label">Day of Week</label>
                <select class="form-control" id="day-of-week">
                    <option value="all" selected>All Days</option>
                    <option value="monday">Monday</option>
                    <option value="tuesday">Tuesday</option>
                    <option value="wednesday">Wednesday</option>
                    <option value="thursday">Thursday</option>
                    <option value="friday">Friday</option>
                    <option value="saturday">Saturday</option>
                    <option value="sunday">Sunday</option>
                    <option value="weekdays">Weekdays (Mon-Fri)</option>
                    <option value="weekends">Weekends (Sat-Sun)</option>
                </select>
            </div>
            <div class="form-group d-flex items-end">
                <button class="btn btn-primary w-full" id="refresh-data">
                    <i class="fas fa-sync-alt"></i>
                    Refresh Data
                </button>
            </div>
            <div class="form-group d-flex items-end">
                <button class="btn btn-outline-primary w-full" id="apply-date-filter">
                    <i class="fas fa-search"></i>
                    Apply Filter
                </button>
            </div>
        </div>
    </div>
    <!-- Content Sections -->
    <div id="content-sections">
        <!-- Overview Section -->
        <div id="overview-section" class="content-section">
            <!-- Key Metrics -->
            <div class="d-grid grid-cols-2 desktop-grid-cols-4 gap-4 mb-8">
                <div class="metric-card">
                    <div class="metric-value" id="total-visitors">--</div>
                    <div class="metric-label">Total Visitors</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="peak-day">--</div>
                    <div class="metric-label">Peak Day</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="peak-hour">--</div>
                    <div class="metric-label">Peak Hour</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="conversion-rate">--</div>
                    <div class="metric-label">Conversion Rate</div>
                </div>
            </div>

            <!-- Overview Charts -->
            <div class="d-grid grid-cols-1 desktop-grid-cols-2 gap-6 mb-6">
                <div class="card">
                    <div class="card-header card-header-primary">
                        <h3 class="card-title">
                            <i class="fas fa-chart-area"></i>
                            Traffic Overview
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="overview-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header card-header-primary">
                        <h3 class="card-title" style="color: white;">
                            <i class="fas fa-clock" style="color: white;"></i>
                            Hourly Distribution
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="hourly-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Traffic Patterns Section -->
        <div id="traffic-section" class="content-section d-none">
            <div class="card mb-6">
                <div class="card-header card-header-primary">
                    <h3 class="card-title">
                        <i class="fas fa-users"></i>
                        Visitor Traffic Analysis
                    </h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="traffic-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="d-grid grid-cols-1 desktop-grid-cols-2 gap-6">
                <div class="card">
                    <div class="card-header card-header-warning">
                        <h3 class="card-title" style="color: white !important;">
                            <i class="fas fa-calendar-week" style="color: white !important;"></i>
                            <span style="color: white !important;">Weekly Patterns</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="weekly-patterns-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header card-header-danger">
                        <h3 class="card-title" style="color: white !important;">
                            <i class="fas fa-chart-bar" style="color: white !important;"></i>
                            <span style="color: white !important;">Peak Hours Analysis</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="peak-hours-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Demographics Section -->
        <div id="demographics-section" class="content-section d-none">
            <div class="d-grid grid-cols-1 desktop-grid-cols-2 gap-6 mb-6">
                <div class="card">
                    <div class="card-header card-header-primary">
                        <h3 class="card-title">
                            <i class="fas fa-birthday-cake"></i>
                            Age Distribution Trends
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="age-trends-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header card-header-success">
                        <h3 class="card-title" style="color: white !important;">
                            <i class="fas fa-venus-mars" style="color: white !important;"></i>
                            <span style="color: white !important;">Gender Distribution Trends</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="gender-trends-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dwell Time Section -->
        <div id="dwell-section" class="content-section d-none">
            <div class="card mb-6">
                <div class="card-header card-header-warning">
                    <h3 class="card-title" style="color: white !important;">
                        <i class="fas fa-clock" style="color: white !important;"></i>
                        <span style="color: white !important;">Dwell Time Analysis</span>
                    </h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="dwell-time-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>


    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Historical Data Navigation
document.addEventListener('DOMContentLoaded', function() {
    // Navigation handling
    const navLinks = document.querySelectorAll('#historical-nav .nav-link');
    const sections = document.querySelectorAll('.content-section');

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            // Update active nav link
            navLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            // Show corresponding section
            const targetSection = this.getAttribute('data-section');
            sections.forEach(section => {
                section.classList.add('d-none');
            });

            const activeSection = document.getElementById(targetSection + '-section');
            if (activeSection) {
                activeSection.classList.remove('d-none');
            }
        });
    });

    // Date filter handling
    document.getElementById('apply-date-filter').addEventListener('click', function() {
        // Add loading state
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        this.disabled = true;

        // Simulate data loading
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-search"></i> Apply Filter';
            this.disabled = false;

            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show mt-4';
            alert.innerHTML = `
                <i class="fas fa-check-circle"></i>
                Data updated successfully for the selected date range.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.date-range-picker').appendChild(alert);

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        }, 1500);
    });
});
</script>
<!-- Chart.js is loaded globally via base.html -->
<script>
// Historical Data Page JavaScript
class HistoricalDataManager {
    constructor() {
        this.charts = {};
        this.currentData = null;
        this.init();
    }
    
    init() {
        this.setupEventHandlers();
        this.loadData();
    }
    
    setupEventHandlers() {
        // Date range change
        document.getElementById('date-range').addEventListener('change', () => {
            this.loadData();
        });

        // Day of week filter change
        document.getElementById('day-of-week').addEventListener('change', () => {
            this.loadData();
        });

        // Refresh button
        document.getElementById('refresh-data').addEventListener('click', () => {
            this.loadData(true);
        });

        // Apply filter button (for compatibility)
        document.getElementById('apply-date-filter').addEventListener('click', () => {
            this.loadData(true);
        });

        // Tab changes
        document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', (e) => {
                this.handleTabChange(e.target);
            });
        });

        // Report generation
        document.getElementById('generate-historical-report').addEventListener('click', () => {
            this.generateReport();
        });
    }
    
    handleTabChange(tab) {
        // Resize charts when tab becomes visible
        setTimeout(() => {
            Object.values(this.charts).forEach(chart => {
                if (chart && typeof chart.resize === 'function') {
                    chart.resize();
                }
            });
        }, 100);
    }
    
    async loadData(showLoading = false) {
        try {
            if (showLoading) {
                this.showLoading();
            }
            
            const hours = this.getHoursFromRange();
            const dayOfWeek = this.getDayOfWeekFilter();
            const url = `/api/analytics/historical?hours=${hours}${dayOfWeek ? `&day_of_week=${dayOfWeek}` : ''}`;
            const response = await fetch(url, {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Invalid response format - expected JSON');
            }
            
            const data = await response.json();
            
            if (data.success) {
                this.currentData = data;
                this.updateUI(data);
                this.showSuccessMessage('Data loaded successfully');
            } else {
                throw new Error(data.message || 'Failed to load data');
            }
        } catch (error) {
            console.error('Error loading data:', error);
            this.showError(error.message);
            this.showNoDataState();
        } finally {
            if (showLoading) {
                this.hideLoading();
            }
        }
    }
    
    updateUI(data) {
        this.updateStatistics(data);
        this.updateCharts(data);
    }
    
    updateStatistics(data) {
        document.getElementById('total-visitors').textContent = (data.total_visitors || 0).toLocaleString();
        document.getElementById('peak-day').textContent = data.peak_day || '--';
        document.getElementById('peak-hour').textContent = data.peak_hour || '--:--';
        document.getElementById('conversion-rate').textContent = data.conversion_rate ? `${data.conversion_rate}%` : '--';
    }

    updateCharts(data) {
        this.createOverviewChart(data);
        this.createHourlyChart(data);
        this.createTrafficChart(data);
        this.createWeeklyPatternsChart(data);
        this.createPeakHourAnalysisChart(data);
        this.createHistoricalDemographicsCharts(data);
        this.createDwellTimeChart(data);
    }
    
    createOverviewChart(data) {
        const ctx = document.getElementById('overview-chart');
        if (!ctx) return;
        
        if (this.charts.overview) {
            this.charts.overview.destroy();
        }
        
        const traffic = data.traffic || {};
        const labels = traffic.labels || [];
        const values = traffic.data || [];
        
        const overviewConfig = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: values,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };
        this.charts.overview = new ChartManager(ctx, overviewConfig, { filename: 'overview_traffic' });
    }

    createHourlyChart(data) {
        const ctx = document.getElementById('hourly-chart');
        if (!ctx) return;

        if (this.charts.hourly) {
            this.charts.hourly.destroy();
        }

        const traffic = data.traffic || {};
        const labels = traffic.labels || [];
        const values = traffic.data || [];

        // Find peak hour for highlighting
        const maxValue = Math.max(...values);
        const peakIndex = values.indexOf(maxValue);

        // Create background colors array with peak hour highlighted
        const backgroundColors = values.map((value, index) =>
            index === peakIndex ? '#e74c3c' : '#3498db'
        );

        const hourlyConfig = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: values,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors.map(color => color === '#e74c3c' ? '#c0392b' : '#2980b9'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                if (context.dataIndex === peakIndex) {
                                    return 'Peak Hour';
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Hour of Day'
                        }
                    }
                }
            }
        };
        this.charts.hourly = new ChartManager(ctx, hourlyConfig, { filename: 'hourly_distribution' });
    }
    
    createTrafficChart(data) {
        const ctx = document.getElementById('traffic-chart');
        if (!ctx) return;
        
        if (this.charts.traffic) {
            this.charts.traffic.destroy();
        }
        
        const traffic = data.traffic || {};
        const labels = traffic.labels || [];
        const values = traffic.data || [];
        
        const trafficConfig = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: values,
                    backgroundColor: '#3498db',
                    borderColor: '#2980b9',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };
        this.charts.traffic = new ChartManager(ctx, trafficConfig, { filename: 'traffic_by_hour' });
    }
    
    createWeeklyPatternsChart(data) {
        const ctx = document.getElementById('weekly-patterns-chart');
        if (!ctx) return;

        if (this.charts.weeklyPatterns) {
            this.charts.weeklyPatterns.destroy();
        }

        // Use new weekly patterns data if available
        const weeklyData = data.weekly_patterns || {};
        const labels = weeklyData.labels || ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const values = weeklyData.data || new Array(7).fill(0);

        const weeklyConfig = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Daily Visitors',
                    data: values,
                    backgroundColor: '#f39c12',
                    borderColor: '#e67e22',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Day of Week'
                        }
                    }
                }
            }
        };
        this.charts.weeklyPatterns = new ChartManager(ctx, weeklyConfig, { filename: 'weekly_patterns' });
    }

    createPeakHourAnalysisChart(data) {
        const ctx = document.getElementById('peak-hours-chart');
        if (!ctx) return;

        if (this.charts.peakHours) {
            this.charts.peakHours.destroy();
        }

        // Use peak hour analysis data if available
        const peakHourData = data.peak_hour_analysis || {};
        const labels = peakHourData.labels || ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const averages = peakHourData.data || new Array(7).fill(0);
        const peakHours = peakHourData.peak_hours_by_day || {};

        const peakHourConfig = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Peak Hour Visitors',
                    data: averages,
                    backgroundColor: '#e74c3c',
                    borderColor: '#c0392b',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const day = labels[context.dataIndex];
                                const peakHour = peakHours[day] || '--:--';
                                return `Peak Hour: ${peakHour}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Average Visitors at Peak Hour'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Day of Week'
                        }
                    }
                }
            }
        };
        this.charts.peakHours = new ChartManager(ctx, peakHourConfig, { filename: 'peak_hour_analysis' });
    }

    createHistoricalDemographicsCharts(data) {
        this.createHistoricalGenderChart(data);
        this.createHistoricalAgeChart(data);
    }

    createHistoricalGenderChart(data) {
        const ctx = document.getElementById('gender-trends-chart');
        if (!ctx) return;

        if (this.charts.genderTrends) {
            this.charts.genderTrends.destroy();
        }

        // Use historical demographics data if available
        const demographicsData = data.historical_demographics || {};
        const genderData = demographicsData.gender_distribution || data.gender_distribution || {};

        const labels = [];
        const values = [];
        const colors = ['#3498db', '#e74c3c', '#f39c12', '#2ecc71'];

        Object.entries(genderData).forEach(([key, value]) => {
            if (typeof value === 'object' && value.display_name) {
                labels.push(value.display_name);
                values.push(value.count);
            } else {
                labels.push(key.charAt(0).toUpperCase() + key.slice(1));
                values.push(value);
            }
        });

        const genderConfig = {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        };
        this.charts.genderTrends = new ChartManager(ctx, genderConfig, { filename: 'gender_distribution_historical' });
    }

    createHistoricalAgeChart(data) {
        const ctx = document.getElementById('age-trends-chart');
        if (!ctx) return;

        if (this.charts.ageTrends) {
            this.charts.ageTrends.destroy();
        }

        // Use historical demographics data if available
        const demographicsData = data.historical_demographics || {};
        const ageData = demographicsData.age_groups || data.age_groups || {};

        const labels = [];
        const values = [];

        Object.entries(ageData).forEach(([key, value]) => {
            if (typeof value === 'object' && value.display_name) {
                labels.push(value.display_name);
                values.push(value.count);
            } else {
                labels.push(key.replace('_', '-'));
                values.push(value);
            }
        });

        const ageConfig = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: values,
                    backgroundColor: '#2ecc71',
                    borderColor: '#27ae60',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Age Group'
                        }
                    }
                }
            }
        };
        this.charts.ageTrends = new ChartManager(ctx, ageConfig, { filename: 'age_distribution_historical' });
    }

    createDwellTimeChart(data) {
        const ctx = document.getElementById('dwell-time-chart');
        if (!ctx) return;

        if (this.charts.dwellTime) {
            this.charts.dwellTime.destroy();
        }

        // Use dwell time statistics data if available
        const dwellTimeData = data.dwell_time_stats || {};
        const distribution = dwellTimeData.distribution || data.dwell_time_distribution || {};
        const hourlyTrends = dwellTimeData.hourly_trends || {};

        // Create distribution chart if we have distribution data
        if (distribution.labels && distribution.data) {
            const dwellConfig = {
                type: 'bar',
                data: {
                    labels: distribution.labels,
                    datasets: [{
                        label: 'Number of Sessions',
                        data: distribution.data,
                        backgroundColor: '#f39c12',
                        borderColor: '#e67e22',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Dwell Time Distribution'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Sessions'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Dwell Time Range'
                            }
                        }
                    }
                }
            };
            this.charts.dwellTime = new ChartManager(ctx, dwellConfig, { filename: 'dwell_time_distribution' });
        } else if (Object.keys(hourlyTrends).length > 0) {
            // Create hourly trends chart if we have hourly data
            const hours = Object.keys(hourlyTrends).sort();
            const values = hours.map(hour => hourlyTrends[hour]);

            const dwellConfig = {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Average Dwell Time (minutes)',
                        data: values,
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Dwell Time Trends by Hour'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Dwell Time (minutes)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            }
                        }
                    }
                }
            };
            this.charts.dwellTime = new ChartManager(ctx, dwellConfig, { filename: 'dwell_time_trends' });
        }
    }
    
    getHoursFromRange() {
        const range = document.getElementById('date-range').value;
        const map = {
            '1h': 1,
            '6h': 6,
            '24h': 24,
            '7d': 168,
            '30d': 720
        };
        return map[range] || 24;
    }

    getDayOfWeekFilter() {
        const dayOfWeek = document.getElementById('day-of-week').value;
        return dayOfWeek === 'all' ? null : dayOfWeek;
    }
    
    formatDwellTime(seconds) {
        if (!seconds) return '0s';
        
        if (seconds < 60) {
            return `${Math.round(seconds)}s`;
        } else {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    }
    
    showLoading() {
        const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
        modal.show();
    }
    
    hideLoading() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
        if (modal) {
            modal.hide();
        }
    }
    
    showError(message) {
        this.showNotificationPopup('error', `Error: ${message}`);
    }
    
    showSuccessMessage(message) {
        showNotification(message, 'success');
    }
    
    showNoDataState() {
        document.getElementById('total-visitors').textContent = '0';
        document.getElementById('peak-day').textContent = '--';
        document.getElementById('peak-hour').textContent = '--:--';
        document.getElementById('conversion-rate').textContent = '0%';
        
        // Clear charts
        Object.values(this.charts).forEach(chart => {
            if (chart) {
                chart.destroy();
            }
        });
        this.charts = {};
    }

    async generateReport() {
        try {
            const button = document.getElementById('generate-historical-report');
            const originalText = button.innerHTML;

            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';

            // Get current time range
            const hours = this.getHoursFromRange();

            // Generate report URL
            const reportUrl = `/api/reports/historical/pdf?hours=${hours}`;

            // Fetch the PDF as a blob
            const response = await fetch(reportUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/pdf'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // Get the PDF blob
            const pdfBlob = await response.blob();

            // Create download link
            const downloadUrl = window.URL.createObjectURL(pdfBlob);
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `historical_report_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.pdf`;

            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Clean up the blob URL
            window.URL.revokeObjectURL(downloadUrl);

            // Show success message
            showNotification('Historical report generated successfully!', 'success');

        } catch (error) {
            console.error('Error generating report:', error);
            showNotification('Failed to generate report. Please try again.', 'error');
        } finally {
            // Restore button state
            const button = document.getElementById('generate-historical-report');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>Generate Report';
        }
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Ensure Bootstrap pills activate correctly when the side buttons are clicked
    document.querySelectorAll('.historical-nav .nav-link').forEach(function(el) {
        el.addEventListener('click', function () {
            const tab = bootstrap.Tab.getOrCreateInstance(this);
            tab.show();
            const targetPane = document.querySelector(this.getAttribute('data-bs-target'));
            if (targetPane) {
                targetPane.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
    new HistoricalDataManager();
});
</script>
{% endblock %}
