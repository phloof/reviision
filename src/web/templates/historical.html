{% extends "base.html" %}

{% block title %}Historical Data - ReViision{% endblock %}

{% block styles %}
<style>
/* Historical data specific styles using design system */
.date-range-picker {
    background: var(--color-surface-primary);
    border: 1px solid var(--color-border-primary);
    border-radius: var(--radius-xl);
    padding: var(--spacing-6);
}

.chart-container {
    position: relative;
    height: 400px;
    width: 100%;
}

.data-export-section {
    background: var(--color-surface-secondary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-4);
    border: 1px solid var(--color-border-primary);
}

.metric-card {
    background: var(--color-surface-primary);
    border: 1px solid var(--color-border-primary);
    border-radius: var(--radius-xl);
    padding: var(--spacing-6);
    text-align: center;
    transition: var(--transition-all);
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.metric-value {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary-600);
    margin-bottom: var(--spacing-2);
}

.metric-label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.trend-indicator {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-1);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    margin-top: var(--spacing-2);
}

.trend-up { color: var(--color-success-600); }
.trend-down { color: var(--color-danger-600); }
.trend-neutral { color: var(--color-text-muted); }

@media (max-width: 767px) {
    .chart-container {
        height: 300px;
    }

    .metric-value {
        font-size: var(--font-size-2xl);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container py-6">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-primary mb-2">Historical Data Analysis</h1>
        <p class="text-secondary">Comprehensive historical insights and trend analysis</p>
    </div>

    <!-- Navigation Tabs -->
    <div class="card mb-6">
        <div class="card-body p-4">
            <nav class="nav nav-pills d-flex flex-wrap gap-2" id="historical-nav">
                <a class="nav-link active" href="#overview" data-section="overview">
                    <i class="fas fa-chart-area mr-2"></i>
                    Overview
                </a>
                <a class="nav-link" href="#traffic" data-section="traffic">
                    <i class="fas fa-walking mr-2"></i>
                    Traffic Patterns
                </a>
                <a class="nav-link" href="#demographics" data-section="demographics">
                    <i class="fas fa-users mr-2"></i>
                    Demographics
                </a>
                <a class="nav-link" href="#dwell-time" data-section="dwell">
                    <i class="fas fa-clock mr-2"></i>
                    Dwell Time
                </a>
                <a class="nav-link" href="#reports" data-section="reports">
                    <i class="fas fa-file-alt mr-2"></i>
                    Reports
                </a>
            </nav>
        </div>
    </div>

    <!-- Date Range and Filters -->
    <div class="date-range-picker mb-6">
        <h3 class="text-lg font-semibold mb-4">
            <i class="fas fa-calendar-alt text-primary mr-2"></i>
            Date Range & Filters
        </h3>
        <div class="d-grid grid-cols-1 tablet-grid-cols-2 desktop-grid-cols-4 gap-4">
            <div class="form-group">
                <label for="start-date" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="start-date">
            </div>
            <div class="form-group">
                <label for="end-date" class="form-label">End Date</label>
                <input type="date" class="form-control" id="end-date">
            </div>
            <div class="form-group">
                <label for="time-granularity" class="form-label">Time Granularity</label>
                <select class="form-control" id="time-granularity">
                    <option value="hour">Hourly</option>
                    <option value="day" selected>Daily</option>
                    <option value="week">Weekly</option>
                    <option value="month">Monthly</option>
                </select>
            </div>
            <div class="form-group d-flex items-end">
                <button class="btn btn-primary w-full" id="apply-date-filter">
                    <i class="fas fa-search"></i>
                    Apply Filter
                </button>
            </div>
        </div>
    </div>
    <!-- Content Sections -->
    <div id="content-sections">
        <!-- Overview Section -->
        <div id="overview-section" class="content-section">
            <!-- Key Metrics -->
            <div class="d-grid grid-cols-2 desktop-grid-cols-4 gap-4 mb-8">
                <div class="metric-card">
                    <div class="metric-value" id="total-visitors">--</div>
                    <div class="metric-label">Total Visitors</div>
                    <div class="trend-indicator trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span id="visitors-trend">+12%</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avg-dwell-time">--</div>
                    <div class="metric-label">Avg. Dwell Time</div>
                    <div class="trend-indicator trend-down">
                        <i class="fas fa-arrow-down"></i>
                        <span id="dwell-trend">-3%</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="peak-hour">--</div>
                    <div class="metric-label">Peak Hour</div>
                    <div class="trend-indicator trend-neutral">
                        <i class="fas fa-minus"></i>
                        <span id="peak-trend">No change</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="conversion-rate">--</div>
                    <div class="metric-label">Conversion Rate</div>
                    <div class="trend-indicator trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span id="conversion-trend">+8%</span>
                    </div>
                </div>
            </div>

            <!-- Overview Charts -->
            <div class="d-grid grid-cols-1 desktop-grid-cols-2 gap-6 mb-6">
                <div class="card">
                    <div class="card-header card-header-primary">
                        <h3 class="card-title">
                            <i class="fas fa-chart-area"></i>
                            Traffic Overview
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="overview-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header card-header-primary">
                        <h3 class="card-title" style="color: white;">
                            <i class="fas fa-clock" style="color: white;"></i>
                            Hourly Distribution
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="hourly-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Traffic Patterns Section -->
        <div id="traffic-section" class="content-section d-none">
            <div class="card mb-6">
                <div class="card-header card-header-primary">
                    <h3 class="card-title">
                        <i class="fas fa-users"></i>
                        Visitor Traffic Analysis
                    </h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="traffic-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="d-grid grid-cols-1 desktop-grid-cols-2 gap-6">
                <div class="card">
                    <div class="card-header card-header-warning">
                        <h3 class="card-title">
                            <i class="fas fa-calendar-week"></i>
                            Weekly Patterns
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="weekly-patterns-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header card-header-danger">
                        <h3 class="card-title">
                            <i class="fas fa-chart-bar"></i>
                            Peak Hours Analysis
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="peak-hours-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Demographics Section -->
        <div id="demographics-section" class="content-section d-none">
            <div class="d-grid grid-cols-1 desktop-grid-cols-2 gap-6 mb-6">
                <div class="card">
                    <div class="card-header card-header-primary">
                        <h3 class="card-title">
                            <i class="fas fa-birthday-cake"></i>
                            Age Distribution Trends
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="age-trends-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header card-header-success">
                        <h3 class="card-title">
                            <i class="fas fa-venus-mars"></i>
                            Gender Distribution Trends
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="gender-trends-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dwell Time Section -->
        <div id="dwell-section" class="content-section d-none">
            <div class="card mb-6">
                <div class="card-header card-header-warning">
                    <h3 class="card-title">
                        <i class="fas fa-clock"></i>
                        Dwell Time Analysis
                    </h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="dwell-time-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="content-section d-none">
            <div class="card">
                <div class="card-header card-header-primary">
                    <h3 class="card-title">
                        <i class="fas fa-file-alt"></i>
                        Generate Reports
                    </h3>
                </div>
                <div class="card-body">
                    <div class="data-export-section mb-6">
                        <h4 class="text-lg font-semibold mb-4">Export Options</h4>
                        <div class="d-flex flex-wrap gap-3">
                            <button class="btn btn-outline-primary" id="export-csv">
                                <i class="fas fa-file-csv"></i>
                                Export CSV
                            </button>
                            <button class="btn btn-outline-primary" id="export-pdf">
                                <i class="fas fa-file-pdf"></i>
                                Export PDF
                            </button>
                            <button class="btn btn-outline-primary" id="export-excel">
                                <i class="fas fa-file-excel"></i>
                                Export Excel
                            </button>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Reports will include data from the selected date range and applied filters.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Historical Data Navigation
document.addEventListener('DOMContentLoaded', function() {
    // Navigation handling
    const navLinks = document.querySelectorAll('#historical-nav .nav-link');
    const sections = document.querySelectorAll('.content-section');

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            // Update active nav link
            navLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            // Show corresponding section
            const targetSection = this.getAttribute('data-section');
            sections.forEach(section => {
                section.classList.add('d-none');
            });

            const activeSection = document.getElementById(targetSection + '-section');
            if (activeSection) {
                activeSection.classList.remove('d-none');
            }
        });
    });

    // Date filter handling
    document.getElementById('apply-date-filter').addEventListener('click', function() {
        // Add loading state
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        this.disabled = true;

        // Simulate data loading
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-search"></i> Apply Filter';
            this.disabled = false;

            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show mt-4';
            alert.innerHTML = `
                <i class="fas fa-check-circle"></i>
                Data updated successfully for the selected date range.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.date-range-picker').appendChild(alert);

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        }, 1500);
    });
});
</script>
<!-- Chart.js is loaded globally via base.html -->
<script>
// Historical Data Page JavaScript
class HistoricalDataManager {
    constructor() {
        this.charts = {};
        this.currentData = null;
        this.init();
    }
    
    init() {
        this.setupEventHandlers();
        this.loadData();
    }
    
    setupEventHandlers() {
        // Date range change
        document.getElementById('date-range').addEventListener('change', () => {
            this.loadData();
        });
        
        // Refresh button
        document.getElementById('refresh-data').addEventListener('click', () => {
            this.loadData(true);
        });
        
        // Tab changes
        document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', (e) => {
                this.handleTabChange(e.target);
            });
        });
    }
    
    handleTabChange(tab) {
        // Resize charts when tab becomes visible
        setTimeout(() => {
            Object.values(this.charts).forEach(chart => {
                if (chart && typeof chart.resize === 'function') {
                    chart.resize();
                }
            });
        }, 100);
    }
    
    async loadData(showLoading = false) {
        try {
            if (showLoading) {
                this.showLoading();
            }
            
            const hours = this.getHoursFromRange();
            const response = await fetch(`/api/analytics/historical?hours=${hours}`, {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Invalid response format - expected JSON');
            }
            
            const data = await response.json();
            
            if (data.success) {
                this.currentData = data;
                this.updateUI(data);
                this.showSuccessMessage('Data loaded successfully');
            } else {
                throw new Error(data.message || 'Failed to load data');
            }
        } catch (error) {
            console.error('Error loading data:', error);
            this.showError(error.message);
            this.showNoDataState();
        } finally {
            if (showLoading) {
                this.hideLoading();
            }
        }
    }
    
    updateUI(data) {
        this.updateStatistics(data);
        this.updateCharts(data);
    }
    
    updateStatistics(data) {
        document.getElementById('total-visitors').textContent = (data.total_visitors || 0).toLocaleString();
        document.getElementById('avg-dwell-time').textContent = this.formatDwellTime(data.avg_dwell_time || 0);
        document.getElementById('peak-hour').textContent = data.peak_hour || '--:--';
        document.getElementById('conversion-rate').textContent = data.conversion_rate ? `${data.conversion_rate}%` : '--';
    }
    
    updateCharts(data) {
        this.createOverviewChart(data);
        this.createTrafficChart(data);
        this.createWeeklyChart(data);
        this.createGenderChart(data);
        this.createAgeChart(data);
    }
    
    createOverviewChart(data) {
        const ctx = document.getElementById('overview-chart');
        if (!ctx) return;
        
        if (this.charts.overview) {
            this.charts.overview.destroy();
        }
        
        const traffic = data.traffic || {};
        const labels = traffic.labels || [];
        const values = traffic.data || [];
        
        const overviewConfig = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: values,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };
        this.charts.overview = new ChartManager(ctx, overviewConfig, { filename: 'overview_traffic' });
    }
    
    createTrafficChart(data) {
        const ctx = document.getElementById('traffic-chart');
        if (!ctx) return;
        
        if (this.charts.traffic) {
            this.charts.traffic.destroy();
        }
        
        const traffic = data.traffic || {};
        const labels = traffic.labels || [];
        const values = traffic.data || [];
        
        const trafficConfig = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: values,
                    backgroundColor: '#3498db',
                    borderColor: '#2980b9',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };
        this.charts.traffic = new ChartManager(ctx, trafficConfig, { filename: 'traffic_by_hour' });
    }
    
    createWeeklyChart(data) {
        const ctx = document.getElementById('weekly-chart');
        if (!ctx) return;
        
        if (this.charts.weekly) {
            this.charts.weekly.destroy();
        }
        
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const values = new Array(7).fill(0);
        
        // Aggregate data by day of week if available
        if (data.traffic && data.traffic.data) {
            data.traffic.data.forEach((value, index) => {
                values[index % 7] += value;
            });
        }
        
        const weeklyConfig = {
            type: 'bar',
            data: {
                labels: days,
                datasets: [{
                    label: 'Daily Visitors',
                    data: values,
                    backgroundColor: '#f39c12',
                    borderColor: '#e67e22',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };
        this.charts.weekly = new ChartManager(ctx, weeklyConfig, { filename: 'weekly_patterns' });
    }
    
    createGenderChart(data) {
        const ctx = document.getElementById('gender-chart');
        if (!ctx) return;
        
        if (this.charts.gender) {
            this.charts.gender.destroy();
        }
        
        const genderData = data.gender_distribution || {};
        const labels = Object.keys(genderData);
        const values = Object.values(genderData);
        
        const genderConfig = {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#3498db', '#e74c3c', '#f39c12']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        };
        this.charts.gender = new ChartManager(ctx, genderConfig, { filename: 'gender_distribution_hist' });
    }
    
    createAgeChart(data) {
        const ctx = document.getElementById('age-chart');
        if (!ctx) return;
        
        if (this.charts.age) {
            this.charts.age.destroy();
        }
        
        const ageData = data.age_groups || {};
        const labels = Object.keys(ageData);
        const values = Object.values(ageData);
        
        const ageConfig = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: values,
                    backgroundColor: '#2ecc71',
                    borderColor: '#27ae60',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };
        this.charts.age = new ChartManager(ctx, ageConfig, { filename: 'age_distribution_hist' });
    }
    
    getHoursFromRange() {
        const range = document.getElementById('date-range').value;
        const map = {
            '1h': 1,
            '6h': 6,
            '24h': 24,
            '7d': 168,
            '30d': 720
        };
        return map[range] || 24;
    }
    
    formatDwellTime(seconds) {
        if (!seconds) return '0s';
        
        if (seconds < 60) {
            return `${Math.round(seconds)}s`;
        } else {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    }
    
    showLoading() {
        const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
        modal.show();
    }
    
    hideLoading() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
        if (modal) {
            modal.hide();
        }
    }
    
    showError(message) {
        this.showNotificationPopup('error', `Error: ${message}`);
    }
    
    showSuccessMessage(message) {
        showNotification(message, 'success');
    }
    
    showNoDataState() {
        document.getElementById('total-visitors').textContent = '0';
        document.getElementById('avg-dwell-time').textContent = '0s';
        document.getElementById('peak-hour').textContent = '--:--';
        document.getElementById('conversion-rate').textContent = '0%';
        
        // Clear charts
        Object.values(this.charts).forEach(chart => {
            if (chart) {
                chart.destroy();
            }
        });
        this.charts = {};
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Ensure Bootstrap pills activate correctly when the side buttons are clicked
    document.querySelectorAll('.historical-nav .nav-link').forEach(function(el) {
        el.addEventListener('click', function () {
            const tab = bootstrap.Tab.getOrCreateInstance(this);
            tab.show();
            const targetPane = document.querySelector(this.getAttribute('data-bs-target'));
            if (targetPane) {
                targetPane.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
    new HistoricalDataManager();
});
</script>
{% endblock %}
