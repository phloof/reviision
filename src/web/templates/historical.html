{% extends "base.html" %}

{% block title %}Historical Data - ReViision{% endblock %}

{% block header %}Historical Data{% endblock %}

{% block styles %}
<style>
    .historical-nav {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        margin-bottom: 2rem;
    }
    
    .historical-nav .nav-link {
        border-radius: 8px;
        color: #6c757d;
        font-weight: 500;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .historical-nav .nav-link:hover {
        background: #f8f9fa;
        color: #495057;
    }
    
    .historical-nav .nav-link.active {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }
    
    .historical-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }
    
    .btn {
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        border: none;
    }
    
    .btn-success {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        border: none;
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        border: none;
    }
    
    .btn-warning {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        border: none;
        color: white;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 1rem;
    }
    
    .chart-container canvas {
        max-height: 400px;
    }
    
    .alert {
        border-radius: 8px;
        border: none;
    }
    
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    
    .no-data-message {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .no-data-message i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #dee2e6;
    }
    
    /* Notification Popup Styles */
    .notification-popup {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
    }
    
    .notification-popup.show {
        opacity: 1;
        transform: translateX(0);
        pointer-events: auto;
    }
    
    .notification-popup.fade-out {
        opacity: 0;
        transform: translateX(100%);
    }
    
    .notification-content {
        background: #ffffff;
        border-radius: 12px;
        padding: 16px 20px;
        min-width: 300px;
        max-width: 400px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        border: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        gap: 12px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    
    .notification-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-color: #27ae60;
        color: #155724;
    }
    
    .notification-success .notification-icon {
        color: #27ae60;
    }
    
    .notification-error {
        background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%);
        border-color: #e74c3c;
        color: #721c24;
    }
    
    .notification-error .notification-icon {
        color: #e74c3c;
    }
    
    .notification-icon {
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.8);
        flex-shrink: 0;
    }
    
    .notification-message {
        font-weight: 500;
        font-size: 0.95rem;
        line-height: 1.4;
        flex-grow: 1;
    }
    
    /* Animation for icon */
    .notification-success .notification-icon i {
        animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes checkmark {
        0% {
            transform: scale(0.8);
            opacity: 0;
        }
        50% {
            transform: scale(1.1);
            opacity: 1;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-container {
            height: 300px;
        }
        
        .notification-popup {
            top: 10px;
            right: 10px;
            left: 10px;
        }
        
        .notification-content {
            min-width: auto;
            max-width: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">Historical Data</h1>
                    <p class="text-muted mb-0">View and analyze historical visitor data and trends</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Filter Navigation -->
        <div class="col-lg-3 mb-4">
            <div class="historical-nav">
                <div class="nav nav-pills flex-column" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <button class="nav-link active" id="v-pills-overview-tab" data-bs-toggle="pill" data-bs-target="#v-pills-overview" type="button" role="tab">
                        <i class="fas fa-chart-line me-2"></i>Overview
                    </button>
                    <button class="nav-link" id="v-pills-traffic-tab" data-bs-toggle="pill" data-bs-target="#v-pills-traffic" type="button" role="tab">
                        <i class="fas fa-users me-2"></i>Traffic Analysis
                    </button>
                    <button class="nav-link" id="v-pills-demographics-tab" data-bs-toggle="pill" data-bs-target="#v-pills-demographics" type="button" role="tab">
                        <i class="fas fa-user-friends me-2"></i>Demographics
                    </button>
                    <button class="nav-link" id="v-pills-patterns-tab" data-bs-toggle="pill" data-bs-target="#v-pills-patterns" type="button" role="tab">
                        <i class="fas fa-route me-2"></i>Patterns
                    </button>
                </div>
                
                <!-- Date Range Filter -->
                <div class="mt-3">
                    <label for="date-range" class="form-label">Date Range</label>
                    <select class="form-select" id="date-range">
                        <option value="1h">Last Hour</option>
                        <option value="6h">Last 6 Hours</option>
                        <option value="24h" selected>Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                    </select>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-primary w-100" id="refresh-data">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Historical Content -->
        <div class="col-lg-9">
            <div class="tab-content" id="v-pills-tabContent">
                
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="v-pills-overview" role="tabpanel">
                    <!-- Statistics Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-users fa-2x mb-3" style="color: #3498db;"></i>
                            <div class="stat-value" id="total-visitors">--</div>
                            <div class="stat-label">Total Visitors</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-clock fa-2x mb-3" style="color: #e74c3c;"></i>
                            <div class="stat-value" id="avg-dwell-time">--</div>
                            <div class="stat-label">Average Dwell Time</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-chart-line fa-2x mb-3" style="color: #f39c12;"></i>
                            <div class="stat-value" id="peak-hour">--</div>
                            <div class="stat-label">Peak Hour</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-percentage fa-2x mb-3" style="color: #2ecc71;"></i>
                            <div class="stat-value" id="conversion-rate">--</div>
                            <div class="stat-label">Conversion Rate</div>
                        </div>
                    </div>
                    
                    <!-- Quick Charts -->
                    <div class="historical-section">
                        <h3 class="section-title">
                            <i class="fas fa-chart-area me-2"></i>Traffic Overview
                        </h3>
                        <div class="chart-container">
                            <canvas id="overview-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Traffic Analysis Tab -->
                <div class="tab-pane fade" id="v-pills-traffic" role="tabpanel">
                    <div class="historical-section">
                        <h3 class="section-title">
                            <i class="fas fa-users me-2"></i>Visitor Traffic Analysis
                        </h3>
                        <div class="chart-container">
                            <canvas id="traffic-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="historical-section">
                        <h3 class="section-title">
                            <i class="fas fa-calendar-week me-2"></i>Weekly Patterns
                        </h3>
                        <div class="chart-container">
                            <canvas id="weekly-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Demographics Tab -->
                <div class="tab-pane fade" id="v-pills-demographics" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="historical-section">
                                <h3 class="section-title">
                                    <i class="fas fa-venus-mars me-2"></i>Gender Distribution
                                </h3>
                                <div class="chart-container">
                                    <canvas id="gender-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="historical-section">
                                <h3 class="section-title">
                                    <i class="fas fa-birthday-cake me-2"></i>Age Groups
                                </h3>
                                <div class="chart-container">
                                    <canvas id="age-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="historical-section">
                        <h3 class="section-title">
                            <i class="fas fa-clock me-2"></i>Dwell Time Distribution
                        </h3>
                        <div id="dwell-content">
                            <div class="no-data-message">
                                <i class="fas fa-clock"></i>
                                <h5>Dwell Time Analysis</h5>
                                <p>Dwell time distribution will be displayed here when sufficient data is available.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Patterns Tab -->
                <div class="tab-pane fade" id="v-pills-patterns" role="tabpanel">
                    <div class="historical-section">
                        <h3 class="section-title">
                            <i class="fas fa-route me-2"></i>Customer Journey Patterns
                        </h3>
                        <div id="patterns-content">
                            <div class="no-data-message">
                                <i class="fas fa-route"></i>
                                <h5>Pattern Analysis</h5>
                                <p>Customer journey patterns will be displayed here when sufficient data is available.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Loading Analytics Data...</h5>
                <p class="text-muted mb-0">Please wait while we fetch the latest data.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Historical Data Page JavaScript
class HistoricalDataManager {
    constructor() {
        this.charts = {};
        this.currentData = null;
        this.init();
    }
    
    init() {
        this.setupEventHandlers();
        this.loadData();
    }
    
    setupEventHandlers() {
        // Date range change
        document.getElementById('date-range').addEventListener('change', () => {
            this.loadData();
        });
        
        // Refresh button
        document.getElementById('refresh-data').addEventListener('click', () => {
            this.loadData(true);
        });
        
        // Tab changes
        document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', (e) => {
                this.handleTabChange(e.target);
            });
        });
    }
    
    handleTabChange(tab) {
        // Resize charts when tab becomes visible
        setTimeout(() => {
            Object.values(this.charts).forEach(chart => {
                if (chart && typeof chart.resize === 'function') {
                    chart.resize();
                }
            });
        }, 100);
    }
    
    async loadData(showLoading = false) {
        try {
            if (showLoading) {
                this.showLoading();
            }
            
            const hours = this.getHoursFromRange();
            const response = await fetch(`/api/analytics/historical?hours=${hours}`, {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Invalid response format - expected JSON');
            }
            
            const data = await response.json();
            
            if (data.success) {
                this.currentData = data;
                this.updateUI(data);
                this.showSuccessMessage('Data loaded successfully');
            } else {
                throw new Error(data.message || 'Failed to load data');
            }
        } catch (error) {
            console.error('Error loading data:', error);
            this.showError(error.message);
            this.showNoDataState();
        } finally {
            if (showLoading) {
                this.hideLoading();
            }
        }
    }
    
    updateUI(data) {
        this.updateStatistics(data);
        this.updateCharts(data);
    }
    
    updateStatistics(data) {
        document.getElementById('total-visitors').textContent = (data.total_visitors || 0).toLocaleString();
        document.getElementById('avg-dwell-time').textContent = this.formatDwellTime(data.avg_dwell_time || 0);
        document.getElementById('peak-hour').textContent = data.peak_hour || '--:--';
        document.getElementById('conversion-rate').textContent = data.conversion_rate ? `${data.conversion_rate}%` : '--';
    }
    
    updateCharts(data) {
        this.createOverviewChart(data);
        this.createTrafficChart(data);
        this.createWeeklyChart(data);
        this.createGenderChart(data);
        this.createAgeChart(data);
    }
    
    createOverviewChart(data) {
        const ctx = document.getElementById('overview-chart');
        if (!ctx) return;
        
        if (this.charts.overview) {
            this.charts.overview.destroy();
        }
        
        const traffic = data.traffic || {};
        const labels = traffic.labels || [];
        const values = traffic.data || [];
        
        this.charts.overview = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: values,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    createTrafficChart(data) {
        const ctx = document.getElementById('traffic-chart');
        if (!ctx) return;
        
        if (this.charts.traffic) {
            this.charts.traffic.destroy();
        }
        
        const traffic = data.traffic || {};
        const labels = traffic.labels || [];
        const values = traffic.data || [];
        
        this.charts.traffic = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: values,
                    backgroundColor: '#3498db',
                    borderColor: '#2980b9',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    createWeeklyChart(data) {
        const ctx = document.getElementById('weekly-chart');
        if (!ctx) return;
        
        if (this.charts.weekly) {
            this.charts.weekly.destroy();
        }
        
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const values = new Array(7).fill(0);
        
        // Aggregate data by day of week if available
        if (data.traffic && data.traffic.data) {
            data.traffic.data.forEach((value, index) => {
                values[index % 7] += value;
            });
        }
        
        this.charts.weekly = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: days,
                datasets: [{
                    label: 'Daily Visitors',
                    data: values,
                    backgroundColor: '#f39c12',
                    borderColor: '#e67e22',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    createGenderChart(data) {
        const ctx = document.getElementById('gender-chart');
        if (!ctx) return;
        
        if (this.charts.gender) {
            this.charts.gender.destroy();
        }
        
        const genderData = data.gender_distribution || {};
        const labels = Object.keys(genderData);
        const values = Object.values(genderData);
        
        this.charts.gender = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#3498db', '#e74c3c', '#f39c12']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    createAgeChart(data) {
        const ctx = document.getElementById('age-chart');
        if (!ctx) return;
        
        if (this.charts.age) {
            this.charts.age.destroy();
        }
        
        const ageData = data.age_groups || {};
        const labels = Object.keys(ageData);
        const values = Object.values(ageData);
        
        this.charts.age = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: values,
                    backgroundColor: '#2ecc71',
                    borderColor: '#27ae60',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    getHoursFromRange() {
        const range = document.getElementById('date-range').value;
        const map = {
            '1h': 1,
            '6h': 6,
            '24h': 24,
            '7d': 168,
            '30d': 720
        };
        return map[range] || 24;
    }
    
    formatDwellTime(seconds) {
        if (!seconds) return '0s';
        
        if (seconds < 60) {
            return `${Math.round(seconds)}s`;
        } else {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    }
    
    showLoading() {
        const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
        modal.show();
    }
    
    hideLoading() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
        if (modal) {
            modal.hide();
        }
    }
    
    showError(message) {
        this.showNotificationPopup('error', `Error: ${message}`);
    }
    
    showSuccessMessage(message) {
        this.showNotificationPopup('success', message);
    }
    
    showNotificationPopup(type, message) {
        // Remove any existing notifications
        const existingNotifications = document.querySelectorAll('.notification-popup');
        existingNotifications.forEach(notification => notification.remove());
        
        const popup = document.createElement('div');
        popup.className = 'notification-popup';
        popup.innerHTML = `
            <div class="notification-content notification-${type}">
                <div class="notification-icon">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                </div>
                <div class="notification-message">${message}</div>
            </div>
        `;
        
        document.body.appendChild(popup);
        
        // Trigger animation
        setTimeout(() => {
            popup.classList.add('show');
        }, 100);
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            popup.classList.add('fade-out');
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.remove();
                }
            }, 300);
        }, 3000);
    }
    
    showNoDataState() {
        document.getElementById('total-visitors').textContent = '0';
        document.getElementById('avg-dwell-time').textContent = '0s';
        document.getElementById('peak-hour').textContent = '--:--';
        document.getElementById('conversion-rate').textContent = '0%';
        
        // Clear charts
        Object.values(this.charts).forEach(chart => {
            if (chart) {
                chart.destroy();
            }
        });
        this.charts = {};
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    new HistoricalDataManager();
});
</script>
{% endblock %}
