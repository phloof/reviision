{% extends "base.html" %}

{% block title %}Historical Data - ReViision{% endblock %}

{% block header %}Historical Data{% endblock %}

{% block styles %}
<style>
    /* ====================================
       Historical Data Page Styles
       ==================================== */

    /* Filter Controls Card */
    .filter-card {
        background-color: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    /* Custom Date Range */
    .custom-date-range {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    /* Path Analysis Styling */
    .path-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        background: var(--background-color);
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
    }

    .path-item:hover {
        background: var(--accent-color);
    }

    /* Loading overlay for statistics */
    .stat-loading {
        opacity: 0.5;
        pointer-events: none;
    }

    /* No data message */
    .no-data-message {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .stats-card h3 {
            font-size: 2rem;
        }
        
        .chart-card .card-body {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- ====================================
     Filter Controls Section
     ==================================== -->
<div class="filter-card">
    <div class="row align-items-end">
        <div class="col-lg-3 col-md-6 mb-3">
            <label for="date-range" class="form-label">Date Range</label>
            <select class="form-select" id="date-range">
                <option value="1h">Last Hour</option>
                <option value="6h">Last 6 Hours</option>
                <option value="24h" selected>Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
                <option value="custom">Custom Range</option>
            </select>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <label for="metric-select" class="form-label">Metric</label>
            <select class="form-select" id="metric-select">
                <option value="visitors" selected>Visitors</option>
                <option value="dwell-time">Dwell Time</option>
                <option value="demographics">Demographics</option>
                <option value="traffic-patterns">Traffic Patterns</option>
            </select>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <label for="time-granularity" class="form-label">Time Granularity</label>
            <select class="form-select" id="time-granularity">
                <option value="hourly" selected>Hourly</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
            </select>
        </div>
        <div class="col-lg-3 col-md-12 mb-3">
            <button class="btn btn-primary w-100" id="apply-filters">
                <i class="fas fa-search me-2"></i>Apply Filters
            </button>
        </div>
    </div>
    
    <!-- Custom Date Range Inputs -->
    <div class="row custom-date-range" style="display: none;">
        <div class="col-lg-4 col-md-6 mb-3">
            <label for="start-date" class="form-label">Start Date</label>
            <input type="date" class="form-control" id="start-date">
        </div>
        <div class="col-lg-4 col-md-6 mb-3">
            <label for="end-date" class="form-label">End Date</label>
            <input type="date" class="form-control" id="end-date">
        </div>
    </div>
</div>

<!-- Statistics Cards Row -->
<div class="row mb-4 stats-grid">
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-3" style="color: #3498db;"></i>
                <div class="stat-value" id="total-visitors">Loading...</div>
                <div class="stat-label">Total Visitors</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-3" style="color: #e74c3c;"></i>
                <div class="stat-value" id="average-dwell">Loading...</div>
                <div class="stat-label">Average Dwell Time</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-3" style="color: #f39c12;"></i>
                <div class="stat-value" id="peak-hour">Loading...</div>
                <div class="stat-label">Peak Hour</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-percentage fa-2x mb-3" style="color: #2ecc71;"></i>
                <div class="stat-value" id="conversion-rate">Loading...</div>
                <div class="stat-label">Conversion Rate</div>
            </div>
        </div>
    </div>
</div>

<!-- ====================================
     Main Analysis Cards
     ==================================== -->

<!-- Traffic Chart Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Visitor Traffic Over Time</h3>
                <div class="tooltip">
                    <i class="fas fa-info-circle"></i>
                    <span class="tooltip-text">Historical visitor traffic patterns</span>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="traffic-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Demographics Chart Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Demographic Breakdown</h3>
                <div class="tooltip">
                    <i class="fas fa-info-circle"></i>
                    <span class="tooltip-text">Customer demographics and dwell time analysis</span>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <div class="row">
                        <div class="col-md-8">
                            <canvas id="demographics-chart"></canvas>
                        </div>
                        <div class="col-md-4">
                            <canvas id="dwell-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Weekly Traffic Chart Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Weekly Traffic Patterns</h3>
                <div class="tooltip">
                    <i class="fas fa-info-circle"></i>
                    <span class="tooltip-text">Day-by-day traffic analysis</span>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="weekly-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Path Analysis Row -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Customer Journey Analysis</h3>
                <div class="tooltip">
                    <i class="fas fa-info-circle"></i>
                    <span class="tooltip-text">Most common customer paths and behavior patterns</span>
                </div>
            </div>
            <div class="card-body">
                <div id="path-analysis">
                    <div class="no-data-message">
                        <i class="fas fa-route fa-3x mb-3 text-muted"></i>
                        <h5>Path Analysis</h5>
                        <p>Customer path analysis will appear here when sufficient data is available.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ====================================
    // Historical Data Page JavaScript
    // ====================================

    // Global variables
    let trafficChart, demographicsChart, dwellChart, weeklyChart;
    let currentAnalyticsData = null;

    /**
     * Initialize the page when DOM is loaded
     */
    document.addEventListener('DOMContentLoaded', function() {
        initializeDateRangeHandler();
        setupEventHandlers();
        loadInitialData();
    });

    /**
     * Handle date range selection changes
     */
    function initializeDateRangeHandler() {
        document.getElementById('date-range').addEventListener('change', function() {
            const customDateRange = document.querySelector('.custom-date-range');
            if (this.value === 'custom') {
                customDateRange.style.display = 'flex';
            } else {
                customDateRange.style.display = 'none';
            }
        });
    }

    /**
     * Setup event handlers for filter controls
     */
    function setupEventHandlers() {
        document.getElementById('apply-filters').addEventListener('click', function() {
            loadAnalyticsData();
        });

        // Auto-refresh data when date range changes
        document.getElementById('date-range').addEventListener('change', function() {
            loadAnalyticsData();
        });
    }

    /**
     * Load initial data on page load
     */
    function loadInitialData() {
        loadAnalyticsData();
    }

    /**
     * Load analytics data from API
     */
    async function loadAnalyticsData() {
        try {
            showLoadingState();
            
            const dateRange = document.getElementById('date-range').value;
            const hours = getHoursFromDateRange(dateRange);
            
            // Fetch analytics summary
            const summaryResponse = await fetch(`/api/analytics/summary?hours=${hours}`);
            const summaryData = await summaryResponse.json();
            
            // Fetch traffic data
            const trafficResponse = await fetch(`/api/analytics/traffic?hours=${hours}`);
            const trafficData = await trafficResponse.json();
            
            if (summaryData.success && trafficData.success) {
                currentAnalyticsData = {
                    summary: summaryData,
                    traffic: trafficData
                };
                
                // Update statistics cards
                updateStatisticsCards(summaryData);
                
                // Create/update charts
                createTrafficChart(trafficData);
                createDemographicsChart(summaryData);
                createDwellTimeChart(summaryData);
                createWeeklyTrafficChart(trafficData);
                
                hideLoadingState();
            } else {
                // Show no data state
                showNoDataState();
                hideLoadingState();
            }
            
        } catch (error) {
            console.error('Error loading analytics data:', error);
            showErrorState(error.message);
            hideLoadingState();
        }
    }

    /**
     * Convert date range to hours
     */
    function getHoursFromDateRange(dateRange) {
        const rangeMap = {
            '1h': 1,
            '6h': 6,
            '24h': 24,
            '7d': 168,  // 7 * 24
            '30d': 720, // 30 * 24
            'custom': 24 // default for custom
        };
        return rangeMap[dateRange] || 24;
    }

    /**
     * Update statistics cards with real data
     */
    function updateStatisticsCards(data) {
        document.getElementById('total-visitors').textContent = data.total_visitors?.toLocaleString() || '0';
        document.getElementById('average-dwell').textContent = formatDwellTime(data.avg_dwell_time) || '0s';
        document.getElementById('peak-hour').textContent = data.peak_hour || '--:--';
        document.getElementById('conversion-rate').textContent = `${data.conversion_rate || 0}%`;
    }

    /**
     * Format dwell time in seconds to readable format
     */
    function formatDwellTime(seconds) {
        if (!seconds || seconds === 0) return '0s';
        
        if (seconds < 60) {
            return `${Math.round(seconds)}s`;
        } else {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.round(seconds % 60);
            return remainingSeconds > 0 ? `${minutes}:${remainingSeconds.toString().padStart(2, '0')}` : `${minutes}:00`;
        }
    }

    /**
     * Create the main traffic chart
     */
    function createTrafficChart(data) {
        const ctx = document.getElementById('traffic-chart').getContext('2d');
        
        if (trafficChart) {
            trafficChart.destroy();
        }
        
        const labels = data.labels || [];
        const values = data.data || [];
        
        trafficChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: values,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                }
            }
        });
    }

    /**
     * Create demographics chart
     */
    function createDemographicsChart(data) {
        const ctx = document.getElementById('demographics-chart').getContext('2d');
        
        if (demographicsChart) {
            demographicsChart.destroy();
        }
        
        // Prepare data from age groups and gender distribution
        const ageGroups = data.age_groups || {};
        const genderDist = data.gender_distribution || {};
        
        const ageLabels = Object.keys(ageGroups);
        const ageValues = Object.values(ageGroups);
        
        demographicsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ageLabels,
                datasets: [{
                    data: ageValues,
                    backgroundColor: [
                        '#3498db', '#e74c3c', '#f39c12', '#2ecc71', 
                        '#9b59b6', '#1abc9c', '#34495e'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Age Distribution'
                    }
                }
            }
        });
    }

    /**
     * Create dwell time chart
     */
    function createDwellTimeChart(data) {
        const ctx = document.getElementById('dwell-chart').getContext('2d');
        
        if (dwellChart) {
            dwellChart.destroy();
        }
        
        // Create mock dwell time distribution if not provided
        const dwellData = data.dwell_time_distribution || {
            '0-30s': 20,
            '30s-1m': 35,
            '1-3m': 25,
            '3-5m': 15,
            '5m+': 5
        };
        
        dwellChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(dwellData),
                datasets: [{
                    label: 'Visitors',
                    data: Object.values(dwellData),
                    backgroundColor: '#e74c3c',
                    borderColor: '#c0392b',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Dwell Time Distribution'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Dwell Time Range'
                        }
                    }
                }
            }
        });
    }

    /**
     * Create weekly traffic chart
     */
    function createWeeklyTrafficChart(data) {
        const ctx = document.getElementById('weekly-chart').getContext('2d');
        
        if (weeklyChart) {
            weeklyChart.destroy();
        }
        
        // Create weekly data from hourly data if available
        const weeklyData = aggregateWeeklyData(data);
        
        weeklyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: weeklyData.labels,
                datasets: [{
                    label: 'Daily Visitors',
                    data: weeklyData.values,
                    backgroundColor: '#f39c12',
                    borderColor: '#e67e22',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Day of Week'
                        }
                    }
                }
            }
        });
    }

    /**
     * Aggregate hourly data into weekly data
     */
    function aggregateWeeklyData(data) {
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        
        if (!data.labels || !data.data) {
            return {
                labels: days,
                values: [0, 0, 0, 0, 0, 0, 0]
            };
        }
        
        // Simple aggregation - in real implementation would group by actual days
        const dailyTotals = new Array(7).fill(0);
        data.data.forEach((value, index) => {
            const dayIndex = index % 7;
            dailyTotals[dayIndex] += value;
        });
        
        return {
            labels: days,
            values: dailyTotals
        };
    }

    /**
     * Show loading state
     */
    function showLoadingState() {
        const button = document.getElementById('apply-filters');
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
        button.disabled = true;
        
        // Add loading class to stat cards
        document.querySelectorAll('.stat-card').forEach(card => {
            card.classList.add('stat-loading');
        });
    }

    /**
     * Hide loading state
     */
    function hideLoadingState() {
        const button = document.getElementById('apply-filters');
        button.innerHTML = '<i class="fas fa-search me-2"></i>Apply Filters';
        button.disabled = false;
        
        // Remove loading class from stat cards
        document.querySelectorAll('.stat-card').forEach(card => {
            card.classList.remove('stat-loading');
        });
    }

    /**
     * Show no data state
     */
    function showNoDataState() {
        document.getElementById('total-visitors').textContent = '0';
        document.getElementById('average-dwell').textContent = '0s';
        document.getElementById('peak-hour').textContent = '--:--';
        document.getElementById('conversion-rate').textContent = '0%';
        
        // Create empty charts
        createTrafficChart({labels: [], data: []});
        createDemographicsChart({age_groups: {}, gender_distribution: {}});
        createDwellTimeChart({});
        createWeeklyTrafficChart({labels: [], data: []});
    }

    /**
     * Show error state
     */
    function showErrorState(message) {
        console.error('Analytics error:', message);
        showNoDataState();
        
        // Could add user-visible error notification here
        const errorMsg = document.createElement('div');
        errorMsg.className = 'alert alert-warning';
        errorMsg.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            Unable to load analytics data. ${message}
        `;
        document.querySelector('.filter-card').after(errorMsg);
        
        setTimeout(() => errorMsg.remove(), 5000);
    }
</script>
{% endblock %}