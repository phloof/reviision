{% extends "base.html" %}

{% block title %}Settings - ReViision{% endblock %}

{% block header %}System Settings{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared-page-styles.css') }}">
<style>
    .settings-nav {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1rem;
    }
    
    .settings-nav .nav-link {
        border-radius: 8px;
        color: #6c757d;
        font-weight: 500;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .settings-nav .nav-link:hover {
        background: #f8f9fa;
        color: #495057;
    }
    
    .settings-nav .nav-link.active {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }
    
    .settings-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }
    
    .btn {
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        border: none;
    }
    
    .btn-success {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        border: none;
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        border: none;
    }
    
    .btn-warning {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        border: none;
        color: white;
    }
    
    .admin-only-section {
        border: 2px solid #e74c3c;
        border-radius: 12px;
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(192, 57, 43, 0.1) 100%);
    }
    
    .admin-badge {
        background: #e74c3c;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .alert {
        border-radius: 8px;
        border: none;
    }
    
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
    
    .data-management-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .data-management-buttons .btn {
        flex: 1;
        min-width: 200px;
    }
    
    @media (max-width: 768px) {
        .data-management-buttons {
            flex-direction: column;
        }
        
        .data-management-buttons .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">System Settings</h1>
                    <p class="text-muted mb-0">Configure camera, analysis, and system parameters</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Settings Navigation -->
        <div class="col-lg-3 mb-4">
            <div class="settings-nav">
                <div class="nav nav-pills flex-column" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <button class="nav-link active" id="v-pills-camera-tab" data-bs-toggle="pill" data-bs-target="#v-pills-camera" type="button" role="tab">
                        <i class="fas fa-video me-2"></i>Camera Settings
                    </button>
                    <button class="nav-link" id="v-pills-detection-tab" data-bs-toggle="pill" data-bs-target="#v-pills-detection" type="button" role="tab">
                        <i class="fas fa-search me-2"></i>Detection Settings
                    </button>
                    <button class="nav-link" id="v-pills-tracking-tab" data-bs-toggle="pill" data-bs-target="#v-pills-tracking" type="button" role="tab">
                        <i class="fas fa-route me-2"></i>Tracking Settings
                    </button>
                    <button class="nav-link" id="v-pills-analysis-tab" data-bs-toggle="pill" data-bs-target="#v-pills-analysis" type="button" role="tab">
                        <i class="fas fa-chart-line me-2"></i>Analysis Settings
                    </button>
                    <button class="nav-link" id="v-pills-database-tab" data-bs-toggle="pill" data-bs-target="#v-pills-database" type="button" role="tab">
                        <i class="fas fa-database me-2"></i>Database Management
                    </button>
                    <button class="nav-link" id="v-pills-system-tab" data-bs-toggle="pill" data-bs-target="#v-pills-system" type="button" role="tab">
                        <i class="fas fa-cogs me-2"></i>System Settings
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Settings Content -->
        <div class="col-lg-9">
            <div class="tab-content" id="v-pills-tabContent">
                
                <!-- Camera Settings -->
                <div class="tab-pane fade show active" id="v-pills-camera" role="tabpanel">
                    <div class="settings-section">
                        <h3 class="section-title">
                            <i class="fas fa-video me-2"></i>Camera Configuration
                        </h3>
                        
                        <form id="camera-form">
                            <div class="form-group">
                                <label for="camera-type" class="form-label">Camera Type</label>
                                <select class="form-select" id="camera-type" name="camera_type">
                                    <option value="video_file">Video File</option>
                                    <option value="usb">USB Camera</option>
                                    <option value="rtsp">RTSP Camera</option>
                                    <option value="onvif">ONVIF Camera</option>
                                </select>
                            </div>
                            
                            <!-- Video File Config -->
                            <div id="video-config" class="camera-config">
                                <div class="form-group">
                                    <label for="video-path" class="form-label">Video File Path</label>
                                    <input type="text" class="form-control" id="video-path" name="file_path" placeholder="/path/to/video.mp4">
                                </div>
                                <div class="form-group">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="video-loop" checked>
                                        <label class="form-check-label" for="video-loop">Loop Video</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- USB Config -->
                            <div id="usb-config" class="camera-config" style="display: none;">
                                <div class="form-group">
                                    <label for="usb-device" class="form-label">USB Device</label>
                                    <input type="text" class="form-control" id="usb-device" name="device" value="0" placeholder="0">
                                    <small class="form-text text-muted">Device index (0, 1, 2...) or path (/dev/video0)</small>
                                </div>
                            </div>
                            
                            <!-- RTSP Config -->
                            <div id="rtsp-config" class="camera-config" style="display: none;">
                                <div class="form-group">
                                    <label for="rtsp-url" class="form-label">RTSP URL</label>
                                    <input type="text" class="form-control" id="rtsp-url" name="url" placeholder="rtsp://username:password@192.168.1.100:554/stream">
                                </div>
                            </div>
                            
                            <!-- ONVIF Config -->
                            <div id="onvif-config" class="camera-config" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="onvif-host" class="form-label">Camera IP</label>
                                            <input type="text" class="form-control" id="onvif-host" name="host" placeholder="192.168.1.100">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="onvif-port" class="form-label">Port</label>
                                            <input type="number" class="form-control" id="onvif-port" name="port" value="80">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="onvif-username" class="form-label">Username</label>
                                            <input type="text" class="form-control" id="onvif-username" name="username" placeholder="admin">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="onvif-password" class="form-label">Password</label>
                                            <input type="password" class="form-control" id="onvif-password" name="password">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 2rem;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Camera Settings
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" id="test-camera">
                                    <i class="fas fa-play me-2"></i>Test Camera
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Detection Settings -->
                <div class="tab-pane fade" id="v-pills-detection" role="tabpanel">
                    <div class="settings-section">
                        <h3 class="section-title">
                            <i class="fas fa-search me-2"></i>Detection Configuration
                        </h3>
                        
                        <form id="detection-form">
                            <div class="form-group">
                                <label for="detection-model" class="form-label">Detection Model</label>
                                <select class="form-select" id="detection-model">
                                    <option value="yolov8n.pt">YOLOv8 Nano (Faster)</option>
                                    <option value="yolov8s.pt">YOLOv8 Small (Balanced)</option>
                                    <option value="yolov8m.pt">YOLOv8 Medium (Accurate)</option>
                                    <option value="yolov8l.pt">YOLOv8 Large (High Accuracy)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="confidence-threshold" class="form-label">
                                    Confidence Threshold: <span id="confidence-value">0.5</span>
                                </label>
                                <input type="range" class="form-range" min="0.1" max="0.9" step="0.05" value="0.5" id="confidence-threshold">
                            </div>
                            
                            <div class="form-group">
                                <label for="iou-threshold" class="form-label">
                                    IoU Threshold: <span id="iou-value">0.45</span>
                                </label>
                                <input type="range" class="form-range" min="0.1" max="0.8" step="0.05" value="0.45" id="iou-threshold">
                            </div>
                            
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Detection Settings
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Tracking Settings -->
                <div class="tab-pane fade" id="v-pills-tracking" role="tabpanel">
                    <div class="settings-section">
                        <h3 class="section-title">
                            <i class="fas fa-route me-2"></i>Tracking Configuration
                        </h3>
                        
                        <form id="tracking-form">
                            <div class="form-group">
                                <label for="max-age" class="form-label">Max Age (frames)</label>
                                <input type="number" class="form-control" id="max-age" min="1" max="100" value="30">
                                <small class="form-text text-muted">Frames to keep tracking without detection</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="min-hits" class="form-label">Min Hits (frames)</label>
                                <input type="number" class="form-control" id="min-hits" min="1" max="20" value="3">
                                <small class="form-text text-muted">Minimum detections to confirm track</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="tracking-iou" class="form-label">
                                    Tracking IoU: <span id="tracking-iou-value">0.3</span>
                                </label>
                                <input type="range" class="form-range" min="0.1" max="0.7" step="0.05" value="0.3" id="tracking-iou">
                            </div>
                            
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Tracking Settings
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Analysis Settings -->
                <div class="tab-pane fade" id="v-pills-analysis" role="tabpanel">
                    <div class="settings-section">
                        <h3 class="section-title">
                            <i class="fas fa-chart-line me-2"></i>Analysis Configuration
                        </h3>
                        
                        <form id="analysis-form">
                            <div class="form-group">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="demographics-enabled" checked>
                                    <label class="form-check-label" for="demographics-enabled">
                                        Enable Demographics Analysis
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="demographics-model" class="form-label">Demographics Model</label>
                                <select class="form-select" id="demographics-model">
                                    <option value="deepface">DeepFace (Better compatibility)</option>
                                    <option value="insightface">InsightFace (Better accuracy)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="dwell-enabled" checked>
                                    <label class="form-check-label" for="dwell-enabled">
                                        Enable Dwell Time Analysis
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="min-duration" class="form-label">Minimum Dwell Duration (seconds)</label>
                                <input type="number" class="form-control" id="min-duration" min="1" max="60" value="5">
                            </div>
                            
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Analysis Settings
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Database Management -->
                <div class="tab-pane fade" id="v-pills-database" role="tabpanel">
                    <div class="settings-section">
                        <h3 class="section-title">
                            <i class="fas fa-database me-2"></i>Database Management
                        </h3>
                        
                        <!-- Admin Only Data Management -->
                        <div class="admin-only-section" id="data-management-section">
                            <div class="d-flex align-items-center mb-3">
                                <h5 class="mb-0 me-2">Data Management</h5>
                                <span class="admin-badge">
                                    <i class="fas fa-shield-alt me-1"></i>Admin Only
                                </span>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Warning:</strong> These operations will permanently modify your database. Please ensure you have a backup before proceeding.
                            </div>
                            
                            <div class="data-management-buttons">
                                <button type="button" class="btn btn-success" id="insert-initial-data-btn">
                                    <i class="fas fa-database me-2"></i>Add Initial Data
                                </button>
                                <button type="button" class="btn btn-danger" id="clear-all-data-btn">
                                    <i class="fas fa-trash-alt me-2"></i>Clear All Data
                                </button>
                            </div>
                            
                            <div id="data-management-feedback" class="mt-3"></div>
                        </div>
                        
                        <!-- Non-Admin Notice -->
                        <div class="alert alert-info" id="non-admin-notice" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Info:</strong> Data management features are only available to administrators. Contact your system administrator for access.
                        </div>
                        
                        <!-- Database Info -->
                        <div class="mt-4">
                            <h5>Database Information</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Database Type</label>
                                        <input type="text" class="form-control" value="SQLite" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Database Path</label>
                                        <input type="text" class="form-control" id="db-path" value="reviision.db" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- System Settings -->
                <div class="tab-pane fade" id="v-pills-system" role="tabpanel">
                    <div class="settings-section">
                        <h3 class="section-title">
                            <i class="fas fa-cogs me-2"></i>System Configuration
                        </h3>
                        
                        <form id="system-form">
                            <div class="form-group">
                                <label for="web-host" class="form-label">Web Host</label>
                                <input type="text" class="form-control" id="web-host" value="0.0.0.0">
                                <small class="form-text text-muted">0.0.0.0 for all interfaces, 127.0.0.1 for localhost only</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="web-port" class="form-label">Web Port</label>
                                <input type="number" class="form-control" id="web-port" value="5000" min="1" max="65535">
                                <small class="form-text text-muted">Port for web server (requires restart)</small>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="debug-mode">
                                    <label class="form-check-label" for="debug-mode">
                                        Debug Mode
                                    </label>
                                </div>
                                <small class="form-text text-muted">Enable for development (disable in production)</small>
                            </div>
                            
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save System Settings
                                </button>
                                <button type="button" class="btn btn-warning ms-2" id="restart-system">
                                    <i class="fas fa-redo me-2"></i>Restart System
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize page
    loadCurrentSettings();
    setupEventHandlers();
    checkUserRole();
    
    // Camera type selection handler
    document.getElementById('camera-type').addEventListener('change', function() {
        showCameraConfig(this.value);
    });
    
    // Range input updates
    setupRangeInputs();
});

function showCameraConfig(type) {
    // Hide all configs
    document.querySelectorAll('.camera-config').forEach(config => {
        config.style.display = 'none';
    });
    
    // Show selected config
    const configMap = {
        'video_file': 'video-config',
        'usb': 'usb-config', 
        'rtsp': 'rtsp-config',
        'onvif': 'onvif-config'
    };
    
    if (configMap[type]) {
        document.getElementById(configMap[type]).style.display = 'block';
    }
}

function setupRangeInputs() {
    const ranges = [
        { input: 'confidence-threshold', output: 'confidence-value' },
        { input: 'iou-threshold', output: 'iou-value' },
        { input: 'tracking-iou', output: 'tracking-iou-value' }
    ];
    
    ranges.forEach(range => {
        const input = document.getElementById(range.input);
        const output = document.getElementById(range.output);
        if (input && output) {
            input.addEventListener('input', function() {
                output.textContent = this.value;
            });
        }
    });
}

function setupEventHandlers() {
    // Form submissions
    document.getElementById('camera-form').addEventListener('submit', saveCameraSettings);
    document.getElementById('detection-form').addEventListener('submit', saveDetectionSettings);
    document.getElementById('tracking-form').addEventListener('submit', saveTrackingSettings);
    document.getElementById('analysis-form').addEventListener('submit', saveAnalysisSettings);
    document.getElementById('system-form').addEventListener('submit', saveSystemSettings);
    
    // Data management buttons
    document.getElementById('insert-initial-data-btn').addEventListener('click', insertInitialData);
    document.getElementById('clear-all-data-btn').addEventListener('click', clearAllData);
    
    // Test camera button
    document.getElementById('test-camera').addEventListener('click', testCamera);
}

async function loadCurrentSettings() {
    try {
        const response = await fetch('/api/config');
        if (response.ok) {
            const result = await response.json();
            if (result.status === 'success') {
                populateSettingsFromConfig(result.config);
            }
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

function populateSettingsFromConfig(config) {
    // Camera settings
    if (config.camera) {
        const camera = config.camera;
        document.getElementById('camera-type').value = camera.type || 'video_file';
        showCameraConfig(camera.type || 'video_file');
        
        if (camera.file_path) document.getElementById('video-path').value = camera.file_path;
        if (camera.device !== undefined) document.getElementById('usb-device').value = camera.device;
        if (camera.url) {
            document.getElementById('rtsp-url').value = camera.url;
        }
        if (camera.host) document.getElementById('onvif-host').value = camera.host;
        if (camera.port) document.getElementById('onvif-port').value = camera.port;
        if (camera.username) document.getElementById('onvif-username').value = camera.username;
        if (camera.loop !== undefined) document.getElementById('video-loop').checked = camera.loop;
    }
    
    // Detection settings
    if (config.detection) {
        const detection = config.detection;
        if (detection.model) document.getElementById('detection-model').value = detection.model;
        if (detection.confidence_threshold !== undefined) {
            document.getElementById('confidence-threshold').value = detection.confidence_threshold;
            document.getElementById('confidence-value').textContent = detection.confidence_threshold;
        }
        if (detection.iou_threshold !== undefined) {
            document.getElementById('iou-threshold').value = detection.iou_threshold;
            document.getElementById('iou-value').textContent = detection.iou_threshold;
        }
    }
    
    // Tracking settings
    if (config.tracking) {
        const tracking = config.tracking;
        if (tracking.max_age) document.getElementById('max-age').value = tracking.max_age;
        if (tracking.min_hits) document.getElementById('min-hits').value = tracking.min_hits;
        if (tracking.iou_threshold !== undefined) {
            document.getElementById('tracking-iou').value = tracking.iou_threshold;
            document.getElementById('tracking-iou-value').textContent = tracking.iou_threshold;
        }
    }
    
    // Analysis settings
    if (config.analysis) {
        const analysis = config.analysis;
        if (analysis.demographics) {
            document.getElementById('demographics-enabled').checked = analysis.demographics.enabled !== false;
            if (analysis.demographics.model) document.getElementById('demographics-model').value = analysis.demographics.model;
        }
        if (analysis.dwell_time) {
            document.getElementById('dwell-enabled').checked = analysis.dwell_time.enabled !== false;
            if (analysis.dwell_time.min_duration) document.getElementById('min-duration').value = analysis.dwell_time.min_duration;
        }
    }
    
    // System settings
    if (config.web) {
        const web = config.web;
        if (web.host) document.getElementById('web-host').value = web.host;
        if (web.port) document.getElementById('web-port').value = web.port;
        if (web.debug !== undefined) document.getElementById('debug-mode').checked = web.debug;
    }
    
    // Database settings
    if (config.database && config.database.path) {
        document.getElementById('db-path').value = config.database.path;
    }
}

async function checkUserRole() {
    try {
        const response = await fetch('/api/auth/user-info');
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.user && result.user.role === 'admin') {
                document.getElementById('data-management-section').style.display = 'block';
                document.getElementById('non-admin-notice').style.display = 'none';
            } else {
                document.getElementById('data-management-section').style.display = 'none';
                document.getElementById('non-admin-notice').style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Error checking user role:', error);
        document.getElementById('data-management-section').style.display = 'none';
        document.getElementById('non-admin-notice').style.display = 'block';
    }
}

// Save functions
async function saveCameraSettings(e) {
    e.preventDefault();
    await saveSettings('camera', getCameraFormData());
}

async function saveDetectionSettings(e) {
    e.preventDefault();
    await saveSettings('detection', getDetectionFormData());
}

async function saveTrackingSettings(e) {
    e.preventDefault();
    await saveSettings('tracking', getTrackingFormData());
}

async function saveAnalysisSettings(e) {
    e.preventDefault();
    await saveSettings('analysis', getAnalysisFormData());
}

async function saveSystemSettings(e) {
    e.preventDefault();
    await saveSettings('web', getSystemFormData());
}

function getCameraFormData() {
    const type = document.getElementById('camera-type').value;
    const data = { type };
    
    switch(type) {
        case 'video_file':
            data.file_path = document.getElementById('video-path').value;
            data.loop = document.getElementById('video-loop').checked;
            break;
        case 'usb':
            data.device = document.getElementById('usb-device').value;
            break;
        case 'rtsp':
            data.url = document.getElementById('rtsp-url').value;
            break;
        case 'onvif':
            data.host = document.getElementById('onvif-host').value;
            data.port = parseInt(document.getElementById('onvif-port').value);
            data.username = document.getElementById('onvif-username').value;
            data.password = document.getElementById('onvif-password').value;
            break;
    }
    
    return data;
}

function getDetectionFormData() {
    return {
        model: document.getElementById('detection-model').value,
        confidence_threshold: parseFloat(document.getElementById('confidence-threshold').value),
        iou_threshold: parseFloat(document.getElementById('iou-threshold').value)
    };
}

function getTrackingFormData() {
    return {
        max_age: parseInt(document.getElementById('max-age').value),
        min_hits: parseInt(document.getElementById('min-hits').value),
        iou_threshold: parseFloat(document.getElementById('tracking-iou').value)
    };
}

function getAnalysisFormData() {
    return {
        demographics: {
            enabled: document.getElementById('demographics-enabled').checked,
            model: document.getElementById('demographics-model').value
        },
        dwell_time: {
            enabled: document.getElementById('dwell-enabled').checked,
            min_duration: parseInt(document.getElementById('min-duration').value)
        }
    };
}

function getSystemFormData() {
    return {
        host: document.getElementById('web-host').value,
        port: parseInt(document.getElementById('web-port').value),
        debug: document.getElementById('debug-mode').checked
    };
}

async function saveSettings(section, data) {
    try {
        showToast('info', `Saving ${section} settings...`);
        
        const response = await fetch('/api/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                section: section,
                config: data
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showToast('success', `${section} settings saved successfully!`);
        } else {
            showToast('error', `Failed to save ${section} settings: ${result.message}`);
        }
    } catch (error) {
        showToast('error', `Error saving ${section} settings: ${error.message}`);
    }
}

async function insertInitialData() {
    if (!confirm('This will insert default users and sample data. Continue?')) return;
    
    const btn = document.getElementById('insert-initial-data-btn');
    const feedback = document.getElementById('data-management-feedback');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Inserting...';
    feedback.innerHTML = '';
    
    try {
        const response = await fetch('/api/insert_initial_data', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            feedback.innerHTML = `
                <div class="modern-card">
                    <div class="modern-card-header green">
                        <i class="fas fa-check-circle"></i>
                        Success
                    </div>
                    <div class="modern-card-body">
                        <p class="mb-0">${result.message}</p>
                    </div>
                </div>
            `;
            showToast('success', 'Initial data inserted successfully!');
        } else {
            feedback.innerHTML = `
                <div class="modern-card">
                    <div class="modern-card-header red">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error
                    </div>
                    <div class="modern-card-body">
                        <p class="mb-0">${result.message}</p>
                    </div>
                </div>
            `;
            showToast('error', 'Failed to insert initial data');
        }
    } catch (error) {
        feedback.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
        showToast('error', 'Error inserting initial data');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-database me-2"></i>Add Initial Data';
    }
}

async function clearAllData() {
    if (!confirm('This will permanently delete all analytics data (except admin user). This cannot be undone! Continue?')) return;
    if (!confirm('Are you absolutely sure? This will clear all customer data, demographics, and analytics records.')) return;
    
    const btn = document.getElementById('clear-all-data-btn');
    const feedback = document.getElementById('data-management-feedback');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Clearing...';
    feedback.innerHTML = '';
    
    try {
        const response = await fetch('/api/clear_all_data', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            feedback.innerHTML = `
                <div class="modern-card">
                    <div class="modern-card-header green">
                        <i class="fas fa-check-circle"></i>
                        Success
                    </div>
                    <div class="modern-card-body">
                        <p class="mb-0">${result.message}</p>
                    </div>
                </div>
            `;
            showToast('success', 'All data cleared successfully!');
        } else {
            feedback.innerHTML = `
                <div class="modern-card">
                    <div class="modern-card-header red">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error
                    </div>
                    <div class="modern-card-body">
                        <p class="mb-0">${result.message}</p>
                    </div>
                </div>
            `;
            showToast('error', 'Failed to clear data');
        }
    } catch (error) {
        feedback.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
        showToast('error', 'Error clearing data');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Clear All Data';
    }
}

async function testCamera() {
    const btn = document.getElementById('test-camera');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
    
    try {
        // This would test the camera configuration
        // For now, just show a success message
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play me-2"></i>Test Camera';
            showToast('success', 'Camera test completed!');
        }, 2000);
    } catch (error) {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play me-2"></i>Test Camera';
        showToast('error', 'Camera test failed');
    }
}

function showToast(type, message) {
    // Create a simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}
</script>
{% endblock %}
