{% extends "base.html" %}

{% block title %}Dashboard - ReViision{% endblock %}

{% block header %}Dashboard Overview{% endblock %}

{% block content %}
<!-- Statistics Cards Row -->
<div class="row mb-4 stats-grid">
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-3" style="color: #3498db;"></i>
                <div class="stat-value" id="total-visitors">--</div>
                <div class="stat-label">Total Visitors</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-3" style="color: #e74c3c;"></i>
                <div class="stat-value" id="avg-dwell-time">--</div>
                <div class="stat-label">Avg. Dwell Time (min)</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-percentage fa-2x mb-3" style="color: #2ecc71;"></i>
                <div class="stat-value" id="conversion-rate">--</div>
                <div class="stat-label">Conversion Rate</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-venus-mars fa-2x mb-3" style="color: #9b59b6;"></i>
                <div class="stat-value" id="gender-ratio">--</div>
                <div class="stat-label">M/F Ratio</div>
            </div>
        </div>
    </div>
</div>

<!-- Traffic Chart Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Store Traffic Over Time</h3>
                <div class="tooltip">
                    <i class="fas fa-info-circle"></i>
                    <span class="tooltip-text">Shows visitor count over time period</span>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Demographics Chart Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Demographic Breakdown</h3>
                <div class="tooltip">
                    <i class="fas fa-info-circle"></i>
                    <span class="tooltip-text">Customer demographics analysis</span>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="ageChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Camera Analysis Row -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Live Camera Analysis</h3>
                <div class="tooltip">
                    <i class="fas fa-info-circle"></i>
                    <span class="tooltip-text">Real-time camera feed with analytics overlays</span>
                </div>
            </div>
            <div class="card-body">
                <div id="cameraPreview" class="video-container">
                    <!-- Main analysed feed -->
                    <div id="analysedFeed" class="main-video">
                        <div class="video-overlay">
                            <div class="overlay-info">
                                <span class="camera-label">Main Entrance - Analysed Feed</span>
                                <span class="status-indicator" id="feed-status">
                                    <i class="fas fa-circle" id="status-icon"></i> <span id="status-text">Stopped</span>
                                </span>
                            </div>
                        </div>
                        <div class="placeholder-content">
                            <i class="fas fa-eye fa-3x mb-3"></i>
                            <h5 id="feed-title">Camera Analysis Paused</h5>
                            <p class="text-muted" id="feed-description">Click Start to begin analysing the camera feed</p>
                            <div class="detection-stats mt-3">
                                <span class="badge bg-primary me-2">People: <span id="people-count">0</span></span>
                                <span class="badge bg-success me-2">Active Tracks: <span id="active-tracks">0</span></span>
                                <span class="badge bg-info">FPS: <span id="fps-counter">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <div class="feed-controls">
                        <button class="btn btn-success me-2" id="startFeedBtn" onclick="startAnalysisFeed()">
                            <i class="fas fa-play"></i> Start Analysis
                        </button>
                        <button class="btn btn-warning me-2" id="stopFeedBtn" onclick="stopAnalysisFeed()" disabled>
                            <i class="fas fa-pause"></i> Stop Analysis
                        </button>
                    </div>
                    <a href="/analysis" class="btn btn-primary">
                        <i class="fas fa-chart-line me-2"></i>View Detailed Analysis
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ====================================
    // Dashboard Page JavaScript
    // ====================================

    /**
     * Initialize dashboard when DOM is loaded
     */
    document.addEventListener('DOMContentLoaded', function() {
        fetchDashboardData();
        initializeFeedControls();
    });

    /**
     * Fetch and display dashboard data
     */
    function fetchDashboardData() {
        // Simulate data fetch for dashboard
        setTimeout(() => {
            updateDashboardStats({
                totalVisitors: 2456,
                avgDwellTime: 15.3,
                conversionRate: 34.5,
                genderRatio: "55/45"
            });
            createTrafficChart();
            createDemographicCharts();
        }, 300);
    }

    /**
     * Update dashboard statistics cards
     */
    function updateDashboardStats(data) {
        document.getElementById('total-visitors').textContent = data.totalVisitors.toLocaleString();
        document.getElementById('avg-dwell-time').textContent = data.avgDwellTime;
        document.getElementById('conversion-rate').textContent = data.conversionRate + '%';
        document.getElementById('gender-ratio').textContent = data.genderRatio;
    }

    /**
     * Create the main traffic chart
     */
    function createTrafficChart() {
        const ctx = document.getElementById('trafficChart').getContext('2d');
        
        // Generate sample data for the last 24 hours
        const labels = [];
        const data = [];
        
        const now = new Date();
        for (let i = 23; i >= 0; i--) {
            const time = new Date(now.getTime() - i * 60 * 60 * 1000);
            labels.push(time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            
            // Generate realistic traffic data with business hour patterns
            const hour = time.getHours();
            let baseTraffic = 5;
            if (hour >= 9 && hour <= 17) {
                baseTraffic = 25;
            } else if (hour >= 18 && hour <= 21) {
                baseTraffic = 15;
            }
            data.push(Math.floor(Math.random() * 20) + baseTraffic);
        }
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: data,
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: 'rgba(52, 152, 219, 1)',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                }
            }
        });
    }

    /**
     * Create demographic distribution charts
     */
    function createDemographicCharts() {
        // Age Distribution Pie Chart
        const ageCtx = document.getElementById('ageChart').getContext('2d');
        new Chart(ageCtx, {
            type: 'pie',
            data: {
                labels: ['18-24', '25-34', '35-44', '45-54', '55+'],
                datasets: [{
                    data: [15, 30, 25, 18, 12],
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(155, 89, 182, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(230, 126, 34, 0.7)'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    title: {
                        display: true,
                        text: 'Age Distribution'
                    }
                }
            }
        });
        
        // Gender Distribution Doughnut Chart
        const genderCtx = document.getElementById('genderChart').getContext('2d');
        new Chart(genderCtx, {
            type: 'doughnut',
            data: {
                labels: ['Male', 'Female'],
                datasets: [{
                    data: [55, 45],
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(231, 76, 60, 0.7)'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    title: {
                        display: true,
                        text: 'Gender Distribution'
                    }
                }
            }
        });
    }

    // ====================================
    // Analysis Feed Control Functions
    // ====================================

    let isAnalysisFeedRunning = false;
    let analysisInterval = null;

    /**
     * Initialize feed control state
     */
    function initializeFeedControls() {
        updateFeedStatus(false);
    }

    /**
     * Start the analysis feed simulation
     */
    function startAnalysisFeed() {
        if (isAnalysisFeedRunning) return;
        
        isAnalysisFeedRunning = true;
        updateFeedStatus(true);
        
        // Start simulated analysis with updates every 2 seconds
        simulateAnalysis();
        analysisInterval = setInterval(simulateAnalysis, 2000);
        
        // Update button states
        document.getElementById('startFeedBtn').disabled = true;
        document.getElementById('stopFeedBtn').disabled = false;
    }

    /**
     * Stop the analysis feed simulation
     */
    function stopAnalysisFeed() {
        if (!isAnalysisFeedRunning) return;
        
        isAnalysisFeedRunning = false;
        updateFeedStatus(false);
        
        // Stop analysis simulation
        if (analysisInterval) {
            clearInterval(analysisInterval);
            analysisInterval = null;
        }
        
        // Reset statistics display
        document.getElementById('people-count').textContent = '0';
        document.getElementById('active-tracks').textContent = '0';
        document.getElementById('fps-counter').textContent = '0';
        
        // Update button states
        document.getElementById('startFeedBtn').disabled = false;
        document.getElementById('stopFeedBtn').disabled = true;
    }

    /**
     * Update feed status indicators
     */
    function updateFeedStatus(isRunning) {
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');
        const feedTitle = document.getElementById('feed-title');
        const feedDescription = document.getElementById('feed-description');
        
        if (isRunning) {
            statusIcon.className = 'fas fa-circle text-success';
            statusText.textContent = 'Running';
            feedTitle.textContent = 'Camera Analysis Active';
            feedDescription.textContent = 'Analysing live camera feed and detecting people';
        } else {
            statusIcon.className = 'fas fa-circle text-danger';
            statusText.textContent = 'Stopped';
            feedTitle.textContent = 'Camera Analysis Paused';
            feedDescription.textContent = 'Click Start to begin analysing the camera feed';
        }
    }

    /**
     * Simulate real-time analysis data
     */
    function simulateAnalysis() {
        if (!isAnalysisFeedRunning) return;
        
        // Generate realistic simulation data
        const peopleCount = Math.floor(Math.random() * 8) + 1;
        const activeTracks = Math.floor(Math.random() * peopleCount) + 1;
        const fps = Math.floor(Math.random() * 5) + 28; // 28-32 FPS range
        
        // Update statistics display
        document.getElementById('people-count').textContent = peopleCount;
        document.getElementById('active-tracks').textContent = activeTracks;
        document.getElementById('fps-counter').textContent = fps;
    }
</script>
{% endblock %} 