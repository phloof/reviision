{% extends "base.html" %}

{% block title %}Dashboard - ReViision{% endblock %}

{% block header %}Dashboard Overview{% endblock %}

{% block styles %}
<style>
    /* Reuse demographics selector styling */
    .demographics-nav {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .form-select {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
    }

    /* Chart title clickable styling */
    .card-title.clickable-section {
        transition: all 0.2s ease;
        border-radius: 4px;
        padding: 4px 8px;
        margin: -4px -8px;
    }

    .card-title.clickable-section:hover {
        background-color: rgba(0, 0, 0, 0.05);
        transform: translateY(-1px);
    }

    .card-header-success .card-title.clickable-section:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    /* Dashboard stats grid - match demographics page sizing */
    .dashboard-stats-container {
        width: 100%;
        padding: 0;
        margin: 0 auto 1.5rem auto;
    }

    .dashboard-stats-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        width: 100%;
    }

    /* Mobile - 1 column */
    @media (min-width: 576px) {
        .dashboard-stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }
    }

    /* Desktop - match demographics page */
    @media (min-width: 992px) {
        .dashboard-stats-container {
            padding: 0;
            margin: 0 auto 2rem auto;
        }

        .dashboard-stats-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
        }

        .stat-card {
            min-height: 180px;
            display: flex;
            align-items: center;
        }

        .stat-card .card-body {
            width: 100%;
        }
    }

    /* Large desktop - match demographics page */
    @media (min-width: 1200px) {
        .dashboard-stats-container {
            margin: 0 auto 2.5rem auto;
        }

        .dashboard-stats-grid {
            gap: 2.5rem;
        }

        .stat-card {
            min-height: 200px;
        }
    }

    /* Dashboard charts grid - match demographics page sizing */
    .dashboard-charts-container {
        width: 100%;
        padding: 0;
        margin: 0 auto;
    }

    .dashboard-charts-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        width: 100%;
    }

    /* Mobile - 1 column */
    @media (min-width: 768px) {
        .dashboard-charts-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }
    }

    /* Desktop - match demographics page */
    @media (min-width: 992px) {
        .dashboard-charts-container {
            padding: 0;
        }

        .dashboard-charts-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }
    }

    /* Large desktop - match demographics page */
    @media (min-width: 1200px) {
        .dashboard-charts-grid {
            gap: 2.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-responsive py-6">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-primary mb-2">Dashboard Overview</h1>
        <p class="text-secondary">Real-time analytics and insights for your retail space</p>
    </div>

    <!-- Stats Grid -->
    {% set stats = [
        {'icon':'users','label':'Total Visitors','id':'total-visitors','variant':'primary'},
        {'icon':'clock','label':'Avg. Dwell Time','id':'avg-dwell-time','variant':'danger'},
        {'icon':'percentage','label':'Conversion Rate','id':'conversion-rate','variant':'success'},
        {'icon':'venus-mars','label':'M/F Ratio','id':'gender-ratio','variant':'warning'}
    ] %}

    <div class="dashboard-stats-container mb-8">
        <div class="dashboard-stats-grid">
            {% for stat in stats %}
            <div class="card stat-card hover:shadow-lg transition-all animate-fade-in">
                <div class="card-body text-center p-6">
                    <div class="mb-4">
                        {% if stat.id == 'total-visitors' %}
                            <i class="fas fa-{{ stat.icon }} text-4xl" style="color: black;"></i>
                        {% else %}
                            <i class="fas fa-{{ stat.icon }} text-4xl text-{{ stat.variant }}"></i>
                        {% endif %}
                    </div>
                    <div class="text-3xl font-bold text-primary mb-2" id="{{ stat.id }}">
                        <span class="animate-pulse">--</span>
                    </div>
                    <div class="text-sm font-medium text-secondary uppercase tracking-wide">
                        {{ stat.label }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Controls Section -->
    <div class="card mb-8">
        <div class="card-header card-header-primary">
            <h2 class="card-title">
                <i class="fas fa-sliders-h"></i>
                Data Controls
            </h2>
        </div>
        <div class="card-body">
            <div class="d-grid grid-cols-1 tablet-grid-cols-2 desktop-grid-cols-4 gap-4">
                <div class="form-group">
                    <label for="time-range" class="form-label">Time Range</label>
                    <select class="form-control" id="time-range">
                        <option value="1h">Last Hour</option>
                        <option value="6h">Last 6 Hours</option>
                        <option value="24h" selected>Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="age-filter" class="form-label">Age Group</label>
                    <select class="form-control" id="age-filter">
                        <option value="all">All Ages</option>
                        <option value="child">Children (0-12)</option>
                        <option value="teen">Teenagers (13-19)</option>
                        <option value="adult">Adults (20-64)</option>
                        <option value="senior">Seniors (65+)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="gender-filter" class="form-label">Gender</label>
                    <select class="form-control" id="gender-filter">
                        <option value="all">All Genders</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="form-group d-flex items-end">
                    <button class="btn btn-primary w-full" id="refreshButton">
                        <i class="fas fa-search"></i>
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="dashboard-charts-container mb-8">
        <div class="dashboard-charts-grid">
        <!-- Traffic Chart -->
        <div class="card chart-card hover:shadow-lg transition-all">
            <div class="card-header" style="background: white; color: black; border-bottom: 1px solid var(--color-border-primary);">
                <h3 class="card-title cursor-pointer clickable-section" style="color: black;"
                    role="link" tabindex="0" data-href="{{ url_for('web.historical') }}">
                    <i class="fas fa-chart-line" style="color: black;"></i>
                    Store Traffic
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Demographics Chart -->
        <div class="card chart-card hover:shadow-lg transition-all">
            <div class="card-header card-header-success">
                <h3 class="card-title cursor-pointer clickable-section"
                    role="link" tabindex="0" data-href="{{ url_for('web.demographics') }}">
                    <i class="fas fa-users"></i>
                    Demographics
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="demographicsChart"></canvas>
                </div>
            </div>
        </div>
        </div>
    </div>
    <!-- Additional Analytics -->
    <div class="dashboard-charts-container mb-8">
        <div class="dashboard-charts-grid">
        <!-- Age Distribution -->
        <div class="card chart-card">
            <div class="card-header card-header-warning">
                <h3 class="card-title">
                    <i class="fas fa-birthday-cake"></i>
                    Age Distribution
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Gender Distribution -->
        <div class="card chart-card">
            <div class="card-header card-header-danger">
                <h3 class="card-title">
                    <i class="fas fa-venus-mars"></i>
                    Gender Distribution
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card mt-8">
        <div class="card-header card-header-primary">
            <h3 class="card-title">
                <i class="fas fa-bolt"></i>
                Quick Actions
            </h3>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-3">
                <a href="{{ url_for('web.analysis') }}" class="btn btn-primary">
                    <i class="fas fa-video"></i>
                    Live Analysis
                </a>
                <a href="{{ url_for('web.demographics') }}" class="btn btn-secondary">
                    <i class="fas fa-chart-pie"></i>
                    Demographics
                </a>
                <a href="{{ url_for('web.historical') }}" class="btn btn-secondary">
                    <i class="fas fa-history"></i>
                    Historical Data
                </a>
                <a href="{{ url_for('web.settings') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ===== Dashboard Logic with Enhanced Filtering =====
const api = {
    summary: (params) => `/api/analytics/summary?${new URLSearchParams(params).toString()}`,
    traffic: (params) => `/api/analytics/traffic?${new URLSearchParams(params).toString()}`
};

// Chart instances to allow destroy/redraw
let trafficChartInstance, demographicsChartInstance, ageChartInstance, genderChartInstance;

function getFilterParams() {
    const timeMap = { '1h': 1, '6h': 6, '24h': 24, '7d': 168, '30d': 720 };
    const timeRange = document.getElementById('time-range').value || '24h';
    const ageFilter = document.getElementById('age-filter').value || 'all';
    const genderFilter = document.getElementById('gender-filter').value || 'all';

    const params = {
        hours: timeMap[timeRange] || 24
    };

    if (ageFilter !== 'all') {
        params.age_filter = ageFilter;
    }

    if (genderFilter !== 'all') {
        params.gender_filter = genderFilter;
    }

    return params;
}

function getHours() {
    const map = { '1h': 1, '6h': 6, '24h': 24, '7d': 168, '30d': 720 };
    const range = document.getElementById('time-range').value || '24h';
    return map[range] || 24;
}

async function refreshDashboard() {
    const filterParams = getFilterParams();

    // Show loading state
    showLoadingState();

    try {
        const [summaryRes, trafficRes] = await Promise.all([
            fetch(api.summary(filterParams), {
                method: 'GET',
                credentials: 'same-origin',
                headers: { 'Accept': 'application/json' }
            }).then(async r => {
                if (r.status === 401 || r.status === 403) {
                    window.location.href = '/login';
                    return { success: false };
                }
                const contentType = r.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    window.location.href = '/login';
                    return { success: false };
                }
                return r.json();
            }).catch(() => ({ success: false })),
            fetch(api.traffic(filterParams), {
                method: 'GET',
                credentials: 'same-origin',
                headers: { 'Accept': 'application/json' }
            }).then(async r => {
                if (r.status === 401 || r.status === 403) {
                    window.location.href = '/login';
                    return { success: false };
                }
                const contentType = r.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    window.location.href = '/login';
                    return { success: false };
                }
                return r.json();
            }).catch(() => ({ success: false }))
        ]);

        // Update stat cards
        if (summaryRes.success) {
            document.getElementById('total-visitors').textContent = (summaryRes.total_visitors||0).toLocaleString();
            document.getElementById('avg-dwell-time').textContent = summaryRes.avg_dwell_time || '--';
            document.getElementById('conversion-rate').textContent = summaryRes.conversion_rate ? summaryRes.conversion_rate+'%' : '--';
            document.getElementById('gender-ratio').textContent = summaryRes.gender_ratio || '--';
            drawDemographics(summaryRes.age_groups || {}, summaryRes.gender_distribution || {});
            drawAge(summaryRes.age_groups || {});
            drawGender(summaryRes.gender_distribution || {});
        }
        drawTraffic(trafficRes);

        // Show success notification
        showNotification('Data updated successfully', 'success');
    } catch (error) {
        console.error('Error refreshing dashboard:', error);
        showNotification('Error loading data. Please try again.', 'error');
    } finally {
        hideLoadingState();
    }
}

function showLoadingState() {
    const button = document.getElementById('refreshButton');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
}

function hideLoadingState() {
    const button = document.getElementById('refreshButton');
    button.disabled = false;
    button.innerHTML = '<i class="fas fa-search"></i> Apply Filters';
}

function drawTraffic(res){
    const ctx = document.getElementById('trafficChart');
    if (trafficChartInstance) trafficChartInstance.destroy();
    const labels = res.success? res.labels : Array(24).fill('');
    const data = res.success? res.data : Array(24).fill(0);
    const config={
        type:'line',
        data:{labels,datasets:[{label:'Visitors',data,borderColor:'#3498db',backgroundColor:'rgba(52,152,219,.15)',tension:.4}]},
        options:{responsive:true,maintainAspectRatio:false}
    };
    trafficChartInstance = new ChartManager(ctx,config,{filename:'traffic_overview'});
    attachToolbar('trafficChart',trafficChartInstance);
}
function drawDemographics(ageData,genderData){
    const demographicsCanvas = document.getElementById('demographicsChart');
    if(!demographicsCanvas) return;

    if(demographicsChartInstance) demographicsChartInstance.destroy();

    // Create a combined demographics chart showing both age and gender data
    const hasAgeData = ageData && Object.keys(ageData).length > 0;
    const hasGenderData = genderData && Object.keys(genderData).length > 0;

    if (!hasAgeData && !hasGenderData) {
        // Show no data message
        const ctx = demographicsCanvas.getContext('2d');
        ctx.clearRect(0, 0, demographicsCanvas.width, demographicsCanvas.height);
        ctx.font = '16px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('No demographic data available', demographicsCanvas.width/2, demographicsCanvas.height/2);
        return;
    }

    // Use age data for the main chart, or gender data if age data is not available
    const chartData = hasAgeData ? ageData : genderData;
    const chartType = hasAgeData ? 'bar' : 'doughnut';
    const chartLabel = hasAgeData ? 'Age Groups' : 'Gender Distribution';

    const demographicsCfg = {
        type: chartType,
        data: {
            labels: Object.keys(chartData),
            datasets: [{
                label: chartLabel,
                data: Object.values(chartData),
                backgroundColor: hasAgeData ? [
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(46, 204, 113, 0.8)',
                    'rgba(155, 89, 182, 0.8)',
                    'rgba(241, 196, 15, 0.8)',
                    'rgba(230, 126, 34, 0.8)',
                    'rgba(231, 76, 60, 0.8)'
                ] : ['#3498db', '#e74c3c', '#95a5a6'],
                borderColor: hasAgeData ? [
                    'rgba(52, 152, 219, 1)',
                    'rgba(46, 204, 113, 1)',
                    'rgba(155, 89, 182, 1)',
                    'rgba(241, 196, 15, 1)',
                    'rgba(230, 126, 34, 1)',
                    'rgba(231, 76, 60, 1)'
                ] : ['#3498db', '#e74c3c', '#95a5a6'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: !hasAgeData,
                    position: 'bottom'
                }
            },
            scales: hasAgeData ? {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Visitors'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Age Groups'
                    }
                }
            } : {}
        }
    };

    demographicsChartInstance = new ChartManager(demographicsCanvas, demographicsCfg, {filename: 'demographics_overview'});
    attachToolbar('demographicsChart', demographicsChartInstance);
}

function drawAge(ageData) {
    const ageCanvas = document.getElementById('ageChart');
    if (!ageCanvas) return;

    if (ageChartInstance) ageChartInstance.destroy();

    const hasData = ageData && Object.keys(ageData).length > 0;

    if (!hasData) {
        // Show no data message
        const ctx = ageCanvas.getContext('2d');
        ctx.clearRect(0, 0, ageCanvas.width, ageCanvas.height);
        ctx.font = '16px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('No age data available', ageCanvas.width/2, ageCanvas.height/2);
        return;
    }

    const ageConfig = {
        type: 'bar',
        data: {
            labels: Object.keys(ageData),
            datasets: [{
                label: 'Age Distribution',
                data: Object.values(ageData),
                backgroundColor: [
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(46, 204, 113, 0.8)',
                    'rgba(155, 89, 182, 0.8)',
                    'rgba(241, 196, 15, 0.8)',
                    'rgba(230, 126, 34, 0.8)',
                    'rgba(231, 76, 60, 0.8)',
                    'rgba(149, 165, 166, 0.8)'
                ],
                borderColor: [
                    'rgba(52, 152, 219, 1)',
                    'rgba(46, 204, 113, 1)',
                    'rgba(155, 89, 182, 1)',
                    'rgba(241, 196, 15, 1)',
                    'rgba(230, 126, 34, 1)',
                    'rgba(231, 76, 60, 1)',
                    'rgba(149, 165, 166, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Visitors'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Age Groups'
                    }
                }
            }
        }
    };

    ageChartInstance = new ChartManager(ageCanvas, ageConfig, {filename: 'age_distribution'});
    attachToolbar('ageChart', ageChartInstance);
}

function drawGender(genderData) {
    const genderCanvas = document.getElementById('genderChart');
    if (!genderCanvas) return;

    if (genderChartInstance) genderChartInstance.destroy();

    const hasData = genderData && Object.keys(genderData).length > 0;

    if (!hasData) {
        // Show no data message
        const ctx = genderCanvas.getContext('2d');
        ctx.clearRect(0, 0, genderCanvas.width, genderCanvas.height);
        ctx.font = '16px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('No gender data available', genderCanvas.width/2, genderCanvas.height/2);
        return;
    }

    // Normalize gender keys to handle both capitalized and lowercase
    const normalizedGenderData = {};
    Object.entries(genderData).forEach(([key, value]) => {
        const normalizedKey = key.charAt(0).toUpperCase() + key.slice(1).toLowerCase();
        normalizedGenderData[normalizedKey] = value;
    });

    const genderConfig = {
        type: 'doughnut',
        data: {
            labels: Object.keys(normalizedGenderData),
            datasets: [{
                label: 'Gender Distribution',
                data: Object.values(normalizedGenderData),
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    };

    genderChartInstance = new ChartManager(genderCanvas, genderConfig, {filename: 'gender_distribution'});
    attachToolbar('genderChart', genderChartInstance);
}

// Enhanced toolbar util with new controls and export dropdown
function attachToolbar(canvasId, chartManager){
    const canvas=document.getElementById(canvasId);
    if(!canvas) return;
    const container=canvas.closest('.chart-container');
    if(!container || container.querySelector('.chart-toolbar')) return;

    // Ensure container positioning for absolute toolbar
    if (getComputedStyle(container).position === 'static') {
        container.style.position = 'relative';
    }

    const tb=document.createElement('div');
    tb.className='chart-toolbar text-end mt-1';
    tb.innerHTML=`
        <button class="btn btn-sm btn-outline-secondary me-1" data-action="zoom-in" title="Zoom In"><i class="fas fa-search-plus"></i></button>
        <button class="btn btn-sm btn-outline-secondary me-1" data-action="zoom-out" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
        <button class="btn btn-sm btn-outline-secondary me-1" data-action="reset-zoom" title="Reset Zoom"><i class="fas fa-expand-arrows-alt"></i></button>
        <button class="btn btn-sm btn-outline-secondary me-1" data-action="toggle-pan" title="Enable Pan Mode"><i class="fas fa-hand-paper"></i></button>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Export Options">
                <i class="fas fa-download"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" data-action="png" href="#"><i class="fas fa-image me-2"></i>PNG Image</a></li>
                <li><a class="dropdown-item" data-action="csv" href="#"><i class="fas fa-file-csv me-2"></i>CSV Data</a></li>
                <li><a class="dropdown-item" data-action="json" href="#"><i class="fas fa-code me-2"></i>JSON Data</a></li>
            </ul>
        </div>
    `;
    container.appendChild(tb);

    tb.addEventListener('click',ev=>{
        const btn=ev.target.closest('[data-action]');
        if(!btn) return;

        ev.preventDefault();
        const act=btn.getAttribute('data-action');

        // Handle export actions
        if(act==='png') chartManager.exportPNG();
        else if(act==='csv') chartManager.exportCSV();
        else if(act==='json') chartManager.exportJSON();
        // Handle zoom actions
        else if(act==='zoom-in') chartManager.zoomIn();
        else if(act==='zoom-out') chartManager.zoomOut();
        else if(act==='reset-zoom') chartManager.resetZoom();
        // Handle pan toggle
        else if(act==='toggle-pan') chartManager.togglePan();
    });
}

document.addEventListener('DOMContentLoaded',()=>{
    // Event listeners for filter controls
    document.getElementById('refreshButton').addEventListener('click', refreshDashboard);
    document.getElementById('time-range').addEventListener('change', refreshDashboard);
    document.getElementById('age-filter').addEventListener('change', refreshDashboard);
    document.getElementById('gender-filter').addEventListener('change', refreshDashboard);

    // Set icon colours defined in data-color attrs
    document.querySelectorAll('i[data-color]').forEach(el=>{el.style.color=el.dataset.color;});

    // Initial load
    refreshDashboard();
});
</script>
<script>
// Make summary sections act as links when clicked or focused and Enter pressed
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.clickable-section').forEach(sec => {
        const go = () => window.location.href = sec.dataset.href;
        sec.addEventListener('click', go);
        sec.addEventListener('keypress', e => { if (e.key === 'Enter') go(); });
    });
});
</script>
{% endblock %}
