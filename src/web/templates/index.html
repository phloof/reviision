{% extends "base.html" %}

{% block title %}Dashboard - ReViision{% endblock %}

{% block header %}Dashboard Overview{% endblock %}

{% block styles %}
<style>
    /* Reuse demographics selector styling */
    .demographics-nav {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .form-select {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Stats Grid (card style) -->
            {% set stats = [
                {'icon':'users','label':'Total Visitors','id':'total-visitors','color':'#3498db'},
                {'icon':'clock','label':'Avg. Dwell (min)','id':'avg-dwell-time','color':'#e74c3c'},
                {'icon':'percentage','label':'Conversion Rate','id':'conversion-rate','color':'#2ecc71'},
                {'icon':'venus-mars','label':'M/F Ratio','id':'gender-ratio','color':'#9b59b6'}
            ] %}
            <div class="stats-grid mb-4">
                {% for s in stats %}
                <div class="stat-card text-center">
                    <i class="fas fa-{{ s.icon }} fa-2x mb-3" data-color="{{ s.color }}"></i>
                    <div class="stat-value" id="{{ s.id }}">--</div>
                    <div class="stat-label">{{ s.label }}</div>
                </div>
                {% endfor %}
            </div>

            <!-- Time Range Selector -->
            <div class="demographics-nav mb-4">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4 col-sm-6">
                        <label for="time-range" class="form-label">Time Range</label>
                        <select class="form-select" id="time-range">
                            <option value="1h">Last Hour</option>
                            <option value="6h">Last 6 Hours</option>
                            <option value="24h" selected>Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                        </select>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <button class="btn btn-primary w-100 mt-sm-4" id="refreshButton"><i class="fas fa-sync-alt me-2"></i>Refresh Data</button>
                    </div>
                </div>
            </div>

            <!-- Traffic Chart (clickable to Historical page) -->
            <div class="demographics-section mb-4 clickable-section" role="link" tabindex="0" data-href="{{ url_for('web.historical') }}" style="cursor:pointer;">
                <h3 class="section-title"><span><i class="fas fa-chart-line me-2"></i>Store Traffic</span></h3>
                <div class="chart-container"><canvas id="trafficChart"></canvas></div>
            </div>

            <!-- Demographics Chart (clickable to Demographics page) -->
            <div class="demographics-section clickable-section" role="link" tabindex="0" data-href="{{ url_for('web.demographics') }}" style="cursor:pointer;">
                <h3 class="section-title"><span><i class="fas fa-users me-2"></i>Demographics</span></h3>
                <div class="row">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <div class="chart-container"><canvas id="ageChart"></canvas></div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container"><canvas id="genderChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ===== Dashboard Logic (clean version) =====
const api = {
    summary: (h) => `/api/analytics/summary?hours=${h}`,
    traffic: (h) => `/api/analytics/traffic?hours=${h}`
};

// Chart instances to allow destroy/redraw
let trafficChartInstance, ageChartInstance, genderChartInstance;

function getHours() {
    const map = { '1h': 1, '6h': 6, '24h': 24, '7d': 168, '30d': 720 };
    const range = document.getElementById('time-range').value || '24h';
    return map[range] || 24;
}

async function refreshDashboard() {
    const hours = getHours();
    const [summaryRes, trafficRes] = await Promise.all([
        fetch(api.summary(hours)).then(r=>r.json()).catch(()=>({success:false})),
        fetch(api.traffic(hours)).then(r=>r.json()).catch(()=>({success:false}))
    ]);

    // Update stat cards
    if (summaryRes.success) {
        document.getElementById('total-visitors').textContent = (summaryRes.total_visitors||0).toLocaleString();
        document.getElementById('avg-dwell-time').textContent = summaryRes.avg_dwell_time || '--';
        document.getElementById('conversion-rate').textContent = summaryRes.conversion_rate ? summaryRes.conversion_rate+'%' : '--';
        document.getElementById('gender-ratio').textContent = summaryRes.gender_ratio || '--';
        drawDemographics(summaryRes.age_groups || {}, summaryRes.gender_distribution || {});
    }
    drawTraffic(trafficRes);
}

function drawTraffic(res){
    const ctx = document.getElementById('trafficChart');
    if (trafficChartInstance) trafficChartInstance.destroy();
    const labels = res.success? res.labels : Array(24).fill('');
    const data = res.success? res.data : Array(24).fill(0);
    const config={
        type:'line',
        data:{labels,datasets:[{label:'Visitors',data,borderColor:'#3498db',backgroundColor:'rgba(52,152,219,.15)',tension:.4}]},
        options:{responsive:true,maintainAspectRatio:false}
    };
    trafficChartInstance = new ChartManager(ctx,config,{filename:'traffic_overview'});
    attachToolbar('trafficChart',trafficChartInstance);
}
function drawDemographics(ageData,genderData){
    const ageCanvas = document.getElementById('ageChart');
    const genderCanvas = document.getElementById('genderChart');
    if(ageChartInstance) ageChartInstance.destroy();
    if(genderChartInstance) genderChartInstance.destroy();
    const ageCfg={
        type:'bar',
        data:{labels:Object.keys(ageData),datasets:[{label:'Age Groups',data:Object.values(ageData),backgroundColor:'#3498db'}]},
        options:{responsive:true,maintainAspectRatio:false}
    };
    const genderCfg={
        type:'doughnut',
        data:{labels:Object.keys(genderData),datasets:[{data:Object.values(genderData),backgroundColor:['#3498db','#e74c3c','#95a5a6']}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}
    };
    ageChartInstance=new ChartManager(ageCanvas,ageCfg,{filename:'age_distribution'});
    genderChartInstance=new ChartManager(genderCanvas,genderCfg,{filename:'gender_distribution'});
    attachToolbar('ageChart',ageChartInstance);
    attachToolbar('genderChart',genderChartInstance);
}

// Toolbar util copied from demographics page
function attachToolbar(canvasId, chartManager){
    const canvas=document.getElementById(canvasId);
    if(!canvas) return;
    const container=canvas.closest('.chart-container');
    if(!container || container.querySelector('.chart-toolbar')) return;
    const tb=document.createElement('div');
    tb.className='chart-toolbar text-end mt-1';
    tb.innerHTML=`<button class="btn btn-sm btn-outline-secondary me-1" data-action="png"><i class="fas fa-image"></i></button><button class="btn btn-sm btn-outline-secondary me-1" data-action="csv"><i class="fas fa-file-csv"></i></button><button class="btn btn-sm btn-outline-secondary" data-action="json"><i class="fas fa-code"></i></button>`;
    container.appendChild(tb);
    tb.addEventListener('click',ev=>{
        const btn=ev.target.closest('button');
        if(!btn) return;
        const act=btn.getAttribute('data-action');
        if(act==='png') chartManager.exportPNG();
        if(act==='csv') chartManager.exportCSV();
        if(act==='json') chartManager.exportJSON();
    });
}

document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('refreshButton').addEventListener('click', refreshDashboard);
    document.getElementById('time-range').addEventListener('change', refreshDashboard);
    // set icon colours defined in data-color attrs
    document.querySelectorAll('i[data-color]').forEach(el=>{el.style.color=el.dataset.color;});
    refreshDashboard();
});
</script>
<script>
// Make summary sections act as links when clicked or focused and Enter pressed
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.clickable-section').forEach(sec => {
        const go = () => window.location.href = sec.dataset.href;
        sec.addEventListener('click', go);
        sec.addEventListener('keypress', e => { if (e.key === 'Enter') go(); });
    });
});
</script>
{% endblock %}
