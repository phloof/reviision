{% extends "base.html" %}

{% block title %}Dashboard - ReViision{% endblock %}

{% block header %}Dashboard Overview{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <div class="card stat-card">
        <i class="fas fa-users fa-2x" style="color: #3498db;"></i>
        <div class="stat-value" id="total-visitors">--</div>
        <div class="stat-label">Total Visitors</div>
    </div>
    
    <div class="card stat-card">
        <i class="fas fa-clock fa-2x" style="color: #e74c3c;"></i>
        <div class="stat-value" id="avg-dwell-time">--</div>
        <div class="stat-label">Avg. Dwell Time (min)</div>
    </div>
    
    <div class="card stat-card">
        <i class="fas fa-percentage fa-2x" style="color: #2ecc71;"></i>
        <div class="stat-value" id="conversion-rate">--</div>
        <div class="stat-label">Conversion Rate</div>
    </div>
    
    <div class="card stat-card">
        <i class="fas fa-venus-mars fa-2x" style="color: #9b59b6;"></i>
        <div class="stat-value" id="gender-ratio">--</div>
        <div class="stat-label">M/F Ratio</div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Store Traffic Over Time</h3>
        <div class="tooltip">
            <i class="fas fa-info-circle"></i>
            <span class="tooltip-text">Shows visitor count over time period</span>
        </div>
    </div>
    <div class="chart-container">
        <canvas id="trafficChart"></canvas>
    </div>
</div>

<div class="row">
    <div class="card" style="width: 100%;">
        <div class="card-header">
            <h3>Demographic Breakdown</h3>
            <div class="tooltip">
                <i class="fas fa-info-circle"></i>
                <span class="tooltip-text">Customer demographics analysis</span>
            </div>
        </div>
        <div class="chart-container">
            <div style="display: flex; justify-content: space-between;">
                <div style="width: 45%;">
                    <canvas id="ageChart"></canvas>
                </div>
                <div style="width: 45%;">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3>Top Traffic Areas</h3>
                <div class="tooltip">
                    <i class="fas fa-info-circle"></i>
                    <span class="tooltip-text">Store areas with highest traffic</span>
                </div>
            </div>
            <div id="heatmapPreview" class="chart-container" style="height: 300px;">
                <div style="text-align: center; padding-top: 100px; color: #999;">
                    Loading heatmap preview...
                </div>
            </div>
            <div class="card-footer text-center">
                <a href="/heatmap" class="btn btn-sm btn-primary">View Full Heatmap</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3>Live Camera Analysis</h3>
                <div class="tooltip">
                    <i class="fas fa-info-circle"></i>
                    <span class="tooltip-text">Real-time camera feed with analytics overlays</span>
                </div>
            </div>
            <div id="cameraPreview" class="chart-container" style="height: 300px; background-color: #000; position: relative;">
                <div style="position: absolute; top: 10px; left: 10px; background-color: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 4px;">
                    Main Entrance
                </div>
                <div style="text-align: center; padding-top: 100px; color: #999;">
                    Camera preview will appear here
                </div>
            </div>
            <div class="card-footer text-center">
                <a href="/analysis?autostart=true" class="btn btn-sm btn-primary">Open Live Analysis</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Fetch dashboard data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        fetchDashboardData();
    });
    
    // Update data when time range changes
    document.getElementById('time-range').addEventListener('change', function() {
        fetchDashboardData();
    });
    
    function fetchDashboardData() {
        const timeRange = document.getElementById('time-range').value;
        
        // Get time range dates
        const dates = getTimeRangeDates(timeRange);
        
        // Simulate data fetch for now
        setTimeout(() => {
            updateDashboardStats({
                totalVisitors: 2456,
                avgDwellTime: 15.3,
                conversionRate: 34.5,
                genderRatio: "55/45"
            });
            createTrafficChart(dates.start, dates.end);
            createDemographicCharts();
            createHeatmapPreview();
            simulateCameraPreview();
        }, 300);
    }
    
    function getTimeRangeDates(range) {
        const end = new Date();
        let start = new Date();
        
        switch(range) {
            case '1h':
                start.setHours(end.getHours() - 1);
                break;
            case '6h':
                start.setHours(end.getHours() - 6);
                break;
            case '24h':
                start.setDate(end.getDate() - 1);
                break;
            case '7d':
                start.setDate(end.getDate() - 7);
                break;
            case '30d':
                start.setDate(end.getDate() - 30);
                break;
            default:
                start.setDate(end.getDate() - 1);
        }
        
        return { start, end };
    }
    
    function updateDashboardStats(data) {
        document.getElementById('total-visitors').textContent = data.totalVisitors;
        document.getElementById('avg-dwell-time').textContent = data.avgDwellTime;
        document.getElementById('conversion-rate').textContent = data.conversionRate + '%';
        document.getElementById('gender-ratio').textContent = data.genderRatio;
    }
    
    function createTrafficChart(start, end) {
        const ctx = document.getElementById('trafficChart').getContext('2d');
        
        // Generate sample data
        const labels = [];
        const data = [];
        
        // Create hours between start and end
        const diff = (end - start) / (1000 * 60 * 60);
        const step = Math.max(1, Math.ceil(diff / 24)); // Max 24 data points
        
        for (let i = 0; i <= diff; i += step) {
            const date = new Date(start.getTime() + i * 1000 * 60 * 60);
            labels.push(date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            
            // Random traffic data
            data.push(Math.floor(Math.random() * 50) + 10);
        }
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors',
                    data: data,
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: 'rgba(52, 152, 219, 1)',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                }
            }
        });
    }
    
    function createDemographicCharts() {
        // Age Distribution Chart
        const ageCtx = document.getElementById('ageChart').getContext('2d');
        new Chart(ageCtx, {
            type: 'pie',
            data: {
                labels: ['18-24', '25-34', '35-44', '45-54', '55+'],
                datasets: [{
                    data: [15, 30, 25, 18, 12],
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(155, 89, 182, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(230, 126, 34, 0.7)'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    title: {
                        display: true,
                        text: 'Age Distribution'
                    }
                }
            }
        });
        
        // Gender Distribution Chart
        const genderCtx = document.getElementById('genderChart').getContext('2d');
        new Chart(genderCtx, {
            type: 'doughnut',
            data: {
                labels: ['Male', 'Female'],
                datasets: [{
                    data: [55, 45],
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(231, 76, 60, 0.7)'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    title: {
                        display: true,
                        text: 'Gender Distribution'
                    }
                }
            }
        });
    }
    
    function createHeatmapPreview() {
        const heatmapContainer = document.getElementById('heatmapPreview');
        heatmapContainer.innerHTML = '';
        
        // Create a simple heatmap using Plotly.js
        const data = [{
            z: [
                [0, 0, 1, 2, 3, 2, 1, 0],
                [0, 1, 2, 3, 4, 3, 2, 1],
                [1, 2, 4, 6, 7, 5, 3, 1],
                [2, 3, 5, 8, 9, 7, 4, 2],
                [1, 2, 4, 7, 8, 6, 3, 1],
                [0, 1, 3, 5, 6, 4, 2, 0],
                [0, 0, 1, 2, 3, 2, 1, 0]
            ],
            type: 'heatmap',
            colorscale: 'Reds',
            showscale: false
        }];
        
        const layout = {
            title: 'Store Traffic Heatmap Preview',
            annotations: [{
                text: 'Click for full view',
                showarrow: false,
                x: 0.5,
                y: -0.15,
                xref: 'paper',
                yref: 'paper',
                font: {
                    size: 12,
                    color: '#3498db'
                }
            }],
            margin: {
                l: 40,
                r: 40,
                b: 60,
                t: 60
            }
        };
        
        Plotly.newPlot(heatmapContainer, data, layout, {responsive: true});
        
        // Add click handler to navigate to full heatmap
        heatmapContainer.onclick = function() {
            window.location.href = '/heatmap';
        };
    }
    
    function simulateCameraPreview() {
        const previewContainer = document.getElementById('cameraPreview');
        
        // Clear any previous content except for the label
        const label = previewContainer.querySelector('div:first-child');
        previewContainer.innerHTML = '';
        previewContainer.appendChild(label);
        
        // Create a simulated camera preview
        const simPreview = document.createElement('div');
        simPreview.style.position = 'absolute';
        simPreview.style.top = '0';
        simPreview.style.left = '0';
        simPreview.style.width = '100%';
        simPreview.style.height = '100%';
        simPreview.style.background = 'linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7))';
        
        // Add some simulated people
        const peopleCount = Math.floor(Math.random() * 4) + 1;
        for (let i = 0; i < peopleCount; i++) {
            const person = document.createElement('div');
            person.style.position = 'absolute';
            person.style.width = '30px';
            person.style.height = '30px';
            person.style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
            person.style.borderRadius = '50%';
            person.style.border = '2px solid rgba(0, 255, 0, 0.8)';
            
            // Random position
            person.style.left = Math.floor(Math.random() * 80) + 10 + '%';
            person.style.top = Math.floor(Math.random() * 80) + 10 + '%';
            
            simPreview.appendChild(person);
        }
        
        previewContainer.appendChild(simPreview);
        
        // Add click handler to navigate to analysis page with autostart parameter
        previewContainer.onclick = function() {
            window.location.href = '/analysis?autostart=true';
        };
    }
</script>
{% endblock %} 