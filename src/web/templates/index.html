{% extends "base.html" %}

{% block title %}Dashboard - ReViision{% endblock %}

{% block header %}Dashboard Overview{% endblock %}

{% block styles %}
<style>
    /* Reuse demographics selector styling */
    .demographics-nav {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .form-select {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-6">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-primary mb-2">Dashboard Overview</h1>
        <p class="text-secondary">Real-time analytics and insights for your retail space</p>
    </div>

    <!-- Stats Grid -->
    {% set stats = [
        {'icon':'users','label':'Total Visitors','id':'total-visitors','variant':'primary'},
        {'icon':'clock','label':'Avg. Dwell Time','id':'avg-dwell-time','variant':'danger'},
        {'icon':'percentage','label':'Conversion Rate','id':'conversion-rate','variant':'success'},
        {'icon':'venus-mars','label':'M/F Ratio','id':'gender-ratio','variant':'warning'}
    ] %}

    <div class="d-grid grid-cols-1 tablet-grid-cols-2 desktop-grid-cols-4 gap-6 mb-8">
        {% for stat in stats %}
        <div class="card hover:shadow-lg transition-all animate-fade-in">
            <div class="card-body text-center p-6">
                <div class="mb-4">
                    <i class="fas fa-{{ stat.icon }} text-4xl text-{{ stat.variant }}"></i>
                </div>
                <div class="text-3xl font-bold text-primary mb-2" id="{{ stat.id }}">
                    <span class="animate-pulse">--</span>
                </div>
                <div class="text-sm font-medium text-secondary uppercase tracking-wide">
                    {{ stat.label }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Controls Section -->
    <div class="card mb-8">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-sliders-h"></i>
                Data Controls
            </h2>
        </div>
        <div class="card-body">
            <div class="d-flex flex-column desktop-flex-row gap-4 items-end">
                <div class="form-group flex-1">
                    <label for="time-range" class="form-label">Time Range</label>
                    <select class="form-control" id="time-range">
                        <option value="1h">Last Hour</option>
                        <option value="6h">Last 6 Hours</option>
                        <option value="24h" selected>Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" id="refreshButton">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="d-grid grid-cols-1 desktop-grid-cols-2 gap-6 mb-8">
        <!-- Traffic Chart -->
        <div class="card cursor-pointer hover:shadow-lg transition-all clickable-section"
             role="link" tabindex="0" data-href="{{ url_for('web.historical') }}">
            <div class="card-header card-header-primary">
                <h3 class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Store Traffic
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Demographics Chart -->
        <div class="card cursor-pointer hover:shadow-lg transition-all clickable-section"
             role="link" tabindex="0" data-href="{{ url_for('web.demographics') }}">
            <div class="card-header card-header-success">
                <h3 class="card-title">
                    <i class="fas fa-users"></i>
                    Demographics
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="demographicsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- Additional Analytics -->
    <div class="d-grid grid-cols-1 desktop-grid-cols-2 gap-6">
        <!-- Age Distribution -->
        <div class="card">
            <div class="card-header card-header-warning">
                <h3 class="card-title">
                    <i class="fas fa-birthday-cake"></i>
                    Age Distribution
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Gender Distribution -->
        <div class="card">
            <div class="card-header card-header-danger">
                <h3 class="card-title">
                    <i class="fas fa-venus-mars"></i>
                    Gender Distribution
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card mt-8">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-bolt"></i>
                Quick Actions
            </h3>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-3">
                <a href="{{ url_for('web.analysis') }}" class="btn btn-primary">
                    <i class="fas fa-video"></i>
                    Live Analysis
                </a>
                <a href="{{ url_for('web.demographics') }}" class="btn btn-secondary">
                    <i class="fas fa-chart-pie"></i>
                    Demographics
                </a>
                <a href="{{ url_for('web.historical') }}" class="btn btn-secondary">
                    <i class="fas fa-history"></i>
                    Historical Data
                </a>
                <a href="{{ url_for('web.settings') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ===== Dashboard Logic (clean version) =====
const api = {
    summary: (h) => `/api/analytics/summary?hours=${h}`,
    traffic: (h) => `/api/analytics/traffic?hours=${h}`
};

// Chart instances to allow destroy/redraw
let trafficChartInstance, ageChartInstance, genderChartInstance;

function getHours() {
    const map = { '1h': 1, '6h': 6, '24h': 24, '7d': 168, '30d': 720 };
    const range = document.getElementById('time-range').value || '24h';
    return map[range] || 24;
}

async function refreshDashboard() {
    const hours = getHours();
    const [summaryRes, trafficRes] = await Promise.all([
        fetch(api.summary(hours)).then(r=>r.json()).catch(()=>({success:false})),
        fetch(api.traffic(hours)).then(r=>r.json()).catch(()=>({success:false}))
    ]);

    // Update stat cards
    if (summaryRes.success) {
        document.getElementById('total-visitors').textContent = (summaryRes.total_visitors||0).toLocaleString();
        document.getElementById('avg-dwell-time').textContent = summaryRes.avg_dwell_time || '--';
        document.getElementById('conversion-rate').textContent = summaryRes.conversion_rate ? summaryRes.conversion_rate+'%' : '--';
        document.getElementById('gender-ratio').textContent = summaryRes.gender_ratio || '--';
        drawDemographics(summaryRes.age_groups || {}, summaryRes.gender_distribution || {});
    }
    drawTraffic(trafficRes);
}

function drawTraffic(res){
    const ctx = document.getElementById('trafficChart');
    if (trafficChartInstance) trafficChartInstance.destroy();
    const labels = res.success? res.labels : Array(24).fill('');
    const data = res.success? res.data : Array(24).fill(0);
    const config={
        type:'line',
        data:{labels,datasets:[{label:'Visitors',data,borderColor:'#3498db',backgroundColor:'rgba(52,152,219,.15)',tension:.4}]},
        options:{responsive:true,maintainAspectRatio:false}
    };
    trafficChartInstance = new ChartManager(ctx,config,{filename:'traffic_overview'});
    attachToolbar('trafficChart',trafficChartInstance);
}
function drawDemographics(ageData,genderData){
    const ageCanvas = document.getElementById('ageChart');
    const genderCanvas = document.getElementById('genderChart');
    if(ageChartInstance) ageChartInstance.destroy();
    if(genderChartInstance) genderChartInstance.destroy();
    const ageCfg={
        type:'bar',
        data:{labels:Object.keys(ageData),datasets:[{label:'Age Groups',data:Object.values(ageData),backgroundColor:'#3498db'}]},
        options:{responsive:true,maintainAspectRatio:false}
    };
    const genderCfg={
        type:'doughnut',
        data:{labels:Object.keys(genderData),datasets:[{data:Object.values(genderData),backgroundColor:['#3498db','#e74c3c','#95a5a6']}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}
    };
    ageChartInstance=new ChartManager(ageCanvas,ageCfg,{filename:'age_distribution'});
    genderChartInstance=new ChartManager(genderCanvas,genderCfg,{filename:'gender_distribution'});
    attachToolbar('ageChart',ageChartInstance);
    attachToolbar('genderChart',genderChartInstance);
}

// Toolbar util copied from demographics page
function attachToolbar(canvasId, chartManager){
    const canvas=document.getElementById(canvasId);
    if(!canvas) return;
    const container=canvas.closest('.chart-container');
    if(!container || container.querySelector('.chart-toolbar')) return;
    const tb=document.createElement('div');
    tb.className='chart-toolbar text-end mt-1';
    tb.innerHTML=`<button class="btn btn-sm btn-outline-secondary me-1" data-action="png"><i class="fas fa-image"></i></button><button class="btn btn-sm btn-outline-secondary me-1" data-action="csv"><i class="fas fa-file-csv"></i></button><button class="btn btn-sm btn-outline-secondary" data-action="json"><i class="fas fa-code"></i></button>`;
    container.appendChild(tb);
    tb.addEventListener('click',ev=>{
        const btn=ev.target.closest('button');
        if(!btn) return;
        const act=btn.getAttribute('data-action');
        if(act==='png') chartManager.exportPNG();
        if(act==='csv') chartManager.exportCSV();
        if(act==='json') chartManager.exportJSON();
    });
}

document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('refreshButton').addEventListener('click', refreshDashboard);
    document.getElementById('time-range').addEventListener('change', refreshDashboard);
    // set icon colours defined in data-color attrs
    document.querySelectorAll('i[data-color]').forEach(el=>{el.style.color=el.dataset.color;});
    refreshDashboard();
});
</script>
<script>
// Make summary sections act as links when clicked or focused and Enter pressed
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.clickable-section').forEach(sec => {
        const go = () => window.location.href = sec.dataset.href;
        sec.addEventListener('click', go);
        sec.addEventListener('keypress', e => { if (e.key === 'Enter') go(); });
    });
});
</script>
{% endblock %}
