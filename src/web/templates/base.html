<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.8, maximum-scale=2.0">
    <meta name="description" content="ReViision - Advanced Retail Vision Analytics and Customer Insights">
    <meta name="keywords" content="retail analytics, computer vision, customer tracking, demographics, heatmap">
    <meta name="author" content="ReViision">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="{{ url_for('static', filename='css/styles.css') }}" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
    
    <!-- DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//code.jquery.com">
    <link rel="dns-prefetch" href="//cdn.plot.ly">
    
    <title>{% block title %}ReViision - Retail Vision Analytics{% endblock %}</title>
    
    <!-- Critical CSS (Bootstrap) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUa1B1GeCkxGj8g3iU7ZvYJFAOqr9nZzE+qVEf/qVVd5Bh8FiZglgPRGxOKX" crossorigin="anonymous">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    <!-- Block for additional page-specific styles -->
    {% block styles %}{% endblock %}
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
    
    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#2c3e50">
    
    <!-- Open Graph meta tags for social sharing -->
    <meta property="og:title" content="{% block og_title %}ReViision - Retail Vision Analytics{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Advanced retail analytics platform using computer vision for customer insights{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.url }}">
    
    <!-- Performance optimization -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">

    <!-- Date picker -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/flatpickr.min.css') }}">
    <script src="{{ url_for('static', filename='js/flatpickr.min.js') }}" defer></script>
</head>
<body class="main-layout">
    
    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
        <div class="sidebar-header">
            <div class="logo">
                <h1><i class="fas fa-eye me-2" aria-hidden="true"></i><span class="logo-text">ReViision</span></h1>
            </div>
            <!-- Desktop sidebar toggle -->
            <button class="sidebar-toggle d-none d-lg-block" id="sidebar-toggle" type="button" aria-label="Toggle sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
            <!-- Mobile close button -->
            <button class="mobile-close-btn d-lg-none" id="mobile-close-btn" type="button" aria-label="Close navigation menu" style="display: none;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Navigation Menu -->
        <ul class="nav-links" role="menubar">
            <li role="none">
                <a href="{{ url_for('web.index') }}" 
                   class="nav-link {% if request.endpoint == 'web.index' %}active{% endif %}" 
                   role="menuitem"
                   aria-current="{% if request.endpoint == 'web.index' %}page{% endif %}"
                   title="Dashboard">
                    <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
            </li>
            <li role="none">
                <a href="{{ url_for('web.analysis') }}" 
                   class="nav-link {% if request.endpoint == 'web.analysis' %}active{% endif %}"
                   role="menuitem"
                   aria-current="{% if request.endpoint == 'web.analysis' %}page{% endif %}"
                   title="Camera Analysis">
                    <i class="fas fa-video" aria-hidden="true"></i>
                    <span class="nav-text">Camera Analysis</span>
                </a>
            </li>
            <li role="none">
                <a href="{{ url_for('web.demographics') }}" 
                   class="nav-link {% if request.endpoint == 'web.demographics' %}active{% endif %}"
                   role="menuitem"
                   aria-current="{% if request.endpoint == 'web.demographics' %}page{% endif %}"
                   title="Demographics">
                    <i class="fas fa-users" aria-hidden="true"></i>
                    <span class="nav-text">Demographics</span>
                </a>
            </li>
            <li role="none">
                <a href="{{ url_for('web.historical') }}" 
                   class="nav-link {% if request.endpoint == 'web.historical' %}active{% endif %}"
                   role="menuitem"
                   aria-current="{% if request.endpoint == 'web.historical' %}page{% endif %}"
                   title="Historical Data">
                    <i class="fas fa-chart-line" aria-hidden="true"></i>
                    <span class="nav-text">Historical Data</span>
                </a>
            </li>
            <li role="none">
                <a href="{{ url_for('web.settings') }}" 
                   class="nav-link {% if request.endpoint == 'web.settings' %}active{% endif %}"
                   role="menuitem"
                   aria-current="{% if request.endpoint == 'web.settings' %}page{% endif %}"
                   title="Settings">
                    <i class="fas fa-cog" aria-hidden="true"></i>
                    <span class="nav-text">Settings</span>
                </a>
            </li>
            <li role="none">
                <a href="{{ url_for('web.user_settings') }}" 
                   class="nav-link {% if request.endpoint == 'web.user_settings' %}active{% endif %}"
                   role="menuitem"
                   aria-current="{% if request.endpoint == 'web.user_settings' %}page{% endif %}"
                   title="User Settings">
                    <i class="fas fa-user-cog" aria-hidden="true"></i>
                    <span class="nav-text">User Settings</span>
                </a>
            </li>
            <li role="none">
                <a href="{{ url_for('web.zones_editor') }}" 
                   class="nav-link {% if request.endpoint == 'web.zones_editor' %}active{% endif %}"
                   role="menuitem"
                   aria-current="{% if request.endpoint == 'web.zones_editor' %}page{% endif %}"
                   title="Zone Editor">
                    <i class="fas fa-vector-square" aria-hidden="true"></i>
                    <span class="nav-text">Zone Editor</span>
                </a>
            </li>
        </ul>
        
        <!-- System Status -->
        <div class="system-status" role="status" aria-live="polite">
            <div class="status-indicator">
                <i class="fas fa-circle status-running" aria-hidden="true"></i>
                <span class="status-text">System Online</span>
            </div>
        </div>
    </nav>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main Content Area -->
    <main class="content" id="main-content" role="main">
        <!-- Page Header -->
        <header class="page-header">
            <div class="header-content">
                <div class="header-left">
                    <!-- Mobile menu toggle -->
                    <button class="btn btn-outline-secondary d-lg-none me-3 mobile-menu-toggle" 
                            type="button" 
                            id="mobile-menu-toggle"
                            aria-label="Toggle navigation menu">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <div class="page-title">
                        <h1>{% block header %}Dashboard{% endblock %}</h1>
                        {% block breadcrumb %}{% endblock %}
                    </div>
                </div>
                
                <!-- User menu or other header actions -->
                <div class="header-actions">
                    {% block header_actions %}
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center" 
                                type="button" 
                                id="profile-dropdown-btn"
                                data-bs-toggle="dropdown" 
                                data-bs-auto-close="true"
                                aria-expanded="false"
                                aria-label="User menu">
                            <span class="profile-icon me-2"><i class="fas fa-user"></i></span>
                            <span class="d-none d-sm-inline">Profile</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" style="position: absolute; z-index: 1050;">
                            <li><a class="dropdown-item" href="{{ url_for('web.user_settings') }}">
                                <i class="fas fa-user-cog me-2"></i>Settings
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('web.logout') }}">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </div>
                    {% endblock %}
                </div>
            </div>
        </header>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="container-fluid mt-3">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                            <i class="fas fa-{% if category == 'error' %}exclamation-triangle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Page Content -->
        <div class="container-fluid p-4">
            {% block content %}
            <!-- Default content -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <h2>Welcome to ReViision</h2>
                            <p class="text-muted">Advanced Retail Vision Analytics Platform</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endblock %}
        </div>
    </main>

    <!-- Loading indicator for page transitions -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner-large">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Scripts loaded at end for performance -->
    <!-- Preload critical scripts -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" as="script">
    <link rel="preload" href="https://code.jquery.com/jquery-3.6.0.min.js" as="script">
    
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" 
            crossorigin="anonymous"></script>
    
    <!-- jQuery (loaded conditionally) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" 
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" 
            crossorigin="anonymous" defer></script>
    
    <!-- Chart.js (loaded only when needed) -->
    {% block chart_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" defer></script>
    <script src="{{ url_for('static', filename='js/chartjs-plugin-zoom.min.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/chartjs-plugin-datalabels.min.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/FileSaver.min.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/chartManager.js') }}" defer></script>
    {% endblock %}
    
    <!-- Plotly.js (loaded only when needed) -->
    {% block plotly_js %}
    <script src="https://cdn.plot.ly/plotly-latest.min.js" defer></script>
    {% endblock %}
    
    <!-- Common JavaScript functionality -->
    <script defer>
        // Performance monitoring
        window.addEventListener('load', function() {
            // Log performance metrics
            const perfData = performance.getEntriesByType('navigation')[0];
            // Performance monitoring for development
            if (window.DEBUG_MODE) {
                console.log('Page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
            }
        });
        
        // Enhanced accessibility features
        document.addEventListener('DOMContentLoaded', function() {
            // Sidebar functionality
            initializeSidebar();
            
            // Initialize dropdown functionality
            initializeDropdowns();
            
            // Add focus management for modals
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('shown.bs.modal', function() {
                    const firstInput = modal.querySelector('input, button, select, textarea');
                    if (firstInput) firstInput.focus();
                });
            });
            
            // Enhanced keyboard navigation
            document.addEventListener('keydown', function(e) {
                // ESC key closes modals and dropdowns
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal.show');
                    if (openModal) {
                        bootstrap.Modal.getInstance(openModal).hide();
                        return;
                    }
                    
                    // Close any open dropdowns
                    const openDropdowns = document.querySelectorAll('.dropdown-menu.show');
                    openDropdowns.forEach(dropdown => {
                        dropdown.classList.remove('show');
                        dropdown.removeAttribute('style');
                    });
                    
                    // Close mobile sidebar on ESC
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar && sidebar.classList.contains('show')) {
                        closeMobileSidebar();
                        return;
                    }
                }
                
                // Toggle sidebar with Ctrl+B (desktop only)
                if (e.ctrlKey && e.key === 'b' && window.innerWidth >= 992) {
                    e.preventDefault();
                    toggleDesktopSidebar();
                }
                
                // Arrow key navigation within mobile sidebar
                const sidebar = document.getElementById('sidebar');
                if (sidebar && sidebar.classList.contains('show') && window.innerWidth < 992) {
                    const navLinks = sidebar.querySelectorAll('.nav-links a');
                    const currentFocus = document.activeElement;
                    const currentIndex = Array.from(navLinks).indexOf(currentFocus);
                    
                    if (e.key === 'ArrowDown' && currentIndex < navLinks.length - 1) {
                        e.preventDefault();
                        navLinks[currentIndex + 1].focus();
                    } else if (e.key === 'ArrowUp' && currentIndex > 0) {
                        e.preventDefault();
                        navLinks[currentIndex - 1].focus();
                    } else if (e.key === 'Home' && navLinks.length > 0) {
                        e.preventDefault();
                        navLinks[0].focus();
                    } else if (e.key === 'End' && navLinks.length > 0) {
                        e.preventDefault();
                        navLinks[navLinks.length - 1].focus();
                    }
                }
            });
            
            // Auto-hide alerts after 5 seconds
            const alerts = document.querySelectorAll('.alert:not(.alert-important)');
            alerts.forEach(alert => {
                setTimeout(() => {
                    if (alert.parentNode) {
                        bootstrap.Alert.getInstance(alert)?.close();
                    }
                }, 5000);
            });
            
            // Handle window resize
            window.addEventListener('resize', handleWindowResize);
        });
        
        // Sidebar functionality
        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const mobileCloseBtn = document.getElementById('mobile-close-btn');
            const overlay = document.getElementById('sidebar-overlay');
            
            // Desktop sidebar toggle
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleDesktopSidebar);
            }
            
            // Mobile menu toggle
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', toggleMobileSidebar);
            }
            
            // Mobile close button
            if (mobileCloseBtn) {
                mobileCloseBtn.addEventListener('click', closeMobileSidebar);
            }
            
            // Overlay click to close mobile sidebar
            if (overlay) {
                overlay.addEventListener('click', closeMobileSidebar);
            }
            
            // Close mobile sidebar when clicking nav links
            const navLinks = document.querySelectorAll('.nav-links a');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth < 992) {
                        setTimeout(() => closeMobileSidebar(), 200); // Small delay for better UX
                    }
                });
            });
            
            // Load saved sidebar state for desktop
            if (window.innerWidth >= 992) {
                const savedState = localStorage.getItem('sidebarCollapsed');
                if (savedState === 'true') {
                    sidebar.classList.add('collapsed');
                }
            }
        }
        
        function toggleDesktopSidebar() {
            const sidebar = document.getElementById('sidebar');
            const isCollapsed = sidebar.classList.toggle('collapsed');
            
            // Save state
            localStorage.setItem('sidebarCollapsed', isCollapsed);
            
            // Announce to screen readers
            const announcement = isCollapsed ? 'Sidebar collapsed' : 'Sidebar expanded';
            announceToScreenReader(announcement);
        }
        
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isOpen = sidebar.classList.contains('show');
            
            if (isOpen) {
                closeMobileSidebar();
            } else {
                openMobileSidebar();
            }
        }
        
        function openMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const mobileToggle = document.getElementById('mobile-menu-toggle');
            const mobileCloseBtn = document.getElementById('mobile-close-btn');
            
            // Add opening animation class
            sidebar.classList.add('show');
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Update button aria states
            if (mobileToggle) {
                mobileToggle.setAttribute('aria-expanded', 'true');
            }
            
            // Focus close button for better UX
            if (mobileCloseBtn) {
                setTimeout(() => mobileCloseBtn.focus(), 300);
            }
            
            // Add subtle haptic feedback for mobile devices
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            announceToScreenReader('Navigation menu opened');
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const mobileToggle = document.getElementById('mobile-menu-toggle');
            
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
            
            // Delay removing scroll lock to allow animation to complete
            setTimeout(() => {
                document.body.style.overflow = '';
            }, 300);
            
            // Update button aria state and return focus
            if (mobileToggle) {
                mobileToggle.setAttribute('aria-expanded', 'false');
                setTimeout(() => mobileToggle.focus(), 300); // Return focus after animation
            }
            
            // Add subtle haptic feedback for mobile devices
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }
            
            announceToScreenReader('Navigation menu closed');
        }
        
        function handleWindowResize() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            // Close mobile sidebar if window becomes large
            if (window.innerWidth >= 992) {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
                document.body.style.overflow = '';
            } else {
                // Remove collapsed state on mobile
                sidebar.classList.remove('collapsed');
            }
        }
        
        function announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            
            document.body.appendChild(announcement);
            setTimeout(() => document.body.removeChild(announcement), 1000);
        }
        
        // Sidebar toggle functionality for mobile
        function toggleSidebar() {
            toggleMobileSidebar();
        }
        
        // Loading state management
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        // AJAX form submission helper
        function submitForm(form, successCallback, errorCallback) {
            const formData = new FormData(form);
            showLoading();
            
            fetch(form.action, {
                method: form.method,
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    successCallback(data);
                } else {
                    errorCallback(data);
                }
            })
            .catch(error => {
                hideLoading();
                errorCallback({message: 'Network error occurred'});
            });
        }
        
        // Enhanced touch gesture support for mobile sidebar
        if ('ontouchstart' in window) {
            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;
            let touchEndY = 0;
            let touchStartTime = 0;
            
            document.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
                touchStartTime = Date.now();
            }, { passive: true });
            
            document.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipeGesture();
            }, { passive: true });
            
            function handleSwipeGesture() {
                const swipeThreshold = 80;
                const maxSwipeTime = 300;
                const maxVerticalDistance = 100;
                const sidebar = document.getElementById('sidebar');
                
                const horizontalDistance = Math.abs(touchEndX - touchStartX);
                const verticalDistance = Math.abs(touchEndY - touchStartY);
                const swipeTime = Date.now() - touchStartTime;
                
                // Only handle horizontal swipes that are faster than vertical movement
                if (horizontalDistance > swipeThreshold && 
                    verticalDistance < maxVerticalDistance && 
                    swipeTime < maxSwipeTime &&
                    window.innerWidth < 992) {
                    
                    // Swipe right to open sidebar (from left edge)
                    if (touchStartX < 30 && touchEndX - touchStartX > swipeThreshold && !sidebar.classList.contains('show')) {
                        openMobileSidebar();
                    }
                    // Swipe left to close sidebar
                    else if (sidebar.classList.contains('show') && touchStartX - touchEndX > swipeThreshold) {
                        closeMobileSidebar();
                    }
                }
            }
        }
        
        // Initialize dropdown functionality with Bootstrap
        function initializeDropdowns() {
            // Let Bootstrap handle dropdowns natively
            // Just ensure dropdowns are initialized when Bootstrap is ready
            if (typeof bootstrap !== 'undefined') {
                console.log('Bootstrap dropdowns initialized');
                
                // Optional: Add custom event listeners for specific dropdowns
                const profileDropdown = document.getElementById('profile-dropdown-btn');
                if (profileDropdown) {
                    profileDropdown.addEventListener('shown.bs.dropdown', function () {
                        console.log('Profile dropdown opened');
                    });
                    profileDropdown.addEventListener('hidden.bs.dropdown', function () {
                        console.log('Profile dropdown closed');
                    });
                }
            } else {
                console.warn('Bootstrap not loaded yet, retrying dropdown initialization...');
                setTimeout(initializeDropdowns, 100);
            }
        }
    </script>
    
    <!-- Page-specific scripts -->
    {% block scripts %}{% endblock %}
    
    {% if request.endpoint == 'web.index' %}
    <!-- Default Password Warning Script (Dashboard only) -->
    <script defer>
        document.addEventListener('DOMContentLoaded', function () {
            // Ask backend if the current user is still on the default password
            fetch('/api/auth/me')
                .then(r => r.json())
                .then(data => {
                    if (!(data.success && data.user && data.user.is_default_password)) return;

                    // Build custom full-screen overlay (avoids layout shifts and ensures backdrop)
                    const overlayHtml = `
                        <div id="defaultPwdOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1080;">
                            <div class="card border-0 shadow-lg" style="max-width:500px;width:90%;border:none;border-radius:1rem;">
                                <div class="card-header bg-warning text-dark border-0" style="border:none;border-top-left-radius:1rem;border-top-right-radius:1rem;">
                                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Security Notice</h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-4">You are currently using the <strong>default password</strong>. For your security, please change it now.</p>
                                    <div class="text-end">
                                        <a href="/user-settings#passwordSection" class="btn btn-primary me-2" id="changePwdBtn"><i class="fas fa-key me-1"></i>Change Password</a>
                                        <button class="btn btn-secondary" id="dismissPwdBtn"><i class="fas fa-times me-1"></i>Dismiss</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;

                    document.body.insertAdjacentHTML('beforeend', overlayHtml);

                    const overlay = document.getElementById('defaultPwdOverlay');
                        // Dismiss handlers
                        overlay.querySelector('#dismissPwdBtn').addEventListener('click', () => {
                            overlay.remove(); // Will reappear on next navigation until password truly changed
                        });

                    overlay.querySelector('#changePwdBtn').addEventListener('click', () => {
                        // Navigate away; overlay removed automatically when page unloads. No persistence.
                    });
                })
                .catch(() => {/* quietly ignore if endpoint fails */});
        });
    </script>
    {% endif %}
    
    <!-- Service Worker for caching (optional) -->
    {% if config.get('ENABLE_SERVICE_WORKER', False) %}
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        if (window.DEBUG_MODE) {
                    console.log('SW registered: ', registration);
                }
                    }, function(registrationError) {
                        if (window.DEBUG_MODE) {
                    console.log('SW registration failed: ', registrationError);
                }
                    });
            });
        }
    </script>
    {% endif %}
</body>
</html> 