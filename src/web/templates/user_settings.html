{% extends "base.html" %}

{% block title %}User Settings - ReViision{% endblock %}

{% block header %}User Settings{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared-page-styles.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Account -->
            <section id="accountSection" class="mb-4">
                <div class="modern-card">
                    <div class="modern-card-header white-header"><i class="fas fa-user-circle me-2"></i>Account Information</div>
                    <div class="modern-card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="fas fa-user me-1"></i>Username</label>
                                <input type="text" class="form-control" id="username" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="fas fa-shield-alt me-1"></i>Role</label>
                                <input type="text" class="form-control" id="userRole" disabled>
                            </div>
                        </div> <!-- end row -->

                        <div class="text-start mt-3">
                            <a href="{{ url_for('web.logout') }}" class="btn modern-btn modern-btn-danger">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Password -->
            <section id="passwordSection">
                <div class="modern-card">
                    <div class="modern-card-header white-header"><i class="fas fa-lock me-2"></i>Password</div>
                    <div class="modern-card-body">
                        <form id="passwordForm" class="row g-3">
                            <div class="col-12"><div id="passwordAlertContainer"></div></div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="currentPassword"><i class="fas fa-key me-1"></i>Current Password</label>
                                <input type="password" class="form-control" id="currentPassword" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="newPassword"><i class="fas fa-lock me-1"></i>New Password</label>
                                <input type="password" class="form-control" id="newPassword" required>
                                <div class="password-requirements border rounded p-3 mt-2 bg-light small" id="pwd-req" style="display:none;">
                                    <div id="req-length" class="mb-1"><i class="fas fa-times text-danger me-1"></i> At least 8 characters</div>
                                    <div id="req-upper" class="mb-1"><i class="fas fa-times text-danger me-1"></i> One uppercase letter</div>
                                    <div id="req-lower" class="mb-1"><i class="fas fa-times text-danger me-1"></i> One lowercase letter</div>
                                    <div id="req-digit" class="mb-1"><i class="fas fa-times text-danger me-1"></i> One number</div>
                                    <div id="req-special"><i class="fas fa-times text-danger me-1"></i> One special character</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="confirmPassword"><i class="fas fa-check-double me-1"></i>Confirm New Password</label>
                                <input type="password" class="form-control" id="confirmPassword" required>
                            </div>
                            <div class="col-12 text-start mt-3">
                                <button type="submit" class="btn modern-btn modern-btn-primary" id="savePwdBtn"><i class="fas fa-save me-2"></i>Save Password</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class SettingsPage{
    constructor(){
        this.alertCtn = document.getElementById('passwordAlertContainer');
        this.initNav();
        this.loadUser();
        document.getElementById('passwordForm').addEventListener('submit',e=>this.changePwd(e));
        // live password validation
        const np=document.getElementById('newPassword');
        const cp=document.getElementById('confirmPassword');
        np.addEventListener('focus',()=>document.getElementById('pwd-req').style.display='block');
        np.addEventListener('input',()=>this.checkPwd());
        cp.addEventListener('input',()=>this.checkPwd());
    }
    initNav(){
        const links=document.querySelectorAll('#settings-nav .nav-link');
        links.forEach(l=>l.addEventListener('click',ev=>{ev.preventDefault();links.forEach(x=>x.classList.remove('active'));l.classList.add('active');document.querySelector(l.getAttribute('href')).scrollIntoView({behavior:'smooth'});}));
    }
    async loadUser(){
        const res=await fetch('/api/user_info').then(r=>r.json()).catch(()=>({}));
        if(res.success){document.getElementById('username').value=res.username;document.getElementById('userRole').value=res.role;}
    }
    async changePwd(e){
        e.preventDefault();
        const form = e.target;
        const data = new FormData(form);
        const btn = document.getElementById('savePwdBtn');
        btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        this.alert('','');
        const res = await fetch('/change_password',{method:'POST',body:data,headers:{'X-Requested-With':'XMLHttpRequest'}}).then(r=>r.json()).catch(()=>({success:false,message:'Network error'}));
        if(res.success){this.alert('Password updated!','success');form.reset();}
        else{this.alert(res.message||'Error','danger');}
        btn.disabled=false;btn.innerHTML='<i class="fas fa-save me-2"></i>Save Password';
    }
    alert(msg,type){
        this.alertCtn.innerHTML = msg?`<div class="alert alert-${type} alert-dismissible fade show" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`:'';
    }
    checkPwd(){
        const pwd=document.getElementById('newPassword').value;
        const confirm=document.getElementById('confirmPassword').value;
        const rules={
            length:pwd.length>=8,
            upper:/[A-Z]/.test(pwd),
            lower:/[a-z]/.test(pwd),
            digit:/\d/.test(pwd),
            special:/[!@#$%^&*(),.?":{}|<>]/.test(pwd)
        };
        for(const [k,v] of Object.entries(rules)){
            const row=document.getElementById(`req-${k==='length'? 'length':k}`);
            if(!row) continue;
            const icon=row.querySelector('i');
            if(v){
                icon.classList.remove('fa-times','text-danger');
                icon.classList.add('fa-check','text-success');
                row.classList.add('valid');
            }else{
                icon.classList.remove('fa-check','text-success');
                icon.classList.add('fa-times','text-danger');
                row.classList.remove('valid');
            }
        }
        const btn=document.getElementById('savePwdBtn');
        btn.disabled=!(Object.values(rules).every(Boolean) && pwd===confirm && confirm.length>0);
        const box=document.getElementById('pwd-req');
        if(Object.values(rules).every(Boolean)) box.classList.add('all-valid'); else box.classList.remove('all-valid');
    }
}

document.addEventListener('DOMContentLoaded',()=>new SettingsPage());
</script>
{% endblock %}
