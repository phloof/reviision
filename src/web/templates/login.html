<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sign in to ReViision - Advanced Retail Vision Analytics Platform">
    <meta name="robots" content="noindex, nofollow">
    
    <title>Sign In - ReViision</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="{{ url_for('static', filename='css/styles.css') }}" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
    
    <!-- DNS prefetch -->
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    
    <!-- Critical CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUa1B1GeCkxGj8g3iU7ZvYJFAOqr9nZzE+qVEf/qVVd5Bh8FiZglgPRGxOKX" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    <!-- Theme and favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <meta name="theme-color" content="#2c3e50">
</head>
<body>
    <main class="auth-wrapper" id="main-content" role="main">
        <div class="auth-container">
            <header class="auth-header">
                <h1><i class="fas fa-eye me-2" aria-hidden="true"></i>ReViision</h1>
                <p>Retail Vision Analytics</p>
            </header>
            
            <div class="auth-body">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                <i class="fas fa-{% if category == 'error' %}exclamation-triangle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-circle{% else %}info-circle{% endif %} me-2" aria-hidden="true"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- Login Form -->
                <form id="loginForm" novalidate>
                    <div class="form-floating mb-3">
                        <input type="text" 
                               class="form-control form-control-lg" 
                               id="username" 
                               name="username" 
                               placeholder="Username" 
                               required 
                               autocomplete="username"
                               aria-describedby="username-help">
                        <label for="username"><i class="fas fa-user me-2" aria-hidden="true"></i>Username</label>
                        <div id="username-help" class="form-text">Enter your username or email address</div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="password" 
                               class="form-control form-control-lg" 
                               id="password" 
                               name="password" 
                               placeholder="Password" 
                               required 
                               autocomplete="current-password"
                               aria-describedby="password-help">
                        <label for="password"><i class="fas fa-lock me-2" aria-hidden="true"></i>Password</label>
                        <button type="button" 
                                class="btn btn-outline-secondary password-toggle" 
                                onclick="togglePassword('password')"
                                aria-label="Show password">
                            <i class="fas fa-eye" id="password-toggle-icon"></i>
                        </button>
                        <div id="password-help" class="form-text">Enter your account password</div>
                    </div>
                    
                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-primary btn-lg" id="login-btn" aria-describedby="login-status">
                            <span class="loading-spinner me-2" aria-hidden="true"></span>
                            <i class="fas fa-sign-in-alt me-2" aria-hidden="true"></i>
                            <span class="btn-text">Sign In</span>
                        </button>
                        <div id="login-status" class="visually-hidden" aria-live="polite"></div>
                    </div>
                </form>
            </div>
            
            <footer class="auth-footer">
                <p class="mb-0">Don't have an account? <a href="{{ url_for('web.register_page') }}" aria-label="Create a new account">Register here</a></p>
            </footer>
        </div>
    </main>

    <!-- Scripts -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" as="script">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" 
            crossorigin="anonymous" defer></script>
    
    <script defer>
        // Performance monitoring
        window.addEventListener('load', function() {
            const perfData = performance.getEntriesByType('navigation')[0];
            // Performance monitoring can be enabled in debug mode
        if (window.DEBUG_MODE) {
            console.log('Login page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
        }
        });
        
        // Password toggle functionality
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + '-toggle-icon');
            const button = event.target.closest('.password-toggle');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.className = 'fas fa-eye-slash';
                button.setAttribute('aria-label', 'Hide password');
            } else {
                field.type = 'password';
                icon.className = 'fas fa-eye';
                button.setAttribute('aria-label', 'Show password');
            }
        }
        
        // Login form functionality
        function showLoadingSpinner() {
            const spinner = document.querySelector('.loading-spinner');
            const button = document.getElementById('login-btn');
            const btnText = document.querySelector('.btn-text');
            const status = document.getElementById('login-status');
            
            spinner.style.display = 'inline-block';
            button.disabled = true;
            btnText.textContent = 'Signing In...';
            status.textContent = 'Signing in, please wait...';
            status.classList.remove('visually-hidden');
        }

        function hideLoadingSpinner() {
            const spinner = document.querySelector('.loading-spinner');
            const button = document.getElementById('login-btn');
            const btnText = document.querySelector('.btn-text');
            const status = document.getElementById('login-status');
            
            spinner.style.display = 'none';
            button.disabled = false;
            btnText.textContent = 'Sign In';
            status.classList.add('visually-hidden');
        }

        // Enhanced form validation and submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('loginForm');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            
            // Auto-focus on username field
            usernameInput.focus();
            
            // Form submission handling
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                
                // Validate form
                if (!username || !password) {
                    showError('Please enter both username and password');
                    return false;
                }
                
                if (username.length < 3) {
                    showError('Username must be at least 3 characters long');
                    usernameInput.focus();
                    return false;
                }
                
                showLoadingSpinner();
                
                // Submit to API
                fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                })
                .then(response => {
                    // Check if response is ok
                    if (!response.ok) {
                        if (response.status === 405) {
                            throw new Error('Method not allowed. Please check your login configuration.');
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Show success message briefly
                        showSuccess('Login successful! Redirecting...');
                        
                        // Redirect to dashboard after short delay
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1000);
                    } else {
                        hideLoadingSpinner();
                        showError(data.message || 'Login failed');
                    }
                })
                .catch(error => {
                    hideLoadingSpinner();
                    console.error('Login error:', error);
                    showError('Unable to connect to server. Please try again.');
                });
                
                return false;
            });
            
            // Real-time validation
            usernameInput.addEventListener('input', function() {
                validateField(this, this.value.trim().length >= 3);
            });
            
            passwordInput.addEventListener('input', function() {
                validateField(this, this.value.length >= 1);
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Alt + L focuses on login button
                if (e.altKey && e.key === 'l') {
                    e.preventDefault();
                    document.getElementById('login-btn').focus();
                }
            });
        });
        
        function validateField(field, isValid) {
            field.classList.remove('is-valid', 'is-invalid');
            if (field.value.length > 0) {
                field.classList.add(isValid ? 'is-valid' : 'is-invalid');
            }
        }
        
        function showError(message) {
            showMessage(message, 'danger', 'exclamation-triangle');
        }
        
        function showSuccess(message) {
            showMessage(message, 'success', 'check-circle');
        }
        
        function showMessage(message, type, icon) {
            const alertContainer = document.querySelector('.auth-body');
            const existingAlert = alertContainer.querySelector('.alert');
            
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                <i class="fas fa-${icon} me-2" aria-hidden="true"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            alertContainer.insertBefore(alert, alertContainer.firstChild);
            
            // Auto-dismiss after 5 seconds for non-success messages
            if (type !== 'success') {
                setTimeout(() => {
                    if (alert.parentNode) {
                        bootstrap.Alert.getInstance(alert)?.close();
                    }
                }, 5000);
            }
        }
        
        // Security: Clear form on page unload
        window.addEventListener('beforeunload', function() {
            document.getElementById('password').value = '';
        });
        
        // Accessibility: Announce form errors to screen readers
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    const alerts = document.querySelectorAll('.alert[role="alert"]');
                    alerts.forEach(alert => {
                        alert.setAttribute('aria-live', 'assertive');
                    });
                }
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
</body>
</html> 