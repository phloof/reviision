<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Create an account for ReViision - Advanced Retail Vision Analytics Platform">
    <meta name="robots" content="noindex, nofollow">
    
    <title>Create Account - ReViision</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="{{ url_for('static', filename='css/styles.css') }}" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
    
    <!-- DNS prefetch -->
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    
    <!-- Critical CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUa1B1GeCkxGj8g3iU7ZvYJFAOqr9nZzE+qVEf/qVVd5Bh8FiZglgPRGxOKX" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    <!-- Theme and favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <meta name="theme-color" content="#2c3e50">
</head>
<body>
    <main class="auth-wrapper" id="main-content" role="main">
        <div class="auth-container large">
            <header class="auth-header">
                <h1><i class="fas fa-eye me-2" aria-hidden="true"></i>ReViision</h1>
                <p>Create Your Account</p>
            </header>
            
            <div class="auth-body">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                <i class="fas fa-{% if category == 'error' %}exclamation-triangle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-circle{% else %}info-circle{% endif %} me-2" aria-hidden="true"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- Registration Form -->
                <form id="registerForm" novalidate>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="username" 
                                       name="username" 
                                       placeholder="Username" 
                                       required 
                                       autocomplete="username"
                                       minlength="3"
                                       aria-describedby="username-help">
                                <label for="username"><i class="fas fa-user me-2" aria-hidden="true"></i>Username</label>
                                <div id="username-help" class="form-text">At least 3 characters, letters, numbers, and underscores only</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="email" 
                                       class="form-control form-control-lg" 
                                       id="email" 
                                       name="email" 
                                       placeholder="Email" 
                                       required 
                                       autocomplete="email"
                                       aria-describedby="email-help">
                                <label for="email"><i class="fas fa-envelope me-2" aria-hidden="true"></i>Email</label>
                                <div id="email-help" class="form-text">We'll use this for account recovery and important notifications</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="text" 
                               class="form-control form-control-lg" 
                               id="full_name" 
                               name="full_name" 
                               placeholder="Full Name" 
                               required 
                               autocomplete="name"
                               aria-describedby="fullname-help">
                        <label for="full_name"><i class="fas fa-id-card me-2" aria-hidden="true"></i>Full Name</label>
                        <div id="fullname-help" class="form-text">Your full name as it will appear in the system</div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="password" 
                               class="form-control form-control-lg" 
                               id="password" 
                               name="password" 
                               placeholder="Password" 
                               required 
                               autocomplete="new-password"
                               onkeyup="checkPasswordRequirements()"
                               aria-describedby="password-requirements">
                        <label for="password"><i class="fas fa-lock me-2" aria-hidden="true"></i>Password</label>
                        <button type="button" 
                                class="btn btn-outline-secondary password-toggle" 
                                onclick="togglePassword('password')"
                                aria-label="Show password">
                            <i class="fas fa-eye" id="password-toggle-icon"></i>
                        </button>
                    </div>
                    
                    <div id="password-requirements" class="password-requirements mb-3" style="display: none;" role="region" aria-label="Password requirements">
                        <strong>Password Requirements:</strong>
                        <div class="requirement" id="length-req" aria-live="polite">At least 8 characters</div>
                        <div class="requirement" id="upper-req" aria-live="polite">At least one uppercase letter</div>
                        <div class="requirement" id="lower-req" aria-live="polite">At least one lowercase letter</div>
                        <div class="requirement" id="number-req" aria-live="polite">At least one number</div>
                        <div class="requirement" id="special-req" aria-live="polite">At least one special character</div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="password" 
                               class="form-control form-control-lg" 
                               id="confirm_password" 
                               name="confirm_password" 
                               placeholder="Confirm Password" 
                               required 
                               autocomplete="new-password"
                               onkeyup="checkPasswordMatch()"
                               aria-describedby="confirm-help">
                        <label for="confirm_password"><i class="fas fa-lock me-2" aria-hidden="true"></i>Confirm Password</label>
                        <button type="button" 
                                class="btn btn-outline-secondary password-toggle" 
                                onclick="togglePassword('confirm_password')"
                                aria-label="Show password">
                            <i class="fas fa-eye" id="confirm_password-toggle-icon"></i>
                        </button>
                        <div id="confirm-help" class="form-text">Re-enter your password to confirm</div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <select class="form-select form-select-lg" 
                                id="role" 
                                name="role" 
                                required
                                aria-describedby="role-help">
                            <option value="">Choose role...</option>
                            <option value="user">User</option>
                            <option value="admin">Administrator</option>
                        </select>
                        <label for="role"><i class="fas fa-user-tag me-2" aria-hidden="true"></i>Role</label>
                        <div id="role-help" class="form-text">Select your access level in the system</div>
                    </div>
                    
                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-primary btn-lg" id="register-btn" aria-describedby="register-status">
                            <span class="loading-spinner me-2" aria-hidden="true"></span>
                            <i class="fas fa-user-plus me-2" aria-hidden="true"></i>
                            <span class="btn-text">Create Account</span>
                        </button>
                        <div id="register-status" class="visually-hidden" aria-live="polite"></div>
                    </div>
                </form>
            </div>
            
            <footer class="auth-footer">
                <p class="mb-0">Already have an account? <a href="{{ url_for('web.login_page') }}" aria-label="Sign in to existing account">Sign in here</a></p>
            </footer>
        </div>
    </main>

    <!-- Scripts -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" as="script">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" 
            crossorigin="anonymous" defer></script>
    
    <script defer>
        // Performance monitoring
        window.addEventListener('load', function() {
            const perfData = performance.getEntriesByType('navigation')[0];
            console.log('Register page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
        });
        
        // Password toggle functionality
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + '-toggle-icon');
            const button = event.target.closest('.password-toggle');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.className = 'fas fa-eye-slash';
                button.setAttribute('aria-label', 'Hide password');
            } else {
                field.type = 'password';
                icon.className = 'fas fa-eye';
                button.setAttribute('aria-label', 'Show password');
            }
        }
        
        // Registration form functionality
        function showLoadingSpinner() {
            const spinner = document.querySelector('.loading-spinner');
            const button = document.getElementById('register-btn');
            const btnText = document.querySelector('.btn-text');
            const status = document.getElementById('register-status');
            
            spinner.style.display = 'inline-block';
            button.disabled = true;
            btnText.textContent = 'Creating Account...';
            status.textContent = 'Creating your account, please wait...';
            status.classList.remove('visually-hidden');
        }

        function hideLoadingSpinner() {
            const spinner = document.querySelector('.loading-spinner');
            const button = document.getElementById('register-btn');
            const btnText = document.querySelector('.btn-text');
            const status = document.getElementById('register-status');
            
            spinner.style.display = 'none';
            button.disabled = false;
            btnText.textContent = 'Create Account';
            status.classList.add('visually-hidden');
        }
        
        function checkPasswordRequirements() {
            const password = document.getElementById('password').value;
            const requirements = document.getElementById('password-requirements');
            
            if (password.length > 0) {
                requirements.style.display = 'block';
                
                // Check length
                updateRequirement('length-req', password.length >= 8);
                
                // Check uppercase
                updateRequirement('upper-req', /[A-Z]/.test(password));
                
                // Check lowercase
                updateRequirement('lower-req', /[a-z]/.test(password));
                
                // Check number
                updateRequirement('number-req', /\d/.test(password));
                
                // Check special character
                updateRequirement('special-req', /[!@#$%^&*(),.?":{}|<>]/.test(password));
            } else {
                requirements.style.display = 'none';
            }
            
            // Also check password match if confirm password has value
            if (document.getElementById('confirm_password').value.length > 0) {
                checkPasswordMatch();
            }
        }
        
        function updateRequirement(id, met) {
            const element = document.getElementById(id);
            if (met) {
                element.style.color = '#28a745';
                element.innerHTML = '✓ ' + element.textContent.replace('✓ ', '').replace('✗ ', '');
            } else {
                element.style.color = '#dc3545';
                element.innerHTML = '✗ ' + element.textContent.replace('✓ ', '').replace('✗ ', '');
            }
        }
        
        function checkPasswordMatch() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const confirmField = document.getElementById('confirm_password');
            
            if (confirmPassword.length > 0) {
                if (password === confirmPassword) {
                    confirmField.classList.remove('is-invalid');
                    confirmField.classList.add('is-valid');
                } else {
                    confirmField.classList.remove('is-valid');
                    confirmField.classList.add('is-invalid');
                }
            } else {
                confirmField.classList.remove('is-valid', 'is-invalid');
            }
        }
        
        // Enhanced form validation and submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('registerForm');
            const inputs = form.querySelectorAll('input, select');
            
            // Auto-focus on first field
            document.getElementById('username').focus();
            
            // Form submission handling
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const formData = new FormData(form);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value.trim();
                }
                
                // Validate form
                if (!validateForm(data)) {
                    return false;
                }
                
                showLoadingSpinner();
                
                // Submit to API
                fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 405) {
                            throw new Error('Method not allowed. Please check your registration configuration.');
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showSuccess('Account created successfully! Redirecting to login...');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                    } else {
                        hideLoadingSpinner();
                        showError(data.message || 'Registration failed');
                    }
                })
                .catch(error => {
                    hideLoadingSpinner();
                    console.error('Registration error:', error);
                    showError('Unable to connect to server. Please try again.');
                });
                
                return false;
            });
            
            // Real-time validation
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateField(this);
                });
                
                input.addEventListener('blur', function() {
                    validateField(this);
                });
            });
        });
        
        function validateForm(data) {
            let isValid = true;
            
            // Username validation
            if (!data.username || data.username.length < 3) {
                showError('Username must be at least 3 characters long');
                document.getElementById('username').focus();
                return false;
            }
            
            if (!/^[a-zA-Z0-9_]+$/.test(data.username)) {
                showError('Username can only contain letters, numbers, and underscores');
                document.getElementById('username').focus();
                return false;
            }
            
            // Email validation
            if (!data.email || !isValidEmail(data.email)) {
                showError('Please enter a valid email address');
                document.getElementById('email').focus();
                return false;
            }
            
            // Full name validation
            if (!data.full_name || data.full_name.length < 2) {
                showError('Please enter your full name');
                document.getElementById('full_name').focus();
                return false;
            }
            
            // Password validation
            if (!isValidPassword(data.password)) {
                showError('Password does not meet requirements');
                document.getElementById('password').focus();
                return false;
            }
            
            // Password match validation
            if (data.password !== data.confirm_password) {
                showError('Passwords do not match');
                document.getElementById('confirm_password').focus();
                return false;
            }
            
            // Role validation
            if (!data.role) {
                showError('Please select a role');
                document.getElementById('role').focus();
                return false;
            }
            
            return isValid;
        }
        
        function validateField(field) {
            const value = field.value.trim();
            let isValid = true;
            
            switch (field.id) {
                case 'username':
                    isValid = value.length >= 3 && /^[a-zA-Z0-9_]+$/.test(value);
                    break;
                case 'email':
                    isValid = isValidEmail(value);
                    break;
                case 'full_name':
                    isValid = value.length >= 2;
                    break;
                case 'password':
                    isValid = isValidPassword(value);
                    break;
                case 'confirm_password':
                    isValid = value === document.getElementById('password').value;
                    break;
                case 'role':
                    isValid = value !== '';
                    break;
            }
            
            field.classList.remove('is-valid', 'is-invalid');
            if (value.length > 0) {
                field.classList.add(isValid ? 'is-valid' : 'is-invalid');
            }
            
            return isValid;
        }
        
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function isValidPassword(password) {
            return password.length >= 8 &&
                   /[A-Z]/.test(password) &&
                   /[a-z]/.test(password) &&
                   /\d/.test(password) &&
                   /[!@#$%^&*(),.?":{}|<>]/.test(password);
        }
        
        function showError(message) {
            showMessage(message, 'danger', 'exclamation-triangle');
        }
        
        function showSuccess(message) {
            showMessage(message, 'success', 'check-circle');
        }
        
        function showMessage(message, type, icon) {
            const alertContainer = document.querySelector('.auth-body');
            const existingAlert = alertContainer.querySelector('.alert');
            
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                <i class="fas fa-${icon} me-2" aria-hidden="true"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            alertContainer.insertBefore(alert, alertContainer.firstChild);
            
            // Auto-dismiss after 5 seconds for non-success messages
            if (type !== 'success') {
                setTimeout(() => {
                    if (alert.parentNode) {
                        bootstrap.Alert.getInstance(alert)?.close();
                    }
                }, 5000);
            }
        }
        
        // Security: Clear sensitive fields on page unload
        window.addEventListener('beforeunload', function() {
            document.getElementById('password').value = '';
            document.getElementById('confirm_password').value = '';
        });
    </script>
</body>
</html> 