{% extends "base.html" %}

{% block title %}Demographics - ReViision{% endblock %}

{% block header %}Customer Demographics Analysis{% endblock %}

{% block content %}
<!-- ====================================
     Demographics Analysis Cards
     ==================================== -->

<!-- Age Distribution Card -->
<div class="card chart-card">
    <div class="card-header">
        <h3><i class="fas fa-users me-2"></i>Age Distribution</h3>
        <div class="tooltip">
            <i class="fas fa-info-circle"></i>
            <span class="tooltip-text">Age breakdown of store visitors</span>
        </div>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="ageChart"></canvas>
        </div>
    </div>
</div>

<!-- Gender Distribution Card -->
<div class="card chart-card">
    <div class="card-header">
        <h3><i class="fas fa-venus-mars me-2"></i>Gender Distribution</h3>
        <div class="tooltip">
            <i class="fas fa-info-circle"></i>
            <span class="tooltip-text">Gender breakdown of store visitors</span>
        </div>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="genderChart"></canvas>
        </div>
    </div>
</div>

<!-- Demographic Trends Over Time Card -->
<div class="card chart-card">
    <div class="card-header">
        <h3><i class="fas fa-chart-line me-2"></i>Demographic Trends Over Time</h3>
        <div class="tooltip">
            <i class="fas fa-info-circle"></i>
            <span class="tooltip-text">Changes in demographics over time period</span>
        </div>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="demographicTrends"></canvas>
        </div>
    </div>
</div>

<!-- Detailed Demographics Data Card -->
<div class="card chart-card">
    <div class="card-header">
        <h3><i class="fas fa-table me-2"></i>Detailed Demographics Data</h3>
        <div class="tooltip">
            <i class="fas fa-info-circle"></i>
            <span class="tooltip-text">Raw demographic data from analysis</span>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="demographicsTable">
                <thead class="table-dark">
                    <tr>
                        <th><i class="fas fa-calendar me-1"></i>Date & Time</th>
                        <th><i class="fas fa-birthday-cake me-1"></i>Age Group</th>
                        <th><i class="fas fa-venus-mars me-1"></i>Gender</th>
                        <th><i class="fas fa-smile me-1"></i>Emotion</th>
                        <th><i class="fas fa-clock me-1"></i>Dwell Time (min)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>Loading data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ====================================
    // Demographics Page JavaScript
    // ====================================

    /**
     * Initialize the page when DOM is loaded
     */
    document.addEventListener('DOMContentLoaded', function() {
        fetchDemographicData();
        setupEventHandlers();
    });

    /**
     * Setup event handlers for time range changes
     */
    function setupEventHandlers() {
        const timeRangeElement = document.getElementById('time-range');
        if (timeRangeElement) {
            timeRangeElement.addEventListener('change', function() {
                fetchDemographicData();
            });
        }
    }

    /**
     * Fetch demographic data and create charts
     */
    function fetchDemographicData() {
        const timeRangeElement = document.getElementById('time-range');
        const timeRange = timeRangeElement ? timeRangeElement.value : '24h';
        const dates = getTimeRangeDates(timeRange);
        
        // Simulate API call with loading delay
        setTimeout(() => {
            createAgeChart();
            createGenderChart();
            createDemographicTrendsChart(dates.start, dates.end);
            populateDemographicsTable();
        }, 300);
    }

    /**
     * Calculate date range based on selection
     */
    function getTimeRangeDates(range) {
        const end = new Date();
        let start = new Date();
        
        switch(range) {
            case '1h':
                start.setHours(end.getHours() - 1);
                break;
            case '6h':
                start.setHours(end.getHours() - 6);
                break;
            case '24h':
                start.setDate(end.getDate() - 1);
                break;
            case '7d':
                start.setDate(end.getDate() - 7);
                break;
            case '30d':
                start.setDate(end.getDate() - 30);
                break;
            default:
                start.setDate(end.getDate() - 1);
        }
        
        return { start, end };
    }

    /**
     * Create age distribution bar chart
     */
    function createAgeChart() {
        const ctx = document.getElementById('ageChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['18-24', '25-34', '35-44', '45-54', '55-64', '65+'],
                datasets: [{
                    label: 'Visitors by Age Group',
                    data: [120, 190, 150, 110, 85, 55],
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(155, 89, 182, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(230, 126, 34, 0.7)',
                        'rgba(231, 76, 60, 0.7)'
                    ],
                    borderColor: [
                        'rgba(52, 152, 219, 1)',
                        'rgba(46, 204, 113, 1)',
                        'rgba(155, 89, 182, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(230, 126, 34, 1)',
                        'rgba(231, 76, 60, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((acc, data) => acc + data, 0);
                                const percentage = Math.round((context.raw / total) * 100);
                                return `${context.label}: ${context.formattedValue} visitors (${percentage}%)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Age Group'
                        }
                    }
                }
            }
        });
    }

    /**
     * Create gender distribution pie chart
     */
    function createGenderChart() {
        const ctx = document.getElementById('genderChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Male', 'Female', 'Other/Unknown'],
                datasets: [{
                    data: [55, 42, 3],
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(231, 76, 60, 0.7)',
                        'rgba(149, 165, 166, 0.7)'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.formattedValue || '';
                                const dataset = context.dataset;
                                const total = dataset.data.reduce((acc, data) => acc + data, 0);
                                const percentage = Math.round((context.raw / total) * 100);
                                return `${label}: ${value} visitors (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    /**
     * Create demographic trends line chart
     */
    function createDemographicTrendsChart(start, end) {
        const ctx = document.getElementById('demographicTrends').getContext('2d');
        
        // Generate sample data between start and end dates
        const dates = [];
        const maleData = [];
        const femaleData = [];
        
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const step = Math.max(1, Math.ceil(diffDays / 7)); // Maximum 7 data points
        
        for (let i = 0; i <= diffDays; i += step) {
            const date = new Date(start);
            date.setDate(date.getDate() + i);
            dates.push(date.toLocaleDateString());
            
            // Generate realistic sample data
            maleData.push(Math.floor(Math.random() * 100) + 50);
            femaleData.push(Math.floor(Math.random() * 80) + 40);
        }
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Male Visitors',
                        data: maleData,
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: 'rgba(52, 152, 219, 1)',
                        pointBorderWidth: 2
                    },
                    {
                        label: 'Female Visitors',
                        data: femaleData,
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: 'rgba(231, 76, 60, 1)',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    /**
     * Populate the demographics data table
     */
    function populateDemographicsTable() {
        const tableBody = document.querySelector('#demographicsTable tbody');
        
        // Generate sample data
        const sampleData = generateSampleDemographicsData();
        
        tableBody.innerHTML = '';
        
        sampleData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><i class="fas fa-calendar-alt me-1 text-muted"></i>${row.datetime}</td>
                <td><span class="badge bg-primary">${row.ageGroup}</span></td>
                <td><i class="fas fa-${row.gender === 'Male' ? 'mars' : row.gender === 'Female' ? 'venus' : 'question'} me-1"></i>${row.gender}</td>
                <td><span class="badge bg-${getEmotionBadgeClass(row.emotion)}">${row.emotion}</span></td>
                <td><i class="fas fa-clock me-1 text-muted"></i>${row.dwellTime}</td>
            `;
            tableBody.appendChild(tr);
        });
    }

    /**
     * Generate sample demographics data
     */
    function generateSampleDemographicsData() {
        const ageGroups = ['18-24', '25-34', '35-44', '45-54', '55-64', '65+'];
        const genders = ['Male', 'Female', 'Unknown'];
        const emotions = ['Happy', 'Neutral', 'Surprised', 'Sad', 'Angry'];
        const data = [];
        
        for (let i = 0; i < 15; i++) {
            const date = new Date();
            date.setHours(date.getHours() - Math.floor(Math.random() * 24));
            
            data.push({
                datetime: date.toLocaleString(),
                ageGroup: ageGroups[Math.floor(Math.random() * ageGroups.length)],
                gender: genders[Math.floor(Math.random() * genders.length)],
                emotion: emotions[Math.floor(Math.random() * emotions.length)],
                dwellTime: (Math.random() * 30 + 1).toFixed(1)
            });
        }
        
        return data.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
    }

    /**
     * Get appropriate badge class for emotion
     */
    function getEmotionBadgeClass(emotion) {
        const badgeClasses = {
            'Happy': 'success',
            'Neutral': 'secondary',
            'Surprised': 'warning',
            'Sad': 'info',
            'Angry': 'danger'
        };
        return badgeClasses[emotion] || 'secondary';
    }
</script>
{% endblock %} 