{% extends "base.html" %}

{% block title %}Demographics Analysis - ReViision{% endblock %}

{% block styles %}
<style>
/* Demographics-specific styles using design system */
.chart-container {
    position: relative;
    height: 400px;
    width: 100%;
}

.demographic-stat {
    text-align: center;
    padding: var(--spacing-4);
    background: white;
    border: 1px solid var(--color-border-primary);
    border-radius: var(--radius-lg);
    transition: var(--transition-all);
    box-shadow: var(--shadow-sm);
}

.demographic-stat:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.demographic-stat-value {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary-600);
    margin-bottom: var(--spacing-2);
}

.demographic-stat-label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.filter-section {
    background: var(--color-surface-primary);
    border: 1px solid var(--color-border-primary);
    border-radius: var(--radius-xl);
    padding: var(--spacing-6);
    margin-bottom: var(--spacing-6);
}

/* Ensure gender distribution header and icon are white */
.demographics-section .section-title {
    color: white;
}

.demographics-section .section-title i {
    color: white;
}

/* Better spacing for larger screens */
@media (min-width: 1200px) {
    .demographic-stat {
        padding: var(--spacing-6);
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
}

@media (min-width: 1400px) {
    .demographic-stat {
        padding: var(--spacing-8);
        min-height: 140px;
    }
}

/* Demographics stats grid - match width of data filter above */
.demographics-stats-container {
    width: 100%;
    padding: 0;
    margin: 0 auto 1.5rem auto; /* Match gap between cards */
}

.demographics-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    width: 100%;
}

/* Desktop - 4 columns matching filter width */
@media (min-width: 992px) {
    .demographics-stats-container {
        padding: 0;
        margin: 0 auto 2rem auto; /* Match desktop gap */
    }

    .demographics-stats-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 2rem;
    }
}

/* Large desktop - maintain proportions */
@media (min-width: 1200px) {
    .demographics-stats-container {
        margin: 0 auto 2.5rem auto; /* Match large desktop gap */
    }

    .demographics-stats-grid {
        gap: 2.5rem;
    }
}

@media (max-width: 767px) {
    .chart-container {
        height: 300px;
    }

    .demographic-stat-value {
        font-size: var(--font-size-2xl);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container py-6">
    <!-- Page Header -->
    <div class="mb-8 d-flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold text-primary mb-2">Demographics Analysis</h1>
            <p class="text-secondary">Comprehensive customer demographic insights and trends</p>
        </div>
        <div class="d-flex gap-3">
            <button class="btn btn-outline-primary" id="generate-demographics-report" title="Generate comprehensive PDF report">
                <i class="fas fa-file-pdf mr-2"></i>
                Generate Report
            </button>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="card mb-6">
        <div class="card-body p-4">
            <nav class="nav nav-pills d-flex flex-wrap gap-2" id="demographics-nav">
                <a class="nav-link active" href="#overview" data-section="overview">
                    <i class="fas fa-chart-pie mr-2"></i>
                    Overview
                </a>
                <a class="nav-link" href="#age-analysis" data-section="age">
                    <i class="fas fa-birthday-cake mr-2"></i>
                    Age Analysis
                </a>
                <a class="nav-link" href="#gender-analysis" data-section="gender">
                    <i class="fas fa-venus-mars mr-2"></i>
                    Gender Analysis
                </a>
                <a class="nav-link" href="#emotion-analysis" data-section="emotion">
                    <i class="fas fa-smile mr-2"></i>
                    Emotion Analysis
                </a>
                <a class="nav-link" href="#trends" data-section="trends">
                    <i class="fas fa-chart-line mr-2"></i>
                    Trends
                </a>
            </nav>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filter-section">
        <h3 class="text-lg font-semibold mb-4">
            <i class="fas fa-filter text-primary mr-2"></i>
            Data Filters
        </h3>
        <div class="d-grid grid-cols-1 tablet-grid-cols-2 desktop-grid-cols-4 gap-4">
            <div class="form-group">
                <label for="time-range" class="form-label">Time Range</label>
                <select class="form-control" id="time-range">
                    <option value="1h">Last Hour</option>
                    <option value="6h">Last 6 Hours</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d" selected>Last 30 Days</option>
                </select>
            </div>
            <div class="form-group">
                <label for="age-filter" class="form-label">Age Group</label>
                <select class="form-control" id="age-filter">
                    <option value="all">All Ages</option>
                    <option value="child">Children (0-12)</option>
                    <option value="teen">Teenagers (13-19)</option>
                    <option value="adult">Adults (20-64)</option>
                    <option value="senior">Seniors (65+)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="gender-filter" class="form-label">Gender</label>
                <select class="form-control" id="gender-filter">
                    <option value="all">All Genders</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div class="form-group d-flex items-end">
                <button class="btn btn-primary w-full" id="apply-filters">
                    <i class="fas fa-search"></i>
                    Apply Filters
                </button>
            </div>
        </div>
    </div>
    <!-- Content Sections -->
    <div id="content-sections">
        <!-- Overview Section -->
        <div id="overview-section" class="content-section">
            <!-- Summary Stats -->
            <div class="demographics-stats-container">
                <div class="demographics-stats-grid">
                <div class="demographic-stat">
                    <div class="demographic-stat-value" id="total-visitors">--</div>
                    <div class="demographic-stat-label">Total Visitors</div>
                </div>
                <div class="demographic-stat">
                    <div class="demographic-stat-value" id="avg-age">--</div>
                    <div class="demographic-stat-label">Average Age</div>
                </div>
                <div class="demographic-stat">
                    <div class="demographic-stat-value" id="male-percentage">--</div>
                    <div class="demographic-stat-label">Male %</div>
                </div>
                <div class="demographic-stat">
                    <div class="demographic-stat-value" id="female-percentage">--</div>
                    <div class="demographic-stat-label">Female %</div>
                </div>
                </div>
            </div>

            <!-- Overview Charts -->
            <div class="d-grid grid-cols-1 desktop-grid-cols-2 gap-6">
                <div class="card">
                    <div class="card-header card-header-primary">
                        <h3 class="card-title">
                            <i class="fas fa-chart-pie"></i>
                            Age Distribution
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="overview-age-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header card-header-primary">
                        <h3 class="card-title" style="color: white;">
                            <i class="fas fa-venus-mars" style="color: white;"></i>
                            Gender Distribution
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="overview-gender-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Age Analysis Section -->
        <div id="age-section" class="content-section d-none">
            <div class="card mb-6">
                <div class="card-header card-header-warning">
                    <h3 class="card-title" style="color: white;">
                        <i class="fas fa-birthday-cake" style="color: white;"></i>
                        <span style="color: white;">Detailed Age Analysis</span>
                    </h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="detailed-age-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Age Trends -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" style="color: white;">
                        <i class="fas fa-chart-line" style="color: white;"></i>
                        <span style="color: white;">Age Trends Over Time</span>
                    </h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="age-trends-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gender Analysis Section -->
        <div id="gender-section" class="content-section d-none">
            <div class="d-grid grid-cols-1 desktop-grid-cols-2 gap-6">
                <div class="card">
                    <div class="card-header card-header-primary">
                        <h3 class="card-title">
                            <i class="fas fa-mars"></i>
                            Male Demographics
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="male-demographics-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header card-header-danger">
                        <h3 class="card-title" style="color: white;">
                            <i class="fas fa-venus" style="color: white;"></i>
                            <span style="color: white;">Female Demographics</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="female-demographics-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gender Trends -->
            <div class="card mt-6">
                <div class="card-header card-header-success">
                    <h3 class="card-title">
                        <i class="fas fa-chart-area"></i>
                        Gender Distribution Trends
                    </h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="gender-trends-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emotion Analysis Section -->
        <div id="emotion-section" class="content-section d-none">
            <div class="card mb-6">
                <div class="card-header card-header-success">
                    <h3 class="card-title" style="color: white;">
                        <i class="fas fa-smile" style="color: white;"></i>
                        <span style="color: white;">Emotion Distribution</span>
                    </h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="emotion-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Emotion by Demographics -->
            <div class="d-grid grid-cols-1 desktop-grid-cols-2 xl-grid-cols-2 xxl-grid-cols-3 ultra-grid-cols-4 ultrawide-grid-cols-5 gap-6 card-grid-responsive">
                <div class="card chart-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-bar"></i>
                            Emotions by Age Group
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="emotion-age-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card chart-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-bar"></i>
                            Emotions by Gender
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="emotion-gender-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trends Section -->
        <div id="trends-section" class="content-section d-none">
            <div class="card">
                <div class="card-header card-header-primary">
                    <h3 class="card-title">
                        <i class="fas fa-chart-line"></i>
                        Comprehensive Demographic Trends
                    </h3>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 500px;">
                        <canvas id="comprehensive-trends-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>




</div>

<style>
/* Additional Demographics Styles */
.demographics-section {
    background: var(--color-surface-primary);
    border: 1px solid var(--color-border-primary);
    border-radius: var(--radius-xl);
    padding: var(--spacing-6);
    margin-bottom: var(--spacing-6);
}

.section-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-4);
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
}

.demographics-nav {
    background: var(--color-surface-primary);
    border: 1px solid var(--color-border-primary);
    border-radius: var(--radius-xl);
    padding: var(--spacing-6);
    margin-bottom: var(--spacing-6);
}

.chart-container {
    position: relative;
    height: 400px;
    width: 100%;
    margin-bottom: 1rem;
}

.chart-container canvas {
    max-height: 400px;
}

.tooltip {
    position: relative;
    display: inline-block;
    cursor: help;
}

.tooltip i {
    color: #6c757d;
    font-size: 1.1rem;
    transition: color 0.3s ease;
}

.tooltip:hover i {
    color: #3498db;
}

.tooltip-text {
    visibility: hidden;
    width: 200px;
    background-color: rgba(0, 0, 0, 0.9);
    color: white;
    text-align: center;
    border-radius: 8px;
    padding: 0.75rem;
    position: absolute;
    z-index: 1000;
    bottom: 125%;
    right: 0;
    font-size: 0.9rem;
    font-weight: 400;
    opacity: 0;
    transition: opacity 0.3s ease;
    backdrop-filter: blur(10px);
}

.tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

@media (max-width: 768px) {
    .chart-container {
        height: 300px;
    }
}

/* Demographics page specific styles - notification styles moved to global CSS */

/* Section switching styles */
.content-section {
    transition: opacity 0.3s ease-in-out;
}

.content-section.d-none {
    display: none !important;
}

/* Navigation active state */
#demographics-nav .nav-link.active {
    background-color: var(--color-primary-600);
    color: white;
}

#demographics-nav .nav-link:hover {
    background-color: var(--color-primary-100);
    color: var(--color-primary-700);
}
</style>
{% endblock %}
{% block scripts %}
<!-- Chart.js is now globally loaded via base.html; plugins & ChartManager included there -->
<script>
// Demographics Page JavaScript
class DemographicsManager {
    constructor() {
        this.charts = {};
        this.currentData = null;
        this.init();
    }

    init() {
        this.setupEventHandlers();
        this.loadData();
        // Show overview section by default
        this.switchSection('overview');
    }

    switchSection(sectionName) {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.add('d-none');
        });

        // Show selected section
        const targetSection = document.getElementById(`${sectionName}-section`);
        if (targetSection) {
            targetSection.classList.remove('d-none');
        }

        // Load section-specific data
        this.loadSectionData(sectionName);
    }

    loadSectionData(sectionName) {
        switch(sectionName) {
            case 'overview':
                this.loadOverviewData();
                break;
            case 'age':
                this.loadAgeAnalysisData();
                break;
            case 'gender':
                this.loadGenderAnalysisData();
                break;
            case 'emotion':
                this.loadEmotionAnalysisData();
                break;
            case 'trends':
                this.loadTrendsData();
                break;
            default:
                this.loadOverviewData();
        }
    }

    loadOverviewData() {
        // Load overview charts and stats
        this.loadData();
    }

    loadAgeAnalysisData() {
        // Load detailed age analysis
        console.log('Loading age analysis data...');
    }

    loadGenderAnalysisData() {
        // Load detailed gender analysis
        console.log('Loading gender analysis data...');
    }

    loadEmotionAnalysisData() {
        // Load emotion analysis
        console.log('Loading emotion analysis data...');
    }

    loadTrendsData() {
        // Load trends data
        console.log('Loading trends data...');
    }

    setupEventHandlers() {
        // Section navigation
        document.querySelectorAll('#demographics-nav [data-section]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.currentTarget.getAttribute('data-section');
                this.switchSection(section);

                // Update active nav link
                document.querySelectorAll('#demographics-nav .nav-link').forEach(l => l.classList.remove('active'));
                e.currentTarget.classList.add('active');
            });
        });

        // Filter changes - auto-apply filters when changed
        document.getElementById('time-range').addEventListener('change', () => {
            this.loadData();
        });

        document.getElementById('age-filter').addEventListener('change', () => {
            this.loadData();
        });

        document.getElementById('gender-filter').addEventListener('change', () => {
            this.loadData();
        });

        // Apply filters button (for manual trigger if needed)
        document.getElementById('apply-filters').addEventListener('click', () => {
            this.loadData();
        });

        // Refresh button
        document.getElementById('refresh-demographics').addEventListener('click', () => {
            this.loadData();
        });

        // Tab changes
        document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', (e) => {
                this.handleTabChange(e.target);
            });
        });

        // Report generation
        document.getElementById('generate-demographics-report').addEventListener('click', () => {
            this.generateReport();
        });
    }

    handleTabChange(tab) {
        // Resize charts when tab becomes visible
        setTimeout(() => {
            Object.values(this.charts).forEach(chart => {
                if (!chart) return;
                if (typeof chart.resize === 'function') {
                    chart.resize();
                } else if (chart.chart && typeof chart.chart.resize === 'function') {
                    chart.chart.resize();
                }
            });
        }, 100);
    }

    async loadData() {
        try {
            const filterParams = this.getFilterParams();
            const queryString = new URLSearchParams(filterParams).toString();
            const response = await fetch(`/api/analytics/summary?${queryString}`, {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    // Authentication issue - redirect to login
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // Check if response is actually JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                // Likely got HTML (login page) instead of JSON
                console.warn('Received HTML instead of JSON - redirecting to login');
                window.location.href = '/login';
                return;
            }

            const data = await response.json();

            if (data.success) {
                this.currentData = data;
                this.updateStatistics(data);
                this.updateCharts(data);
                this.showSuccessMessage('Demographic data loaded successfully');
            } else {
                this.showNoDataState();
                showNotification('No data available for the selected time period', 'warning');
            }
        } catch (error) {
            console.error('Error loading data:', error);
            this.showNoDataState();
            showNotification('Failed to load demographic data. Please try again.', 'error');
        }
    }

    showSuccessMessage(message) {
        showNotification(message, 'success');
    }

    updateStatistics(data) {
        // Update summary statistics cards
        document.getElementById('total-visitors').textContent = (data.total_visitors || 0).toLocaleString();
        document.getElementById('avg-age').textContent = data.avg_age ? `${data.avg_age.toFixed(1)} years` : '--';

        // Calculate gender percentages
        const genderDist = data.gender_distribution || {};
        const total = Object.values(genderDist).reduce((sum, count) => sum + count, 0);

        if (total > 0) {
            // Handle both capitalized and lowercase keys from database
            const maleCount = genderDist.Male || genderDist.male || 0;
            const femaleCount = genderDist.Female || genderDist.female || 0;
            const malePercent = ((maleCount / total) * 100).toFixed(1);
            const femalePercent = ((femaleCount / total) * 100).toFixed(1);

            document.getElementById('male-percentage').textContent = `${malePercent}%`;
            document.getElementById('female-percentage').textContent = `${femalePercent}%`;
        } else {
            document.getElementById('male-percentage').textContent = '--';
            document.getElementById('female-percentage').textContent = '--';
        }
    }

    updateCharts(data) {
        // Overview charts
        this.createOverviewAgeChart(data);
        this.createOverviewGenderChart(data);

        // Detailed age analysis
        this.createDetailedAgeChart(data);
        this.createAgeTrendsChart(data);

        // Gender breakdown
        this.createMaleDemographicsChart(data);
        this.createFemaleDemographicsChart(data);
        this.createGenderTrendsChart(data);

        // Emotion analysis
        this.createEmotionCharts(data);
        this.createEmotionByAgeChart(data);
        this.createEmotionByGenderChart(data);

        // Comprehensive trends
        this.createComprehensiveTrendsChart(data);
    }

    createOverviewAgeChart(data) {
        const ctx = document.getElementById('overview-age-chart');
        if (!ctx) return;

        if (this.charts.overviewAge) {
            this.charts.overviewAge.destroy();
        }

        const ageData = data.age_groups || {};
        const labels = Object.keys(ageData);
        const values = Object.values(ageData);

        const ageConfig = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors by Age Group',
                    data: values,
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(155, 89, 182, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(230, 126, 34, 0.7)',
                        'rgba(231, 76, 60, 0.7)'
                    ],
                    borderColor: [
                        'rgba(52, 152, 219, 1)',
                        'rgba(46, 204, 113, 1)',
                        'rgba(155, 89, 182, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(230, 126, 34, 1)',
                        'rgba(231, 76, 60, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Age Group'
                        }
                    }
                }
            }
        };

        this.charts.overviewAge = new ChartManager(ctx, ageConfig, { filename: 'age_distribution' });
        this.attachToolbar('overview-age-chart', this.charts.overviewAge);
    }

    createOverviewGenderChart(data) {
        const ctx = document.getElementById('overview-gender-chart');
        if (!ctx) return;

        if (this.charts.overviewGender) {
            this.charts.overviewGender.destroy();
        }

        const genderData = data.gender_distribution || {};
        // Normalize gender keys to handle both capitalized and lowercase
        const normalizedGenderData = {};
        Object.entries(genderData).forEach(([key, value]) => {
            const normalizedKey = key.charAt(0).toUpperCase() + key.slice(1).toLowerCase();
            normalizedGenderData[normalizedKey] = value;
        });

        const labels = Object.keys(normalizedGenderData);
        const values = Object.values(normalizedGenderData);

        const genderConfig = {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Gender Distribution',
                    data: values,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(255, 206, 86, 0.8)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        };

        this.charts.overviewGender = new ChartManager(ctx, genderConfig, { filename: 'gender_distribution' });
        this.attachToolbar('overview-gender-chart', this.charts.overviewGender);
    }

    createEmotionCharts(data) {
        // Create emotion distribution chart
        const emotionCtx = document.getElementById('emotion-chart');
        if (emotionCtx) {
            if (this.charts.emotion) {
                this.charts.emotion.destroy();
            }

            const emotionData = data.emotions || {};
            const labels = Object.keys(emotionData).map(key => key.charAt(0).toUpperCase() + key.slice(1));
            const values = Object.values(emotionData);

            const emotionConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Emotion Distribution',
                        data: values,
                        backgroundColor: [
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(23, 162, 184, 0.8)',
                            'rgba(108, 117, 125, 0.8)',
                            'rgba(102, 16, 242, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 193, 7, 1)',
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)',
                            'rgba(23, 162, 184, 1)',
                            'rgba(108, 117, 125, 1)',
                            'rgba(102, 16, 242, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Detections'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Emotion'
                            }
                        }
                    }
                }
            };

            this.charts.emotion = new ChartManager(emotionCtx, emotionConfig, { filename: 'emotion_distribution' });
            this.attachToolbar('emotion-chart', this.charts.emotion);
        }
    }

    createDemographicTrendsChart(data) {
        const ctx = document.getElementById('demographic-trends-chart');
        if (!ctx) return;

        if (this.charts.trends) {
            this.charts.trends.destroy();
        }

        // Create a comprehensive trends chart combining age and gender data
        const ageData = data.age_groups || {};
        const genderData = data.gender_distribution || {};

        const ageLabels = Object.keys(ageData);
        const ageValues = Object.values(ageData);

        const trendsConfig = {
            type: 'line',
            data: {
                labels: ageLabels,
                datasets: [{
                    label: 'Age Distribution Trend',
                    data: ageValues,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Age Groups'
                        }
                    }
                }
            }
        };

        this.charts.trends = new ChartManager(ctx, trendsConfig, { filename: 'demographic_trends' });
        this.attachToolbar('demographic-trends-chart', this.charts.trends);
    }

    createDetailedAgeChart(data) {
        const ctx = document.getElementById('detailed-age-chart');
        if (!ctx) return;

        if (this.charts.detailedAge) {
            this.charts.detailedAge.destroy();
        }

        const ageData = data.age_groups || {};
        const labels = Object.keys(ageData);
        const values = Object.values(ageData);

        const detailedAgeConfig = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Detailed Age Distribution',
                    data: values,
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        };

        this.charts.detailedAge = new ChartManager(ctx, detailedAgeConfig, { filename: 'detailed_age_analysis' });
        this.attachToolbar('detailed-age-chart', this.charts.detailedAge);
    }

    createAgeTrendsChart(data) {
        const ctx = document.getElementById('age-trends-chart');
        if (!ctx) return;

        if (this.charts.ageTrends) {
            this.charts.ageTrends.destroy();
        }

        const ageData = data.age_groups || {};
        const labels = Object.keys(ageData);
        const values = Object.values(ageData);

        const ageTrendsConfig = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Age Trends',
                    data: values,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        };

        this.charts.ageTrends = new ChartManager(ctx, ageTrendsConfig, { filename: 'age_trends' });
        this.attachToolbar('age-trends-chart', this.charts.ageTrends);
    }

    createMaleDemographicsChart(data) {
        const ctx = document.getElementById('male-demographics-chart');
        if (!ctx) return;

        if (this.charts.maleDemographics) {
            this.charts.maleDemographics.destroy();
        }

        const genderData = data.gender_distribution || {};
        const maleCount = genderData.Male || genderData.male || 0;
        const total = Object.values(genderData).reduce((sum, count) => sum + count, 0);
        const malePercentage = total > 0 ? ((maleCount / total) * 100).toFixed(1) : 0;

        const maleConfig = {
            type: 'doughnut',
            data: {
                labels: ['Male', 'Others'],
                datasets: [{
                    data: [maleCount, total - maleCount],
                    backgroundColor: ['rgba(54, 162, 235, 0.8)', 'rgba(200, 200, 200, 0.3)'],
                    borderColor: ['rgba(54, 162, 235, 1)', 'rgba(200, 200, 200, 1)'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        };

        this.charts.maleDemographics = new ChartManager(ctx, maleConfig, { filename: 'male_demographics' });
        this.attachToolbar('male-demographics-chart', this.charts.maleDemographics);
    }

    createFemaleDemographicsChart(data) {
        const ctx = document.getElementById('female-demographics-chart');
        if (!ctx) return;

        if (this.charts.femaleDemographics) {
            this.charts.femaleDemographics.destroy();
        }

        const genderData = data.gender_distribution || {};
        const femaleCount = genderData.Female || genderData.female || 0;
        const total = Object.values(genderData).reduce((sum, count) => sum + count, 0);
        const femalePercentage = total > 0 ? ((femaleCount / total) * 100).toFixed(1) : 0;

        const femaleConfig = {
            type: 'doughnut',
            data: {
                labels: ['Female', 'Others'],
                datasets: [{
                    data: [femaleCount, total - femaleCount],
                    backgroundColor: ['rgba(255, 99, 132, 0.8)', 'rgba(200, 200, 200, 0.3)'],
                    borderColor: ['rgba(255, 99, 132, 1)', 'rgba(200, 200, 200, 1)'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        };

        this.charts.femaleDemographics = new ChartManager(ctx, femaleConfig, { filename: 'female_demographics' });
        this.attachToolbar('female-demographics-chart', this.charts.femaleDemographics);
    }

    createGenderTrendsChart(data) {
        const ctx = document.getElementById('gender-trends-chart');
        if (!ctx) return;

        if (this.charts.genderTrends) {
            this.charts.genderTrends.destroy();
        }

        const genderData = data.gender_distribution || {};
        const labels = Object.keys(genderData);
        const values = Object.values(genderData);

        const genderTrendsConfig = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Gender Distribution Trends',
                    data: values,
                    borderColor: 'rgba(153, 102, 255, 1)',
                    backgroundColor: 'rgba(153, 102, 255, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        };

        this.charts.genderTrends = new ChartManager(ctx, genderTrendsConfig, { filename: 'gender_trends' });
        this.attachToolbar('gender-trends-chart', this.charts.genderTrends);
    }

    createEmotionByAgeChart(data) {
        const ctx = document.getElementById('emotion-age-chart');
        if (!ctx) return;

        if (this.charts.emotionAge) {
            this.charts.emotionAge.destroy();
        }

        // Create a simplified emotion by age chart
        const emotionData = data.emotions || {};
        const labels = Object.keys(emotionData);
        const values = Object.values(emotionData);

        const emotionAgeConfig = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Emotions by Age Group',
                    data: values,
                    backgroundColor: 'rgba(255, 206, 86, 0.8)',
                    borderColor: 'rgba(255, 206, 86, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        };

        this.charts.emotionAge = new ChartManager(ctx, emotionAgeConfig, { filename: 'emotion_by_age' });
        this.attachToolbar('emotion-age-chart', this.charts.emotionAge);
    }

    createEmotionByGenderChart(data) {
        const ctx = document.getElementById('emotion-gender-chart');
        if (!ctx) return;

        if (this.charts.emotionGender) {
            this.charts.emotionGender.destroy();
        }

        // Create a simplified emotion by gender chart
        const emotionData = data.emotions || {};
        const labels = Object.keys(emotionData);
        const values = Object.values(emotionData);

        const emotionGenderConfig = {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Emotions by Gender',
                    data: values,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true
                    }
                }
            }
        };

        this.charts.emotionGender = new ChartManager(ctx, emotionGenderConfig, { filename: 'emotion_by_gender' });
        this.attachToolbar('emotion-gender-chart', this.charts.emotionGender);
    }

    createComprehensiveTrendsChart(data) {
        const ctx = document.getElementById('comprehensive-trends-chart');
        if (!ctx) return;

        if (this.charts.comprehensiveTrends) {
            this.charts.comprehensiveTrends.destroy();
        }

        // Create a comprehensive chart combining multiple data sources
        const ageData = data.age_groups || {};
        const genderData = data.gender_distribution || {};
        const emotionData = data.emotions || {};

        const ageLabels = Object.keys(ageData);
        const ageValues = Object.values(ageData);
        const genderValues = Object.values(genderData);

        const comprehensiveConfig = {
            type: 'line',
            data: {
                labels: ageLabels,
                datasets: [
                    {
                        label: 'Age Distribution',
                        data: ageValues,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Demographics'
                        }
                    }
                }
            }
        };

        this.charts.comprehensiveTrends = new ChartManager(ctx, comprehensiveConfig, { filename: 'comprehensive_trends' });
        this.attachToolbar('comprehensive-trends-chart', this.charts.comprehensiveTrends);
    }

    getFilterParams() {
        const timeMap = { '1h': 1, '6h': 6, '24h': 24, '7d': 168, '30d': 720 };
        const timeRange = document.getElementById('time-range').value || '30d';
        const ageFilter = document.getElementById('age-filter').value || 'all';
        const genderFilter = document.getElementById('gender-filter').value || 'all';

        const params = {
            hours: timeMap[timeRange] || 720  // Default to 30 days
        };

        if (ageFilter !== 'all') {
            params.age_filter = ageFilter;
        }

        if (genderFilter !== 'all') {
            params.gender_filter = genderFilter;
        }

        return params;
    }

    getHoursFromRange() {
        const range = document.getElementById('time-range').value;
        const map = {
            '1h': 1,
            '6h': 6,
            '24h': 24,
            '7d': 168,
            '30d': 720
        };
        return map[range] || 720;  // Default to 30 days
    }

    showNoDataState() {
        // Clear charts
        Object.values(this.charts).forEach(chart => {
            if (chart) {
                chart.destroy();
            }
        });
        this.charts = {};
    }



    attachToolbar(chartId, chart) {
        // Toolbar functionality would go here
        console.log('Toolbar attached for', chartId);
    }

    async generateReport() {
        try {
            const button = document.getElementById('generate-demographics-report');
            const originalText = button.innerHTML;

            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';

            // Get current time range
            const hours = this.getHoursFromRange();

            // Generate report URL
            const reportUrl = `/api/reports/demographics/pdf?hours=${hours}`;

            // Fetch the PDF as a blob
            const response = await fetch(reportUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/pdf'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // Get the PDF blob
            const pdfBlob = await response.blob();

            // Create download link
            const downloadUrl = window.URL.createObjectURL(pdfBlob);
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `demographics_report_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.pdf`;

            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Clean up the blob URL
            window.URL.revokeObjectURL(downloadUrl);

            // Show success message
            showNotification('Demographics report generated successfully!', 'success');

        } catch (error) {
            console.error('Error generating report:', error);
            showNotification('Failed to generate report. Please try again.', 'error');
        } finally {
            // Restore button state
            const button = document.getElementById('generate-demographics-report');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>Generate Report';
        }
    }
}

// Initialize demographics manager when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    new DemographicsManager();
});
</script>
{% endblock %}
