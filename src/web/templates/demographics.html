{% extends "base.html" %}

{% block title %}Demographics - ReViision{% endblock %}

{% block header %}Customer Demographics Analysis{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Page Header -->
    <div class="section-header">
        <h1 class="section-title">
            <i class="fas fa-users"></i>
            Demographics Analysis
        </h1>
        <p class="section-subtitle">Customer demographic insights and analytics</p>
    </div>
    
    <!-- Demographics Analysis Cards -->

<!-- Age Distribution Card -->
<div class="modern-card">
    <div class="modern-card-header">
        <h3><i class="fas fa-users me-2"></i>Age Distribution</h3>
        <div class="tooltip">
            <i class="fas fa-info-circle"></i>
            <span class="tooltip-text">Age breakdown of store visitors</span>
        </div>
    </div>
    <div class="modern-card-body">
        <div class="chart-container">
            <canvas id="ageChart"></canvas>
        </div>
    </div>
</div>

<!-- Gender Distribution Card -->
<div class="modern-card">
    <div class="modern-card-header">
        <h3><i class="fas fa-venus-mars me-2"></i>Gender Distribution</h3>
        <div class="tooltip">
            <i class="fas fa-info-circle"></i>
            <span class="tooltip-text">Gender breakdown of store visitors</span>
        </div>
    </div>
    <div class="modern-card-body">
        <div class="chart-container">
            <canvas id="genderChart"></canvas>
        </div>
    </div>
</div>

<!-- Demographic Trends Over Time Card -->
<div class="modern-card">
    <div class="modern-card-header">
        <h3><i class="fas fa-chart-line me-2"></i>Demographic Trends Over Time</h3>
        <div class="tooltip">
            <i class="fas fa-info-circle"></i>
            <span class="tooltip-text">Changes in demographics over time period</span>
        </div>
    </div>
    <div class="modern-card-body">
        <div class="chart-container">
            <canvas id="demographicTrends"></canvas>
        </div>
    </div>
</div>

<!-- Detailed Demographics Data Card -->
<div class="modern-card">
    <div class="modern-card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="d-flex align-items-center">
                <h3 class="mb-0"><i class="fas fa-table me-2"></i>Detailed Demographics Data</h3>
                <div class="tooltip ms-2">
                    <i class="fas fa-info-circle"></i>
                    <span class="tooltip-text">Individual demographic records from analysis</span>
                </div>
            </div>
            <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
                <!-- Search input -->
                <div class="input-group" style="width: 250px;">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="table-search" placeholder="Search records...">
                </div>
                <!-- Results per page -->
                <select class="form-select" id="records-per-page" style="width: auto;">
                    <option value="10">10 per page</option>
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>
                <!-- Refresh button -->
                <button type="button" class="btn btn-outline-primary" id="refresh-table" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <!-- Table loading overlay -->
        <div id="table-loading" class="table-loading-overlay" style="display: none;">
            <div class="d-flex align-items-center justify-content-center h-100">
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <div>Loading records...</div>
                </div>
            </div>
        </div>
        
        <!-- Table container -->
        <div class="table-responsive">
            <table class="table table-striped table-hover table-modern" id="demographicsTable">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th class="sortable" data-sort="timestamp">
                            <i class="fas fa-calendar me-1"></i>Date & Time
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-sort="gender">
                            <i class="fas fa-venus-mars me-1"></i>Gender
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-sort="age">
                            <i class="fas fa-birthday-cake me-1"></i>Age Group
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-sort="emotion">
                            <i class="fas fa-smile me-1"></i>Emotion
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-sort="dwell_time">
                            <i class="fas fa-clock me-1"></i>Dwell Time
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-sort="confidence">
                            <i class="fas fa-percentage me-1"></i>Confidence
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin me-2"></i>Loading data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Table footer with pagination and info -->
        <div class="card-footer bg-light border-top">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <!-- Table info -->
                <div class="table-info">
                    <span id="table-info-text">Showing 0 of 0 records</span>
                </div>
                
                <!-- Pagination controls -->
                <div class="pagination-controls">
                    <nav aria-label="Table pagination">
                        <ul class="pagination pagination-sm mb-0" id="table-pagination">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" id="prev-page">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            <li class="page-item active">
                                <a class="page-link" href="#" data-page="1">1</a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" id="next-page">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Enhanced table styling */
.table-modern {
    margin-bottom: 0;
}

.table-modern th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
    letter-spacing: 0.5px;
    padding: 1rem 0.75rem;
}

.table-modern td {
    padding: 0.875rem 0.75rem;
    vertical-align: middle;
    border-top: 1px solid #dee2e6;
}

.table-modern .sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    transition: background-color 0.2s ease;
}

.table-modern .sortable:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.sort-icon {
    opacity: 0.5;
    font-size: 0.75rem;
    transition: opacity 0.2s ease;
}

.sortable:hover .sort-icon {
    opacity: 1;
}

.sortable.sort-asc .sort-icon:before {
    content: "\f0de"; /* fa-sort-up */
}

.sortable.sort-desc .sort-icon:before {
    content: "\f0dd"; /* fa-sort-down */
}

.table-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 10;
    border-radius: 0.375rem;
}

.badge-gender-male {
    background-color: #007bff;
}

.badge-gender-female {
    background-color: #e83e8c;
}

.badge-gender-unknown {
    background-color: #6c757d;
}

.confidence-bar {
    height: 4px;
    background-color: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    margin-top: 2px;
}

.confidence-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.confidence-high { background-color: #28a745; }
.confidence-medium { background-color: #ffc107; }
.confidence-low { background-color: #dc3545; }

.dwell-time-badge {
    font-family: 'Courier New', monospace;
    font-weight: bold;
}

.table-info {
    color: #6c757d;
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    .card-header .d-flex {
        flex-direction: column;
        align-items: stretch !important;
    }
    
    .card-header .gap-2 {
        margin-top: 1rem !important;
        flex-wrap: wrap;
    }
    
    .input-group {
        width: 100% !important;
        margin-bottom: 0.5rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .pagination-controls {
        margin-top: 1rem;
    }
    
    .card-footer .d-flex {
        flex-direction: column;
        align-items: stretch !important;
        text-align: center;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // ====================================
    // Demographics Page JavaScript
    // ====================================

    /**
     * Initialize the page when DOM is loaded
     */
    document.addEventListener('DOMContentLoaded', function() {
        fetchDemographicData();
        setupEventHandlers();
        initializeTable(); // Initialize table functionality
    });

    /**
     * Setup event handlers for time range changes
     */
    function setupEventHandlers() {
        const timeRangeElement = document.getElementById('time-range');
        if (timeRangeElement) {
            timeRangeElement.addEventListener('change', function() {
                fetchDemographicData();
                // Also reload table data when time range changes
                if (typeof loadTableData === 'function') {
                    currentPage = 1; // Reset to first page
                    loadTableData();
                }
            });
        }
    }

    /**
     * Fetch demographic data and create charts
     */
    async function fetchDemographicData() {
        const timeRangeElement = document.getElementById('time-range');
        const timeRange = timeRangeElement ? timeRangeElement.value : '24h';
        const dates = getTimeRangeDates(timeRange);
        
        // Convert timeRange to hours for API
        const hoursMap = {
            '1h': 1,
            '6h': 6,
            '24h': 24,
            '7d': 168,
            '30d': 720
        };
        const hours = hoursMap[timeRange] || 24;
        
        try {
            // Fetch real demographic data
            const response = await fetch(`/api/analytics/summary?hours=${hours}`);
            const result = await response.json();
            
            if (result.success) {
                // Create charts with real data
                createAgeChart(result.age_groups);
                createGenderChart(result.gender_distribution);
                createDemographicTrendsChart(dates.start, dates.end, result);
            } else {
                // Fallback to empty charts
                console.warn('Failed to fetch demographic data, showing empty charts');
                createAgeChart();
                createGenderChart();
                createDemographicTrendsChart(dates.start, dates.end);
            }
        } catch (error) {
            console.error('Error fetching demographic data:', error);
            // Fallback to empty charts
            createAgeChart();
            createGenderChart();
            createDemographicTrendsChart(dates.start, dates.end);
        }
    }

    /**
     * Calculate date range based on selection
     */
    function getTimeRangeDates(range) {
        const end = new Date();
        let start = new Date();
        
        switch(range) {
            case '1h':
                start.setHours(end.getHours() - 1);
                break;
            case '6h':
                start.setHours(end.getHours() - 6);
                break;
            case '24h':
                start.setDate(end.getDate() - 1);
                break;
            case '7d':
                start.setDate(end.getDate() - 7);
                break;
            case '30d':
                start.setDate(end.getDate() - 30);
                break;
            default:
                start.setDate(end.getDate() - 1);
        }
        
        return { start, end };
    }

    /**
     * Create age distribution bar chart
     */
    function createAgeChart(ageGroups = {}) {
        const ctx = document.getElementById('ageChart').getContext('2d');
        
        // Prepare age data
        const defaultAgeGroups = ['18-24', '25-34', '35-44', '45-54', '55+'];
        const labels = [];
        const data = [];
        
        // Use real data if available
        if (Object.keys(ageGroups).length > 0) {
            for (const group of defaultAgeGroups) {
                if (ageGroups[group]) {
                    labels.push(group);
                    data.push(ageGroups[group]);
                }
            }
        }
        
        // Fallback if no data
        if (labels.length === 0) {
            labels.push('No Data Available');
            data.push(0);
        }
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitors by Age Group',
                    data: data,
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(155, 89, 182, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(230, 126, 34, 0.7)',
                        'rgba(231, 76, 60, 0.7)'
                    ],
                    borderColor: [
                        'rgba(52, 152, 219, 1)',
                        'rgba(46, 204, 113, 1)',
                        'rgba(155, 89, 182, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(230, 126, 34, 1)',
                        'rgba(231, 76, 60, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((acc, data) => acc + data, 0);
                                const percentage = Math.round((context.raw / total) * 100);
                                return `${context.label}: ${context.formattedValue} visitors (${percentage}%)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Age Group'
                        }
                    }
                }
            }
        });
    }

    /**
     * Create gender distribution pie chart
     */
    function createGenderChart(genderDistribution = {}) {
        const ctx = document.getElementById('genderChart').getContext('2d');
        
        // Prepare gender data
        const labels = [];
        const data = [];
        
        // Use real data if available
        if (Object.keys(genderDistribution).length > 0) {
            for (const [gender, count] of Object.entries(genderDistribution)) {
                if (count > 0) {
                    labels.push(gender);
                    data.push(count);
                }
            }
        }
        
        // Fallback if no data
        if (labels.length === 0) {
            labels.push('No Data Available');
            data.push(1);
        }
        
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(231, 76, 60, 0.7)',
                        'rgba(149, 165, 166, 0.7)'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.formattedValue || '';
                                const dataset = context.dataset;
                                const total = dataset.data.reduce((acc, data) => acc + data, 0);
                                const percentage = Math.round((context.raw / total) * 100);
                                return `${label}: ${value} visitors (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    /**
     * Create demographic trends line chart
     */
    function createDemographicTrendsChart(start, end) {
        const ctx = document.getElementById('demographicTrends').getContext('2d');
        
        // Generate sample data between start and end dates
        const dates = [];
        const maleData = [];
        const femaleData = [];
        
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const step = Math.max(1, Math.ceil(diffDays / 7)); // Maximum 7 data points
        
        for (let i = 0; i <= diffDays; i += step) {
            const date = new Date(start);
            date.setDate(date.getDate() + i);
            dates.push(date.toLocaleDateString());
            
            // Generate realistic sample data
            maleData.push(Math.floor(Math.random() * 100) + 50);
            femaleData.push(Math.floor(Math.random() * 80) + 40);
        }
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Male Visitors',
                        data: maleData,
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: 'rgba(52, 152, 219, 1)',
                        pointBorderWidth: 2
                    },
                    {
                        label: 'Female Visitors',
                        data: femaleData,
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: 'rgba(231, 76, 60, 1)',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Visitors'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    // ====================================
    // Table Management Variables
    // ====================================
    let currentPage = 1;
    let recordsPerPage = 10;
    let currentSearch = '';
    let currentSort = 'timestamp';
    let currentSortOrder = 'desc';
    let totalRecords = 0;
    let totalPages = 0;

    /**
     * Initialize table functionality
     */
    function initializeTable() {
        // Search functionality
        const searchInput = document.getElementById('table-search');
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = this.value.trim();
                currentPage = 1; // Reset to first page
                loadTableData();
            }, 500);
        });

        // Records per page dropdown
        const perPageSelect = document.getElementById('records-per-page');
        perPageSelect.addEventListener('change', function() {
            recordsPerPage = parseInt(this.value);
            currentPage = 1; // Reset to first page
            loadTableData();
        });

        // Refresh button
        const refreshBtn = document.getElementById('refresh-table');
        refreshBtn.addEventListener('click', function() {
            loadTableData();
        });

        // Sortable columns
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', function() {
                const sortField = this.dataset.sort;
                
                // Toggle sort order if same field, otherwise default to desc
                if (currentSort === sortField) {
                    currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
                } else {
                    currentSort = sortField;
                    currentSortOrder = 'desc';
                }
                
                updateSortIcons();
                loadTableData();
            });
        });

        // Initial data load
        loadTableData();
    }

    /**
     * Load table data from API
     */
    async function loadTableData() {
        showTableLoading(true);
        
        try {
            const timeRangeElement = document.getElementById('time-range');
            const timeRange = timeRangeElement ? timeRangeElement.value : '24h';
            
            // Convert timeRange to hours for API
            const hoursMap = {
                '1h': 1,
                '6h': 6,
                '24h': 24,
                '7d': 168,
                '30d': 720
            };
            const hours = hoursMap[timeRange] || 24;

            const params = new URLSearchParams({
                page: currentPage,
                per_page: recordsPerPage,
                search: currentSearch,
                sort_by: currentSort,
                sort_order: currentSortOrder,
                hours: hours
            });

            const response = await fetch(`/api/analytics/demographics?${params}`);
            const result = await response.json();

            if (result.success) {
                populateTable(result.data);
                updatePagination(result.pagination);
                updateTableInfo(result.pagination);
            } else {
                showEmptyTable(result.error || 'Failed to load data');
            }
        } catch (error) {
            console.error('Error loading table data:', error);
            showEmptyTable('Error loading data');
        } finally {
            showTableLoading(false);
        }
    }

    /**
     * Populate table with demographic records
     */
    function populateTable(records) {
        const tableBody = document.querySelector('#demographicsTable tbody');
        tableBody.innerHTML = '';

        if (records && records.length > 0) {
            records.forEach(record => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-nowrap">
                        <div class="fw-semibold">${formatDateTime(record.timestamp)}</div>
                        <small class="text-muted">${formatTimeAgo(record.timestamp)}</small>
                    </td>
                    <td>
                        <span class="badge badge-gender-${record.gender.toLowerCase()} text-white">
                            <i class="fas fa-${getGenderIcon(record.gender)} me-1"></i>
                            ${record.gender}
                        </span>
                    </td>
                    <td>
                        <div class="fw-semibold">${record.age_group}</div>
                        <small class="text-muted">${record.age} years old</small>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark border">
                            <i class="fas fa-${getEmotionIcon(record.emotion)} me-1"></i>
                            ${record.emotion}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-info dwell-time-badge">
                            ${formatDwellTime(record.dwell_time)}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="me-2">${Math.round(record.confidence * 100)}%</span>
                            <div class="confidence-bar" style="width: 60px;">
                                <div class="confidence-fill confidence-${getConfidenceLevel(record.confidence)}" 
                                     style="width: ${record.confidence * 100}%"></div>
                            </div>
                        </div>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        } else {
            showEmptyTable();
        }
    }

    /**
     * Show empty table message
     */
    function showEmptyTable(errorMessage = null) {
        const tableBody = document.querySelector('#demographicsTable tbody');
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-info-circle me-2"></i>
                    ${errorMessage || 'No demographic data available. Use the "Add Sample Data" button in Settings to populate demo data.'}
                </td>
            </tr>
        `;
        updateTableInfo({total_records: 0, page: 1, per_page: recordsPerPage});
        updatePagination({total_pages: 0, page: 1, has_prev: false, has_next: false});
    }

    /**
     * Show/hide table loading overlay
     */
    function showTableLoading(show) {
        const loadingOverlay = document.getElementById('table-loading');
        loadingOverlay.style.display = show ? 'block' : 'none';
    }

    /**
     * Update pagination controls
     */
    function updatePagination(pagination) {
        const paginationContainer = document.getElementById('table-pagination');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        
        totalPages = pagination.total_pages;
        currentPage = pagination.page;

        // Update prev/next buttons
        prevBtn.parentElement.classList.toggle('disabled', !pagination.has_prev);
        nextBtn.parentElement.classList.toggle('disabled', !pagination.has_next);

        // Clear existing page numbers
        const pageItems = paginationContainer.querySelectorAll('.page-item:not(:first-child):not(:last-child)');
        pageItems.forEach(item => item.remove());

        // Add new page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            
            li.addEventListener('click', function(e) {
                e.preventDefault();
                if (i !== currentPage) {
                    currentPage = i;
                    loadTableData();
                }
            });
            
            paginationContainer.insertBefore(li, nextBtn.parentElement);
        }

        // Update prev/next click handlers
        prevBtn.onclick = function(e) {
            e.preventDefault();
            if (pagination.has_prev) {
                currentPage--;
                loadTableData();
            }
        };

        nextBtn.onclick = function(e) {
            e.preventDefault();
            if (pagination.has_next) {
                currentPage++;
                loadTableData();
            }
        };
    }

    /**
     * Update table info text
     */
    function updateTableInfo(pagination) {
        const infoText = document.getElementById('table-info-text');
        const start = ((pagination.page - 1) * pagination.per_page) + 1;
        const end = Math.min(start + pagination.per_page - 1, pagination.total_records);
        
        if (pagination.total_records > 0) {
            infoText.textContent = `Showing ${start}-${end} of ${pagination.total_records} records`;
        } else {
            infoText.textContent = 'Showing 0 of 0 records';
        }
    }

    /**
     * Update sort icons
     */
    function updateSortIcons() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (th.dataset.sort === currentSort) {
                th.classList.add(`sort-${currentSortOrder}`);
            }
        });
    }

    // ====================================
    // Utility Functions
    // ====================================

    function formatDateTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function formatTimeAgo(timestamp) {
        const now = new Date();
        const then = new Date(timestamp);
        const diffMs = now - then;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffDays > 0) return `${diffDays}d ago`;
        if (diffHours > 0) return `${diffHours}h ago`;
        if (diffMins > 0) return `${diffMins}m ago`;
        return 'Just now';
    }

    function formatDwellTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        if (mins > 0) {
            return `${mins}m ${secs}s`;
        }
        return `${secs}s`;
    }

    function getGenderIcon(gender) {
        switch (gender.toLowerCase()) {
            case 'male': return 'mars';
            case 'female': return 'venus';
            default: return 'question';
        }
    }

    function getEmotionIcon(emotion) {
        switch (emotion.toLowerCase()) {
            case 'happy': return 'smile';
            case 'sad': return 'frown';
            case 'angry': return 'angry';
            case 'surprised': return 'surprise';
            case 'neutral': return 'meh';
            default: return 'meh';
        }
    }

    function getConfidenceLevel(confidence) {
        if (confidence >= 0.8) return 'high';
        if (confidence >= 0.6) return 'medium';
        return 'low';
    }

    /**
     * Generate sample demographics data
     */
    function generateSampleDemographicsData() {
        const ageGroups = ['18-24', '25-34', '35-44', '45-54', '55-64', '65+'];
        const genders = ['Male', 'Female', 'Unknown'];
        const emotions = ['Happy', 'Neutral', 'Surprised', 'Sad', 'Angry'];
        const data = [];
        
        for (let i = 0; i < 15; i++) {
            const date = new Date();
            date.setHours(date.getHours() - Math.floor(Math.random() * 24));
            
            data.push({
                datetime: date.toLocaleString(),
                ageGroup: ageGroups[Math.floor(Math.random() * ageGroups.length)],
                gender: genders[Math.floor(Math.random() * genders.length)],
                emotion: emotions[Math.floor(Math.random() * emotions.length)],
                dwellTime: (Math.random() * 30 + 1).toFixed(1)
            });
        }
        
        return data.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
    }

    /**
     * Get appropriate badge class for emotion
     */
    function getEmotionBadgeClass(emotion) {
        const badgeClasses = {
            'Happy': 'success',
            'Neutral': 'secondary',
            'Surprised': 'warning',
            'Sad': 'info',
            'Angry': 'danger'
        };
        return badgeClasses[emotion] || 'secondary';
    }
</script>
</div> <!-- Close page-container -->
{% endblock %} 
